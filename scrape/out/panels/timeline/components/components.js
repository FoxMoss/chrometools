import*as t from"../../../core/host/host.js";import*as e from"../../../core/i18n/i18n.js";import*as i from"../../../ui/components/helpers/helpers.js";import*as s from"../../../ui/components/render_coordinator/render_coordinator.js";import*as n from"../../../ui/lit-html/lit-html.js";class o{context;timeline;theme;constructor(t){this.timeline=t,this.context=t.getContext();const e=getComputedStyle(document.documentElement);this.theme={good:e.getPropertyValue("--lighthouse-green"),medium:e.getPropertyValue("--lighthouse-orange"),bad:e.getPropertyValue("--lighthouse-red"),frame:e.getPropertyValue("--color-primary"),textPrimary:e.getPropertyValue("--color-text-primary"),textSecondary:e.getPropertyValue("--color-text-secondary"),background:e.getPropertyValue("--color-background"),background50:e.getPropertyValue("--color-background-opacity-50"),timeboxColor:e.getPropertyValue("--color-primary-variant")}}tX(t){return this.timeline.tX(t)}tD(t){return this.timeline.tD(t)}renderLaneLabel(e){const i=e.toLocaleUpperCase();this.context.save(),this.context.font="9px "+t.Platform.fontFamily();const s=this.context.measureText(i),n=s.actualBoundingBoxAscent-s.actualBoundingBoxDescent;this.context.fillStyle=this.theme.background50,this.context.fillRect(0,1,s.width+12,n+6),this.context.fillStyle=this.theme.textSecondary,this.context.fillText(i,6,n+4),this.context.restore()}render(){}}class a extends o{#t=[];#e=null;#i=null;#s;#n;#o;#a;constructor(t,e,i,s){super(t),this.context=t.getContext(),this.#n=e,this.#o=i,this.#a=s,this.#s=this.#r(this.#n)}handlePointerMove(t){const e=this.#i;this.#i=null===t?null:this.#t.find((e=>{const i=this.tX(e.timestamp);return i-5<=t&&t<=i+e.widthIncludingLabel}))||null,e!==this.#i&&(this.#i&&this.#a?this.timeline.showOverlay(this.#a(this.#i)):this.timeline.hideOverlay())}handleClick(t){this.#e=this.#i}setEvents(t){this.#i=null,this.#e=null,this.#t=t.map((t=>this.#h(t)))}#r(e){this.context.save(),this.context.font="11px "+t.Platform.fontFamily();const i=this.context.measureText(e);return this.context.restore(),i}#l(e){this.context.save(),this.context.font="11px "+t.Platform.fontFamily();const i=this.context.measureText(e);return this.context.restore(),i}#h(t){const i=this.#o(t),s=this.timeline.getTimeSinceLastMainFrameNavigation(t.timestamp),n=e.TimeUtilities.preciseMillisToString(s,1),o=this.#l(n),a=15+this.#s.width+5,r=a+5+o.width;return{timestamp:t.timestamp,timestampLabel:n,type:i,timestampMetrics:o,widthIncludingLabel:a,widthIncludingTimestamp:r}}#c(e,i,s){this.context.save(),this.context.font="11px "+t.Platform.fontFamily();const n=s.actualBoundingBoxAscent-s.actualBoundingBoxDescent;this.context.fillStyle=this.theme.textPrimary,this.context.fillText(i,this.tX(e)+.5*this.timeline.getLineHeight(),.5*this.timeline.getLineHeight()+.5*n),this.context.restore()}#d(e,i,s,n){this.context.save(),this.context.font="11px "+t.Platform.fontFamily();const o=n.actualBoundingBoxAscent-n.actualBoundingBoxDescent;this.context.fillStyle=this.theme.textSecondary,this.context.fillText(s,this.tX(e)+.5*this.timeline.getLineHeight()+i+5,.5*this.timeline.getLineHeight()+.5*o),this.context.restore()}#m(t){this.context.save(),this.context.beginPath(),this.context.strokeStyle=this.theme.good,this.context.moveTo(this.tX(t),2),this.context.lineTo(this.tX(t),5),this.context.moveTo(this.tX(t),19),this.context.lineTo(this.tX(t),22),this.context.stroke(),this.context.beginPath(),this.context.fillStyle=this.theme.good,this.context.arc(this.tX(t),.5*this.timeline.getLineHeight(),5,0,2*Math.PI),this.context.fill(),this.context.restore()}#x(t){this.context.save(),this.context.beginPath(),this.context.strokeStyle=this.theme.medium,this.context.moveTo(this.tX(t),2),this.context.lineTo(this.tX(t),5),this.context.moveTo(this.tX(t),19),this.context.lineTo(this.tX(t),22),this.context.stroke(),this.context.beginPath(),this.context.fillStyle=this.theme.medium,this.context.rect(this.tX(t)-5,.5*this.timeline.getLineHeight()-5,10,10),this.context.fill(),this.context.restore()}#u(t){this.context.save(),this.context.beginPath(),this.context.strokeStyle=this.theme.bad,this.context.moveTo(this.tX(t),2),this.context.lineTo(this.tX(t),5),this.context.moveTo(this.tX(t),19),this.context.lineTo(this.tX(t),22),this.context.stroke(),this.context.beginPath(),this.context.fillStyle=this.theme.bad,this.context.translate(this.tX(t),.5*this.timeline.getLineHeight()),this.context.rotate(45*Math.PI/180),this.context.rect(-4,-4,8,8),this.context.rotate(-45*Math.PI/180),this.context.translate(-this.tX(t),-.5*this.timeline.getLineHeight()),this.context.fill(),this.context.restore()}#g(t,e,i,s){const n=t.timestampLabel,o=this.#s,a=t.timestampMetrics,r=e,h=i||e,l=t.widthIncludingLabel,c=h?t.widthIncludingTimestamp:l,d=s?this.tD(s.timestamp-t.timestamp):null,m=h||null!==d&&d>l+5;if(h){this.context.save();const e=this.tX(t.timestamp)-5-5,i=1,s=c+10,n=this.timeline.getLineHeight()-2;this.context.fillStyle=this.theme.background,this.context.fillRect(e,i,s,n),r&&(this.context.strokeStyle=this.theme.frame,this.context.lineWidth=2,this.context.strokeRect(e,i,s,n),this.context.lineWidth=1),this.context.restore()}m&&(o&&this.#c(t.timestamp,this.#n,o),h&&this.#d(t.timestamp,o?o.width:0,n,a)),"Good"===t.type?this.#m(t.timestamp):"Medium"===t.type?this.#x(t.timestamp):this.#u(t.timestamp)}render(){for(let t=0;t<this.#t.length;t++){const e=this.#t[t];e!==this.#e&&e!==this.#i&&this.#g(e,!1,!1,t<this.#t.length-1?this.#t[t+1]:null)}this.#i&&this.#i!==this.#e&&this.#g(this.#i,!1,!0,null),this.#e&&this.#g(this.#e,!0,!1,null)}}class r extends o{#v;#p=[];#n;#y=-1;#T=-1;#b;constructor(t,e,i){super(t),this.#n=e;const s=document.createElement("canvas"),n=s.getContext("2d");x(n,CanvasRenderingContext2D);const o=17;s.width=o,s.height=o,n.translate(8.5,8.5),n.rotate(.25*Math.PI),n.translate(-8.5,-8.5),n.fillStyle="#000";for(let t=-17;t<34;t+=3)n.fillRect(t,-17,1,51);const a=this.context.createPattern(s,"repeat");x(a,CanvasPattern),this.#v=a,this.#b=i}handlePointerMove(t){const e=this.#y;this.#y=null===t?-1:this.#p.findIndex((e=>{const i=this.tX(e.start),s=this.tX(e.start+e.duration);return i<=t&&t<=s})),e!==this.#y&&(-1!==this.#y&&this.#b?this.timeline.showOverlay(this.#b(this.#p[this.#y])):this.timeline.hideOverlay())}handleClick(t){this.#T=this.#y}setTimeboxes(t){this.#T=-1,this.#y=-1,this.#p=t}#f(t,e){this.context.save(),this.context.beginPath(),this.context.fillStyle=this.theme.timeboxColor,this.context.moveTo(this.tX(t.start)+2,2),this.context.lineTo(this.tX(t.start+t.duration)-2,2),this.context.quadraticCurveTo(this.tX(t.start+t.duration),2,this.tX(t.start+t.duration),4),this.context.lineTo(this.tX(t.start+t.duration),20),this.context.quadraticCurveTo(this.tX(t.start+t.duration),20,this.tX(t.start+t.duration)-2,22),this.context.lineTo(this.tX(t.start)+2,22),this.context.quadraticCurveTo(this.tX(t.start)+2,22,this.tX(t.start),20),this.context.lineTo(this.tX(t.start),4),this.context.quadraticCurveTo(this.tX(t.start),4,this.tX(t.start)+2,2),this.context.closePath(),this.context.fill(),this.context.beginPath(),this.context.fillStyle=this.#v,this.context.moveTo(this.tX(t.start+m)+2,2),this.context.lineTo(this.tX(t.start+t.duration)-2,2),this.context.quadraticCurveTo(this.tX(t.start+t.duration),2,this.tX(t.start+t.duration),4),this.context.lineTo(this.tX(t.start+t.duration),20),this.context.quadraticCurveTo(this.tX(t.start+t.duration),20,this.tX(t.start+t.duration)-2,22),this.context.lineTo(this.tX(t.start+50),22),this.context.lineTo(this.tX(t.start+50),2),this.context.closePath(),this.context.fill(),e&&(this.context.beginPath(),this.context.strokeStyle=this.theme.frame,this.context.rect(this.tX(t.start)-2,0,this.tD(t.duration)+4,24),this.context.lineWidth=2,this.context.stroke(),this.context.lineWidth=1),this.context.restore()}render(){for(let t=0;t<this.#p.length;t++)t!==this.#y&&t!==this.#T&&this.#f(this.#p[t],!1);-1!==this.#y&&this.#f(this.#p[this.#y],!0),-1!==this.#T&&this.#f(this.#p[this.#T],!0),this.renderLaneLabel(this.#n)}}const h=s.RenderCoordinator.RenderCoordinator.instance(),l={fcp:"FCP",lcp:"LCP",ls:"LS",longTasks:"Long Tasks",longTask:"Long Task",firstContentfulPaint:"First Contentful Paint",largestContentfulPaint:"Largest Contentful Paint",good:"Good",needsImprovement:"Needs improvement",poor:"Poor"},c=e.i18n.registerUIStrings("panels/timeline/components/WebVitalsTimeline.ts",l),d=e.i18n.getLocalizedString.bind(void 0,c),m=50;function x(t,e){if(!(t instanceof e))throw new TypeError(`Instance expected to be of type ${e.name} but got ${t.constructor.name}`)}class u extends HTMLElement{static litTagName=n.literal`devtools-timeline-webvitals`;#k=this.attachShadow({mode:"open"});#M=[];#L=0;#P=1e3;#S=1e3;#C=0;#X=0;#w;#B=null;#F;#O;#$;#N;#E;#I=null;#R;constructor(){super(),this.#w=document.createElement("canvas"),this.#w.style.width="100%",this.#w.style.height=`${Math.max(120,120)}px`,this.#k.appendChild(this.#w),this.#w.addEventListener("pointermove",this.#D.bind(this)),this.#w.addEventListener("pointerout",this.#H.bind(this)),this.#w.addEventListener("click",this.#V.bind(this));const t=this.#w.getContext("2d");x(t,CanvasRenderingContext2D),this.#E=t,this.#F=new a(this,d(l.fcp),(t=>this.#U(t)),this.#W),this.#O=new a(this,d(l.lcp),(t=>this.#_(t)),this.#G),this.#$=new a(this,d(l.ls),(t=>"Bad")),this.#N=new r(this,d(l.longTasks),this.#q),this.#R=document.createElement("devtools-timeline-webvitals-tooltip"),this.#R.style.position="absolute",this.#R.style.visibility="hidden",this.ownerDocument.body.appendChild(this.#R)}set data(t){this.#L=t.startTime||this.#L,this.#P=t.duration||this.#P,this.#S=t.maxDuration||this.#S,this.#M=t.mainFrameNavigations||this.#M,t.fcps&&this.#F.setEvents(t.fcps),t.lcps&&this.#O.setEvents(t.lcps),t.layoutShifts&&this.#$.setEvents(t.layoutShifts),t.longTasks&&this.#N.setTimeboxes(t.longTasks),this.#j()}getContext(){return this.#E}getLineHeight(){return 24}hideOverlay(){this.#R.style.visibility="hidden"}showOverlay(t){this.#R.data={content:t},this.#R.style.visibility="visible"}#D(t){this.#A(t.clientX,t.clientY);const e=t.offsetX,i=t.offsetY,s=Math.floor(i/24);this.#B=s,this.#F.handlePointerMove(1===this.#B?e:null),this.#O.handlePointerMove(2===this.#B?e:null),this.#$.handlePointerMove(3===this.#B?e:null),this.#N.handlePointerMove(4===this.#B?e:null),this.#j()}#A(t,e){h.read((()=>{const i=this.getBoundingClientRect(),s=this.#R.getBoundingClientRect(),n=t+10+s.width>i.x+i.width?t-s.width-10:t+10;h.write((()=>{this.#R.style.top=`${e+10}px`,this.#R.style.left=`${n}px`}))}))}#H(t){this.#F.handlePointerMove(null),this.#O.handlePointerMove(null),this.#$.handlePointerMove(null),this.#N.handlePointerMove(null),this.#j()}#V(t){const e=t.offsetX;this.focus(),this.#F.handleClick(1===this.#B?e:null),this.#O.handleClick(2===this.#B?e:null),this.#$.handleClick(3===this.#B?e:null),this.#N.handleClick(4===this.#B?e:null),this.#j()}tX(t){return(t-this.#L)/this.#P*this.#C}tD(t){return t/this.#P*this.#C}setSize(t,e){const i=window.devicePixelRatio;this.#C=t,this.#X=Math.max(e,120),this.#w.width=Math.floor(this.#C*i),this.#w.height=Math.floor(this.#X*i),this.#E.scale(i,i),this.style.width=this.#C+"px",this.style.height=this.#X+"px",this.render()}connectedCallback(){this.style.display="block",this.tabIndex=0;const t=this.#w.getBoundingClientRect(),e=t.width,i=t.height;this.setSize(e,i),this.render()}disconnectedCallback(){this.#R.remove()}#U(t){const e=this.getTimeSinceLastMainFrameNavigation(t.timestamp);return e<=2e3?"Good":e<=4e3?"Medium":"Bad"}#_(t){const e=this.getTimeSinceLastMainFrameNavigation(t.timestamp);return e<=2500?"Good":e<=4e3?"Medium":"Bad"}#W(){return n.html` <table class="table"> <thead> <td colspan="3" class="title">${d(l.firstContentfulPaint)}</td> </thead> <tbody> <tr> <td><span class="good"></span></td> <td>${d(l.good)}</td> <td> ≤ ${e.TimeUtilities.millisToString(2e3)}</td> </tr> <tr> <td><span class="medium"></span></td> <td>${d(l.needsImprovement)}</td> <td></td> </tr> <tr> <td><span class="bad"></span></td> <td>${d(l.poor)}</td> <td>> ${e.TimeUtilities.millisToString(4e3)}</td> </tr> </tbody> </table> `}#G(){return n.html` <table class="table"> <thead> <td colspan="3" class="title">${d(l.largestContentfulPaint)}</td> </thead> <tbody> <tr> <td><span class="good"></span></td> <td>${d(l.good)}</td> <td> ≤ ${e.TimeUtilities.millisToString(2500)}</td> </tr> <tr> <td><span class="medium"></span></td> <td>${d(l.needsImprovement)}</td> <td></td> </tr> <tr> <td><span class="bad"></span></td> <td>${d(l.poor)}</td> <td>> ${e.TimeUtilities.millisToString(4e3)}</td> </tr> </tbody> </table> `}#q(t){return n.html` <table class="table"> <thead> <td colspan="3" class="title"> ${d(l.longTask)} <span class="small"> ${e.TimeUtilities.millisToString(t.duration)} </span> </td> </thead> <tbody> <tr> <td><span class="good"></span></td> <td>${d(l.good)}</td> <td>≤ ${e.TimeUtilities.millisToString(m)}</td> </tr> <tr> <td><span class="bad"></span></td> <td>${d(l.poor)}</td> <td>> ${e.TimeUtilities.millisToString(m)}</td> </tr> </tbody> </table> `}#z(t){this.#E.save(),this.#E.strokeStyle="blue",this.#E.beginPath();for(const e of t)this.#E.moveTo(this.tX(e),0),this.#E.lineTo(this.tX(e),this.#X);this.#E.stroke(),this.#E.restore()}getTimeSinceLastMainFrameNavigation(t){let e=0,i=0;for(;e<this.#M.length&&this.#M[e]<=t;)i=this.#M[e],e++;return t-i}render(){this.#E.save(),this.#E.clearRect(0,0,this.#C,this.#X),this.#E.strokeStyle="#dadce0",this.#E.beginPath();for(let t=0;t<5;t++)this.#E.moveTo(0,24*t+.5),this.#E.lineTo(this.#C,24*t+.5);this.#E.moveTo(0,119.5),this.#E.lineTo(this.#C,119.5),this.#E.stroke(),this.#E.restore(),this.#E.save(),this.#E.font="11px "+t.Platform.fontFamily();const e=this.#E.measureText("Web Vitals"),i=e.actualBoundingBoxAscent-e.actualBoundingBoxDescent;this.#E.fillStyle="#202124",this.#E.fillText("Web Vitals",6,4+i),this.#E.restore(),this.#E.save(),this.#E.translate(0,Number(24)),this.#F.render(),this.#E.translate(0,Number(24)),this.#O.render(),this.#E.translate(0,Number(24)),this.#$.render(),this.#E.translate(0,Number(24)),this.#N.render(),this.#E.restore(),this.#z(this.#M)}#j(){this.#I||(this.#I=window.requestAnimationFrame((()=>{this.#I=null,this.render()})))}}i.CustomElements.defineComponent("devtools-timeline-webvitals",u);var g=Object.freeze({__proto__:null,LINE_HEIGHT:24,LONG_TASK_THRESHOLD:m,assertInstanceOf:x,WebVitalsTimeline:u});export{g as WebVitalsTimeline};
