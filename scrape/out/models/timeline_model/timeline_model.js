import*as e from"../../core/common/common.js";import*as t from"../../core/i18n/i18n.js";import*as r from"../../core/platform/platform.js";import*as a from"../../core/root/root.js";import*as n from"../../core/sdk/sdk.js";const i={threadS:"Thread {PH1}"},s=t.i18n.registerUIStrings("models/timeline_model/TimelineJSProfile.ts",i),o=t.i18n.getLocalizedString.bind(void 0,s);class l{static generateTracingEventsFromCpuProfile(e,t){const r=e.samples||[],i=e.timestamps,s=[];if(a.Runtime.experiments.isEnabled("timelineDoNotSkipSystemNodesOfCpuProfile")){let a=e.root,o=[];for(let l=0;l<r.length;++l){const d=e.nodeByIndex(l);if(!d){console.error(`Node with unknown id ${r[l]} at index ${l}`);continue}let c;if(d===e.gcNode)c=a===e.gcNode?o:[d,...o];else{c=new Array(d.depth+1);let e=d;for(let t=0;e.parent;e=e.parent)c[t++]=e}const h=new n.TracingModel.Event(n.TracingModel.DevToolsTimelineEventCategory,p.JSSample,n.TracingModel.Phase.Instant,i[l],t);h.args.data={stackTrace:c},s.push(h),a=d,o=c}}else{const a=e.idleNode,o=e.programNode||null,l=e.gcNode,d=new Map;d.set(o,[]);for(let o=0;o<r.length;++o){let c=e.nodeByIndex(o);if(!c){console.error(`Node with unknown id ${r[o]} at index ${o}`);continue}if(c===l||c===a)continue;let h=d.get(c);if(!h){h=new Array(c.depth+1),d.set(c,h);for(let e=0;c.parent;c=c.parent)h[e++]=c}const m=new n.TracingModel.Event(n.TracingModel.DevToolsTimelineEventCategory,p.JSSample,n.TracingModel.Phase.Instant,i[o],t);m.args.data={stackTrace:h},s.push(m)}}return s}static generateJSFrameEvents(e,t){const r=[],a=[],i=[];let s=0,o=!1;const{showAllEvents:d,showRuntimeCallStats:c,showNativeFunctions:h}=t;function m(e,t){if(i.length){const r=i[i.length-1];e<r&&(console.error(`Child stack is shallower (${e}) than the parent stack (${r}) at ${t}`),e=r)}a.length<e&&(console.error(`Trying to truncate higher than the current stack size at ${t}`),e=a.length);for(let e=0;e<a.length;++e)a[e].setEndTime(t);a.length=e}function g(e){const t=e.name===p.JSSample?e.args.data.stackTrace.slice().reverse():a.map((e=>e.args.data));!function(e){if(d)return;let t=null,r=0;for(let n=0;n<e.length;++n){const i=e[n],s=i.url,o=s&&s.startsWith("native ");if(!h&&o)continue;const d=l.isNativeRuntimeFrame(i);if(d&&(a=i.functionName,!c||!Boolean(l.nativeGroup(a))))continue;const m=d?l.nativeGroup(i.functionName):null;t&&t===m||(t=m,e[r++]=i)}var a;e.length=r}(t);const s=e.endTime||e.startTime,o=Math.min(t.length,a.length);let u;for(u=i[i.length-1]||0;u<o;++u){const e=t[u],r=a[u].args.data;if(T=r,(g=e).scriptId!==T.scriptId||g.functionName!==T.functionName||g.lineNumber!==T.lineNumber)break;a[u].setEndTime(Math.max(a[u].endTime,s))}var g,T;for(m(u,e.startTime);u<t.length;++u){const i=t[u],o=new n.TracingModel.Event(n.TracingModel.DevToolsTimelineEventCategory,p.JSFrame,n.TracingModel.Phase.Complete,e.startTime,e.thread);o.ordinal=e.ordinal,o.addArgs({data:i}),o.setEndTime(s),a.push(o),r.push(o)}}const T=e.find(n.TracingModel.TracingModel.isTopLevelEvent),f=T?T.startTime:0;return u.forEachEvent(e,(function(e){o&&(m(i.pop(),e.startTime),o=!1),e.ordinal=++s,g(e),i.push(a.length)}),(function(e){m(i.pop(),e.endTime)}),(function(e,t){if(e.ordinal=++s,t&&function(e){switch(e.name){case p.RunMicrotasks:case p.FunctionCall:case p.EvaluateScript:case p.EvaluateModule:case p.EventDispatch:case p.V8Execute:return!0}return!(!e.name.startsWith("v8")&&!e.name.startsWith("V8"))}(t)||o)g(e);else if(e.name===p.JSSample&&e.args?.data?.stackTrace?.length&&0===a.length){o=!0;const t=a.length;g(e),i.push(t)}}),f),r}static isNativeRuntimeFrame(e){return"native V8Runtime"===e.url}static nativeGroup(e){return e.startsWith("Parse")?l.NativeGroups.Parse:e.startsWith("Compile")||e.startsWith("Recompile")?l.NativeGroups.Compile:null}static buildTraceProfileFromCpuProfile(e,t,r,s){const l=[];if(r&&d("TracingStartedInPage",{data:{sessionId:"1"}},0,0,"M"),s||(s=o(i.threadS,{PH1:t})),d(n.TracingModel.MetadataEvent.ThreadName,{name:s},0,0,"M","__metadata"),!e)return l;if(a.Runtime.experiments.isEnabled("timelineDoNotSkipSystemNodesOfCpuProfile"))d("(root)",{},e.startTime,e.endTime-e.startTime,"X","toplevel");else{const t=new Map,r=e.nodes;for(let e=0;e<r.length;++e)t.set(r[e].id,r[e]);let a=null,n=null,i=e.startTime,s=0;const o=e.samples,l=e.timeDeltas;for(let e=0;e<o.length;++e){s=i,i+=l[e];const r=t.get(o[e]).callFrame.functionName;"(idle)"!==r?(a||(a=d("MessageLoop::RunTask",{},s,0,"X","toplevel")),"(program)"===r?n&&(n.dur=s-n.ts,n=null):n||(n=d("FunctionCall",{data:{sessionId:"1"}},s))):c()}function c(){a&&(a.dur=s-a.ts),n&&(n.dur=s-n.ts),a=null,n=null}c()}return d("CpuProfile",{data:{cpuProfile:e}},e.endTime,0,"I"),l;function d(e,r,a,n,i,s){const o={cat:s||"disabled-by-default-devtools.timeline",name:e,ph:i||"X",pid:1,tid:t,ts:a,args:r};return n&&(o.dur=n),l.push(o),o}}}!function(e){let t;!function(e){e.Compile="Compile",e.Parse="Parse"}(t=e.NativeGroups||(e.NativeGroups={}))}(l||(l={}));var d=Object.freeze({__proto__:null,get TimelineJSProfileProcessor(){return l}});const c={threadS:"Thread {PH1}",userInteractions:"User Interactions",workerS:"`Worker` — {PH1}",dedicatedWorker:"Dedicated `Worker`",workerSS:"`Worker`: {PH1} — {PH2}",bidderWorkletS:"Bidder Worklet — {PH1}",sellerWorkletS:"Seller Worklet — {PH1}",unknownWorkletS:"Auction Worklet — {PH1}",bidderWorklet:"Bidder Worklet",sellerWorklet:"Seller Worklet",unknownWorklet:"Auction Worklet",workletService:"Auction Worklet Service",workletServiceS:"Auction Worklet Service — {PH1}"},h=t.i18n.registerUIStrings("models/timeline_model/TimelineModel.ts",c),m=t.i18n.getLocalizedString.bind(void 0,h);class u{isGenericTraceInternal;tracksInternal;namedTracks;inspectedTargetEventsInternal;timeMarkerEventsInternal;sessionId;mainFrameNodeId;pageFrames;auctionWorklets;cpuProfilesInternal;workerIdByThread;requestsFromBrowser;mainFrame;minimumRecordTimeInternal;maximumRecordTimeInternal;totalBlockingTimeInternal;estimatedTotalBlockingTime;asyncEventTracker;invalidationTracker;layoutInvalidate;lastScheduleStyleRecalculation;paintImageEventByPixelRefId;lastPaintForLayer;lastRecalculateStylesEvent;currentScriptEvent;eventStack;browserFrameTracking;persistentIds;legacyCurrentPage;currentTaskLayoutAndRecalcEvents;tracingModelInternal;mainFrameLayerTreeId;constructor(){this.minimumRecordTimeInternal=0,this.maximumRecordTimeInternal=0,this.totalBlockingTimeInternal=0,this.estimatedTotalBlockingTime=0,this.reset(),this.resetProcessingState(),this.currentTaskLayoutAndRecalcEvents=[],this.tracingModelInternal=null}static forEachEvent(e,t,r,a,i,s,o){i=i||0,s=s||1/0;const l=[];for(let d=u.topLevelEventEndingAfter(e,i);d<e.length;++d){const c=e[d];if((c.endTime||c.startTime)<i)continue;if(c.startTime>=s)break;if(n.TracingModel.TracingModel.isAsyncPhase(c.phase)||n.TracingModel.TracingModel.isFlowPhase(c.phase))continue;let h=l[l.length-1];for(;h&&void 0!==h.endTime&&h.endTime<=c.startTime;)l.pop(),r(h),h=l[l.length-1];o&&!o(c)||(c.duration?(t(c),l.push(c)):a&&a(c,l[l.length-1]||null))}for(;l.length;){const e=l.pop();e&&r(e)}}static topLevelEventEndingAfter(e,t){let a=r.ArrayUtilities.upperBound(e,t,((e,t)=>e-t.startTime))-1;for(;a>0&&!n.TracingModel.TracingModel.isTopLevelEvent(e[a]);)a--;return Math.max(a,0)}isMarkerEvent(e){switch(e.name){case p.TimeStamp:return!0;case p.MarkFirstPaint:case p.MarkFCP:return Boolean(this.mainFrame)&&e.args.frame===this.mainFrame.frameId&&Boolean(e.args.data);case p.MarkDOMContent:case p.MarkLoad:case p.MarkLCPCandidate:case p.MarkLCPInvalidate:return Boolean(e.args.data.isOutermostMainFrame??e.args.data.isMainFrame);default:return!1}}isInteractiveTimeEvent(e){return e.name===p.InteractiveTime}isLayoutShiftEvent(e){return e.name===p.LayoutShift}isUserTimingEvent(e){return e.categoriesString===u.Category.UserTiming}isEventTimingInteractionEvent(e){if(e.name!==p.EventTiming)return!1;const t=e.args.data,r=t.duration||0,a=t.interactionId||0;return r>0&&a>0}isParseHTMLEvent(e){return e.name===p.ParseHTML}isLCPCandidateEvent(e){return e.name===p.MarkLCPCandidate&&Boolean(e.args.data.isOutermostMainFrame??e.args.data.isMainFrame)}isLCPInvalidateEvent(e){return e.name===p.MarkLCPInvalidate&&Boolean(e.args.data.isOutermostMainFrame??e.args.data.isMainFrame)}isFCPEvent(e){return e.name===p.MarkFCP&&Boolean(this.mainFrame)&&e.args.frame===this.mainFrame.frameId}isLongRunningTask(e){return e.name===p.Task&&S.forEvent(e).warning===u.WarningType.LongTask}isNavigationStartEvent(e){return e.name===p.NavigationStart}isMainFrameNavigationStartEvent(e){return this.isNavigationStartEvent(e)&&(e.args.data.isOutermostMainFrame??e.args.data.isLoadingMainFrame)&&e.args.data.documentLoaderURL}static globalEventId(e,t){const r=e.args.data||e.args.beginData,a=r&&r[t];return a?`${e.thread.process().id()}.${a}`:""}static eventFrameId(e){const t=e.args.data||e.args.beginData;return t&&t.frame||null}cpuProfiles(){return this.cpuProfilesInternal}totalBlockingTime(){return-1===this.totalBlockingTimeInternal?{time:this.estimatedTotalBlockingTime,estimated:!0}:{time:this.totalBlockingTimeInternal,estimated:!1}}targetByEvent(e){const t=this.workerIdByThread.get(e.thread),r=n.TargetManager.TargetManager.instance().mainFrameTarget();return t?n.TargetManager.TargetManager.instance().targetById(t):r}navStartTimes(){return this.tracingModelInternal?this.tracingModelInternal.navStartTimes():new Map}setEvents(e){this.reset(),this.resetProcessingState(),this.tracingModelInternal=e,this.minimumRecordTimeInternal=e.minimumRecordTime(),this.maximumRecordTimeInternal=e.maximumRecordTime();const t=[];for(const r of e.sortedProcesses())if("Renderer"===r.name())for(const e of r.sortedThreads()){const r=e.removeEventsByName(p.LayoutShift);t.push(...r)}if(this.processSyncBrowserEvents(e),this.browserFrameTracking)this.processThreadsForBrowserFrames(e);else{const t=this.processMetadataEvents(e);this.isGenericTraceInternal=!t,t?this.processMetadataAndThreads(e,t):this.processGenericTrace(e)}this.inspectedTargetEventsInternal.sort(n.TracingModel.Event.compareStartTime),this.processAsyncBrowserEvents(e),this.buildGPUEvents(e),this.buildLoadingEvents(e,t),this.collectInteractionEvents(e),this.resetProcessingState()}collectInteractionEvents(e){const t=[];for(const r of e.sortedProcesses()){if("Renderer"!==r.name())continue;const e=r.threadByName("CrRendererMain");if(e)for(const r of e.asyncEvents())this.isEventTimingInteractionEvent(r)&&t.push(r)}if(0===t.length)return;const r=this.ensureNamedTrack(g.UserInteractions);r.name=c.userInteractions,r.forMainFrame=!0,r.asyncEvents=t}processGenericTrace(e){let t=n.TracingModel.TracingModel.browserMainThread(e);!t&&e.sortedProcesses().length&&(t=e.sortedProcesses()[0].sortedThreads()[0]);for(const r of e.sortedProcesses())for(const a of r.sortedThreads())this.processThreadEvents(e,[{from:0,to:1/0}],a,a===t,!1,!0,0,null)}processMetadataAndThreads(e,t){let a=0;for(let n=0,i=t.page.length;n<i;n++){const s=t.page[n],o=s.thread.process(),l=n+1<i?t.page[n+1].startTime:1/0;if(a!==l){this.legacyCurrentPage=s.args.data&&s.args.data.page;for(const n of o.sortedThreads()){let i=null;if(n.name()===u.WorkerThreadName||n.name()===u.WorkerThreadNameLegacy){const e=t.workers.find((e=>{if(e.args.data.workerThreadId!==n.id())return!1;if(e.args.data.sessionId===this.sessionId)return!0;const t=u.eventFrameId(e);return!!t&&Boolean(this.pageFrames.get(t))}));if(!e)continue;const a=e.args.data.workerId;a&&this.workerIdByThread.set(n,a),i=e.args.data.url||r.DevToolsPath.EmptyUrlString}this.processThreadEvents(e,[{from:a,to:l}],n,n===s.thread,Boolean(i),!0,0,i)}a=l}}}processThreadsForBrowserFrames(e){const t=new Map;for(const e of this.pageFrames.values())for(let r=0;r<e.processes.length;r++){const a=e.processes[r].processId;let n=t.get(a);n||(n=[],t.set(a,n));const i=r===e.processes.length-1?e.deletedTime||1/0:e.processes[r+1].time;n.push({from:e.processes[r].time,to:i,main:!e.parent,url:e.processes[r].url,workletType:0})}for(const e of this.auctionWorklets.values()){const a=e.processId;let n=t.get(a);n||(n=[],t.set(a,n)),n.push({from:e.startTime,to:e.endTime,main:!1,workletType:e.workletType,url:e.host?"https://"+e.host:r.DevToolsPath.EmptyUrlString})}const a=e.devToolsMetadataEvents();for(const n of e.sortedProcesses()){const i=t.get(n.id());if(!i)continue;i.sort(((e,t)=>e.from-t.from||e.to-t.to));const s=[];let o=null,l=null,d=!1,c=!0,h=!1,m=0;for(const e of i){const t=s[s.length-1];!t||e.from>t.to?s.push({from:e.from,to:e.to}):t.to=e.to,e.main&&(d=!0),0===e.workletType?c=!1:(!1===h?h=e.url:h!==e.url&&(h=!0),0===m?m=e.workletType:m!==e.workletType&&(m=3)),e.url&&(e.main&&(l=e.url),o=e.url)}for(const t of n.sortedThreads())if(t.name()===u.RendererMainThreadName)this.processThreadEvents(e,s,t,!0,!1,d,0,d?l:o);else if(t.name()===u.WorkerThreadName||t.name()===u.WorkerThreadNameLegacy){const i=a.find((e=>{if(e.name!==u.DevToolsMetadataEvent.TracingSessionIdForWorker)return!1;if(e.thread.process()!==n)return!1;if(e.args.data.workerThreadId!==t.id())return!1;const r=u.eventFrameId(e);return!!r&&Boolean(this.pageFrames.get(r))}));if(!i)continue;this.workerIdByThread.set(t,i.args.data.workerId||""),this.processThreadEvents(e,s,t,!1,!0,!1,0,i.args.data.url||r.DevToolsPath.EmptyUrlString)}else{let r=null,a=0;if(t.name()===u.AuctionWorkletThreadName||t.name()===u.UtilityMainThreadName)"boolean"!=typeof h&&(r=h),a=m;else if(c)continue;this.processThreadEvents(e,s,t,!1,!1,!1,a,r)}}}processMetadataEvents(t){const r=t.devToolsMetadataEvents(),a=[],i=[];for(const e of r)if(e.name===u.DevToolsMetadataEvent.TracingStartedInPage){a.push(e),e.args.data&&e.args.data.persistentIds&&(this.persistentIds=!0);(e.args.data&&e.args.data.frames||[]).forEach((t=>this.addPageFrame(e,t))),this.mainFrame=this.rootFrames()[0]}else e.name===u.DevToolsMetadataEvent.TracingSessionIdForWorker?i.push(e):e.name===u.DevToolsMetadataEvent.TracingStartedInBrowser&&(console.assert(!this.mainFrameNodeId,"Multiple sessions in trace"),this.mainFrameNodeId=e.args.frameTreeNodeId);if(!a.length)return null;const s=a[0].args.sessionId||a[0].args.data.sessionId;this.sessionId=s;const o=new Set;const l={page:a.filter((function(e){let t=e.args;t.data&&(t=t.data);const r=t.sessionId;return r===s||(o.add(r),!1)})).sort(n.TracingModel.Event.compareStartTime),workers:i.sort(n.TracingModel.Event.compareStartTime)};return o.size&&e.Console.Console.instance().error("Timeline recording was started in more than one page simultaneously. Session id mismatch: "+this.sessionId+" and "+[...o]+"."),l}processSyncBrowserEvents(e){const t=n.TracingModel.TracingModel.browserMainThread(e);t&&t.events().forEach(this.processBrowserEvent,this)}processAsyncBrowserEvents(e){const t=n.TracingModel.TracingModel.browserMainThread(e);t&&this.processAsyncEvents(t,[{from:0,to:1/0}])}buildGPUEvents(e){const t=e.getThreadByName("Gpu","CrGpuMain")||e.getThreadByName("GPU Process","CrGpuMain");if(!t)return;const r=p.GPUTask,n=this.ensureNamedTrack(g.GPU);n.thread=t,n.events=a.Runtime.experiments.isEnabled("timelineShowAllEvents")?t.events():t.events().filter((e=>e.name===r))}buildLoadingEvents(e,t){const r=e.getThreadByName("Renderer","CrRendererMain");if(!r)return;const a=this.ensureNamedTrack(g.Experience);a.thread=r,a.events=t;for(const e of a.events)if(e.categoriesString="experience",e.name===p.LayoutShift){const t=e.args.data||e.args.beginData||{},r=S.forEvent(e);if(t.impacted_nodes)for(let e=0;e<t.impacted_nodes.length;++e)r.backendNodeIds.push(t.impacted_nodes[e].node_id)}}resetProcessingState(){this.asyncEventTracker=new F,this.invalidationTracker=new k,this.layoutInvalidate={},this.lastScheduleStyleRecalculation={},this.paintImageEventByPixelRefId={},this.lastPaintForLayer={},this.lastRecalculateStylesEvent=null,this.currentScriptEvent=null,this.eventStack=[],this.browserFrameTracking=!1,this.persistentIds=!1,this.legacyCurrentPage=null}extractCpuProfile(t,r){const a=r.events();let i,s=null,o=a[a.length-1];if(o&&o.name===p.CpuProfile){const e=o.args.data;i=e&&e.cpuProfile,s=this.targetByEvent(o)}if(!i){if(o=a.find((e=>e.name===p.Profile)),!o)return null;s=this.targetByEvent(o);const r=t.profileGroup(o);if(!r)return e.Console.Console.instance().error("Invalid CPU profile format."),null;i={startTime:1e3*o.startTime,endTime:0,nodes:[],samples:[],timeDeltas:[],lines:[]};for(const t of r.children){const r=t.args.data;"startTime"in r&&(i.startTime=1e3*t.startTime),"endTime"in r&&(i.endTime=1e3*t.startTime);const a=r.cpuProfile||{},n=a.samples||[],s=r.lines||Array(n.length).fill(0);if(i.nodes.push(...a.nodes||[]),i.lines.push(...s),i.samples&&i.samples.push(...n),i.timeDeltas&&i.timeDeltas.push(...r.timeDeltas||[]),i.samples&&i.timeDeltas&&i.samples.length!==i.timeDeltas.length)return e.Console.Console.instance().error("Failed to parse CPU profile."),null}if(!i.endTime&&i.timeDeltas){const e=i.timeDeltas;i.endTime=e.reduce(((e,t)=>e+t),i.startTime)}}try{const e=i,t=new n.CPUProfileDataModel.CPUProfileDataModel(e,s);return this.cpuProfilesInternal.push(t),t}catch(t){e.Console.Console.instance().error("Failed to parse CPU profile.")}return null}injectJSFrameEvents(t,i){const s=this.extractCpuProfile(t,i);let o=i.events();const d=s?l.generateTracingEventsFromCpuProfile(s,i):null;if(d&&d.length&&(o=r.ArrayUtilities.mergeOrdered(o,d,n.TracingModel.Event.orderedCompareStartTime)),d||o.some((e=>e.name===p.JSSample))){const t=l.generateJSFrameEvents(o,{showAllEvents:a.Runtime.experiments.isEnabled("timelineShowAllEvents"),showRuntimeCallStats:a.Runtime.experiments.isEnabled("timelineV8RuntimeCallStats"),showNativeFunctions:e.Settings.Settings.instance().moduleSetting("showNativeFunctionsInJSProfile").get()});t&&t.length&&(o=r.ArrayUtilities.mergeOrdered(t,o,n.TracingModel.Event.orderedCompareStartTime))}return o}static nameAuctionWorklet(e,t){switch(e){case 1:return t?m(c.bidderWorkletS,{PH1:t}):m(c.bidderWorklet);case 2:return t?m(c.sellerWorkletS,{PH1:t}):m(c.sellerWorklet);default:return t?m(c.unknownWorkletS,{PH1:t}):m(c.unknownWorklet)}}processThreadEvents(e,t,a,i,s,o,l,d){const h=new T;h.name=a.name()||m(c.threadS,{PH1:a.id()}),h.type=g.Other,h.thread=a,i?(h.type=g.MainThread,h.url=d||r.DevToolsPath.EmptyUrlString,h.forMainFrame=o):s?(h.type=g.Worker,h.url=d||r.DevToolsPath.EmptyUrlString,h.name=h.url?m(c.workerS,{PH1:h.url}):m(c.dedicatedWorker)):a.name().startsWith("CompositorTileWorker")?h.type=g.Raster:a.name()===u.AuctionWorkletThreadName?(h.url=d||r.DevToolsPath.EmptyUrlString,h.name=u.nameAuctionWorklet(l,d)):0!==l&&a.name()===u.UtilityMainThreadName&&(h.url=d||r.DevToolsPath.EmptyUrlString,h.name=d?m(c.workletServiceS,{PH1:d}):m(c.workletService)),this.tracksInternal.push(h);const f=this.injectJSFrameEvents(e,a);this.eventStack=[];const v=this.eventStack;if(s){const e=f.find((e=>e.name===p.Profile));if(e){const t=this.targetByEvent(e);t&&(h.name=m(c.workerSS,{PH1:t.name(),PH2:h.url}))}}for(const e of t){let t=r.ArrayUtilities.lowerBound(f,e.from,((e,t)=>e-t.startTime));for(;t<f.length;t++){const r=f[t];if(r.startTime>=e.to)break;this.isInteractiveTimeEvent(r)&&-1===this.totalBlockingTimeInternal&&(this.totalBlockingTimeInternal=r.args.args.total_blocking_time_ms);const a=r.name===p.Task&&r.duration&&r.duration>50;i&&a&&r.duration&&(this.estimatedTotalBlockingTime+=r.duration-50);let s=v[v.length-1];for(;s&&void 0!==s.endTime&&s.endTime<=r.startTime;)v.pop(),s=v[v.length-1];if(this.processEvent(r)){if(!n.TracingModel.TracingModel.isAsyncPhase(r.phase)&&r.duration){if(v.length){const e=v[v.length-1];e&&(e.selfTime-=r.duration,e.selfTime<0&&this.fixNegativeDuration(e,r))}r.selfTime=r.duration,v.length||h.tasks.push(r),v.push(r)}this.isMarkerEvent(r)&&this.timeMarkerEventsInternal.push(r),h.events.push(r),this.inspectedTargetEventsInternal.push(r)}}}this.processAsyncEvents(a,t)}fixNegativeDuration(e,t){e.selfTime<-.001&&console.error(`Children are longer than parent at ${e.startTime} (${(t.startTime-this.minimumRecordTime()).toFixed(3)} by ${(-e.selfTime).toFixed(3)}`),e.selfTime=0}processAsyncEvents(e,t){const a=e.asyncEvents(),i=new Map;function s(e){return i.has(e)||i.set(e,[]),i.get(e)}for(const e of t){let t=r.ArrayUtilities.lowerBound(a,e.from,(function(e,t){return e-t.startTime}));for(;t<a.length;++t){const r=a[t];if(r.startTime>=e.to)break;r.hasCategory(u.Category.Console)?s(g.Console).push(r):r.hasCategory(u.Category.UserTiming)?s(g.Timings).push(r):r.name!==p.Animation||s(g.Animation).push(r)}}for(const[t,a]of i){const i=this.ensureNamedTrack(t);i.thread=e,i.asyncEvents=r.ArrayUtilities.mergeOrdered(i.asyncEvents,a,n.TracingModel.Event.compareStartTime)}}processEvent(e){const t=this.eventStack;if(!t.length){if(this.currentTaskLayoutAndRecalcEvents&&this.currentTaskLayoutAndRecalcEvents.length){const e=this.currentTaskLayoutAndRecalcEvents.reduce(((e,t)=>void 0===t.duration?e:e+t.duration),0);if(e>u.Thresholds.ForcedLayout)for(const e of this.currentTaskLayoutAndRecalcEvents){S.forEvent(e).warning=e.name===p.Layout?u.WarningType.ForcedLayout:u.WarningType.ForcedStyle}}this.currentTaskLayoutAndRecalcEvents=[]}this.currentScriptEvent&&void 0!==this.currentScriptEvent.endTime&&e.startTime>this.currentScriptEvent.endTime&&(this.currentScriptEvent=null);const r=e.args.data||e.args.beginData||{},a=S.forEvent(e);r.stackTrace&&(a.stackTrace=r.stackTrace.map((t=>{if(e.name!==p.JSSample){const e={...t};return--e.lineNumber,--e.columnNumber,e}return t})));let n=u.eventFrameId(e);const i=t[t.length-1];switch(!n&&i&&(n=S.forEvent(i).frameId),a.frameId=n||this.mainFrame&&this.mainFrame.frameId||"",this.asyncEventTracker.processEvent(e),this.isMarkerEvent(e)&&this.ensureNamedTrack(g.Timings),e.name){case p.ResourceSendRequest:case p.WebSocketCreate:a.setInitiator(t[t.length-1]||null),a.url=r.url;break;case p.ScheduleStyleRecalculation:this.lastScheduleStyleRecalculation[r.frame]=e;break;case p.UpdateLayoutTree:case p.RecalculateStyles:this.invalidationTracker.didRecalcStyle(e),e.args.beginData&&a.setInitiator(this.lastScheduleStyleRecalculation[e.args.beginData.frame]),this.lastRecalculateStylesEvent=e,this.currentScriptEvent&&this.currentTaskLayoutAndRecalcEvents.push(e);break;case p.ScheduleStyleInvalidationTracking:case p.StyleRecalcInvalidationTracking:case p.StyleInvalidatorInvalidationTracking:case p.LayoutInvalidationTracking:this.invalidationTracker.addInvalidation(new I(e,a));break;case p.InvalidateLayout:{let t=e;const a=r.frame;!this.layoutInvalidate[a]&&this.lastRecalculateStylesEvent&&void 0!==this.lastRecalculateStylesEvent.endTime&&this.lastRecalculateStylesEvent.endTime>e.startTime&&(t=S.forEvent(this.lastRecalculateStylesEvent).initiator()),this.layoutInvalidate[a]=t;break}case p.Layout:{this.invalidationTracker.didLayout(e);const t=e.args.beginData.frame;if(a.setInitiator(this.layoutInvalidate[t]),e.args.endData)if(e.args.endData.layoutRoots)for(let t=0;t<e.args.endData.layoutRoots.length;++t)a.backendNodeIds.push(e.args.endData.layoutRoots[t].nodeId);else a.backendNodeIds.push(e.args.endData.rootNode);this.layoutInvalidate[t]=null,this.currentScriptEvent&&this.currentTaskLayoutAndRecalcEvents.push(e);break}case p.Task:void 0!==e.duration&&e.duration>u.Thresholds.LongTask&&(a.warning=u.WarningType.LongTask);break;case p.EventDispatch:void 0!==e.duration&&e.duration>u.Thresholds.RecurringHandler&&(a.warning=u.WarningType.LongHandler);break;case p.TimerFire:case p.FireAnimationFrame:void 0!==e.duration&&e.duration>u.Thresholds.RecurringHandler&&(a.warning=u.WarningType.LongRecurringHandler);break;case p.FunctionCall:"string"==typeof r.scriptName&&(r.url=r.scriptName),"number"==typeof r.scriptLine&&(r.lineNumber=r.scriptLine);case p.EvaluateScript:case p.CompileScript:case p.CacheScript:"number"==typeof r.lineNumber&&--r.lineNumber,"number"==typeof r.columnNumber&&--r.columnNumber;case p.RunMicrotasks:this.currentScriptEvent||(this.currentScriptEvent=e);break;case p.SetLayerTreeId:{if(this.sessionId&&r.sessionId&&this.sessionId===r.sessionId){this.mainFrameLayerTreeId=r.layerTreeId;break}const t=u.eventFrameId(e),a=t?this.pageFrames.get(t):null;if(!a||a.parent)return!1;this.mainFrameLayerTreeId=r.layerTreeId;break}case p.Paint:{if(this.invalidationTracker.didPaint=!0,"nodeId"in r&&a.backendNodeIds.push(r.nodeId),!r.layerId)break;const t=r.layerId;this.lastPaintForLayer[t]=e;break}case p.DisplayItemListSnapshot:case p.PictureSnapshot:{const t=this.findAncestorEvent(p.UpdateLayer);if(!t||t.args.layerTreeId!==this.mainFrameLayerTreeId)break;const r=this.lastPaintForLayer[t.args.layerId];r&&(S.forEvent(r).picture=e);break}case p.ScrollLayer:a.backendNodeIds.push(r.nodeId);break;case p.PaintImage:a.backendNodeIds.push(r.nodeId),a.url=r.url;break;case p.DecodeImage:case p.ResizeImage:{let e=this.findAncestorEvent(p.PaintImage);if(!e){const t=this.findAncestorEvent(p.DecodeLazyPixelRef);e=t&&this.paintImageEventByPixelRefId[t.args.LazyPixelRef]}if(!e)break;const t=S.forEvent(e);a.backendNodeIds.push(t.backendNodeIds[0]),a.url=t.url;break}case p.DrawLazyPixelRef:{const t=this.findAncestorEvent(p.PaintImage);if(!t)break;this.paintImageEventByPixelRefId[e.args.LazyPixelRef]=t;const r=S.forEvent(t);a.backendNodeIds.push(r.backendNodeIds[0]),a.url=r.url;break}case p.FrameStartedLoading:if(a.frameId!==e.args.frame)return!1;break;case p.MarkLCPCandidate:a.backendNodeIds.push(r.nodeId);break;case p.MarkDOMContent:case p.MarkLoad:{const t=u.eventFrameId(e);if(!t||!this.pageFrames.has(t))return!1;break}case p.CommitLoad:{if(this.browserFrameTracking)break;const t=u.eventFrameId(e),a=Boolean(r.isOutermostMainFrame??r.isMainFrame),n=t?this.pageFrames.get(t):null;if(n)n.update(e.startTime,r);else if(this.persistentIds){if(a)return!1;if(!this.addPageFrame(e,r))return!1}else if(r.page&&r.page!==this.legacyCurrentPage)return!1;if(a&&t){const e=this.pageFrames.get(t);e&&(this.mainFrame=e)}break}case p.FireIdleCallback:void 0!==e.duration&&e.duration>r.allottedMilliseconds+u.Thresholds.IdleCallbackAddon&&(a.warning=u.WarningType.IdleDeadlineExceeded)}return!0}processBrowserEvent(e){if(e.name!==p.ResourceWillSendRequest){if(e.hasCategory(n.TracingModel.DevToolsMetadataEventCategory)&&e.args.data){const t=e.args.data;if(e.name===u.DevToolsMetadataEvent.TracingStartedInBrowser){if(!t.persistentIds)return;this.browserFrameTracking=!0,this.mainFrameNodeId=t.frameTreeNodeId;return void(t.frames||[]).forEach((e=>{const t=e.parent&&this.pageFrames.get(e.parent);if(e.parent&&!t)return;let r=this.pageFrames.get(e.frame);r||(r=new f(e),this.pageFrames.set(r.frameId,r),t?t.addChild(r):this.mainFrame=r),r.update(this.minimumRecordTimeInternal,e)}))}if(e.name===u.DevToolsMetadataEvent.FrameCommittedInBrowser&&this.browserFrameTracking){let r=this.pageFrames.get(t.frame);if(!r){const e=t.parent&&this.pageFrames.get(t.parent);if(!e)return;r=new f(t),this.pageFrames.set(r.frameId,r),e.addChild(r)}return void r.update(e.startTime,t)}if(e.name===u.DevToolsMetadataEvent.ProcessReadyInBrowser&&this.browserFrameTracking){const e=this.pageFrames.get(t.frame);return void(e&&e.processReady(t.processPseudoId,t.processId))}if(e.name===u.DevToolsMetadataEvent.FrameDeletedInBrowser&&this.browserFrameTracking){const r=this.pageFrames.get(t.frame);return void(r&&(r.deletedTime=e.startTime))}if(e.name===u.DevToolsMetadataEvent.AuctionWorkletRunningInProcess&&this.browserFrameTracking){const r=new v(e,t);this.auctionWorklets.set(t.target,r)}if(e.name===u.DevToolsMetadataEvent.AuctionWorkletDoneWithProcess&&this.browserFrameTracking){const r=this.auctionWorklets.get(t.target);r&&(r.endTime=e.startTime)}}}else{const t=e.args?.data?.requestId;"string"==typeof t&&this.requestsFromBrowser.set(t,e)}}ensureNamedTrack(e){let t=this.namedTracks.get(e);return t||(t=new T,t.type=e,this.tracksInternal.push(t),this.namedTracks.set(e,t),t)}findAncestorEvent(e){for(let t=this.eventStack.length-1;t>=0;--t){const r=this.eventStack[t];if(r.name===e)return r}return null}addPageFrame(e,t){const r=t.parent&&this.pageFrames.get(t.parent);if(t.parent&&!r)return!1;const a=new f(t);return this.pageFrames.set(a.frameId,a),a.update(e.startTime,t),r&&r.addChild(a),!0}reset(){this.isGenericTraceInternal=!1,this.tracksInternal=[],this.namedTracks=new Map,this.inspectedTargetEventsInternal=[],this.timeMarkerEventsInternal=[],this.sessionId=null,this.mainFrameNodeId=null,this.cpuProfilesInternal=[],this.workerIdByThread=new WeakMap,this.pageFrames=new Map,this.auctionWorklets=new Map,this.requestsFromBrowser=new Map,this.minimumRecordTimeInternal=0,this.maximumRecordTimeInternal=0,this.totalBlockingTimeInternal=-1,this.estimatedTotalBlockingTime=0}isGenericTrace(){return this.isGenericTraceInternal}tracingModel(){return this.tracingModelInternal}minimumRecordTime(){return this.minimumRecordTimeInternal}maximumRecordTime(){return this.maximumRecordTimeInternal}inspectedTargetEvents(){return this.inspectedTargetEventsInternal}tracks(){return this.tracksInternal}isEmpty(){return 0===this.minimumRecordTime()&&0===this.maximumRecordTime()}timeMarkerEvents(){return this.timeMarkerEventsInternal}rootFrames(){return Array.from(this.pageFrames.values()).filter((e=>!e.parent))}pageURL(){return this.mainFrame&&this.mainFrame.url||r.DevToolsPath.EmptyUrlString}pageFrameById(e){return e&&this.pageFrames.get(e)||null}networkRequests(){if(this.isGenericTrace())return[];const e=new Map,t=[],r=[],a=new Set([p.ResourceWillSendRequest,p.ResourceSendRequest,p.ResourceReceiveResponse,p.ResourceReceivedData,p.ResourceFinish,p.ResourceMarkAsCached]),n=this.inspectedTargetEvents();for(let e=0;e<n.length;++e){const t=n[e];if(!a.has(t.name))continue;const r=u.globalEventId(t,"requestId"),s=t.args?.data?.requestId;if(t.name===p.ResourceSendRequest&&s&&this.requestsFromBrowser.has(s)){const e=this.requestsFromBrowser.get(s);e&&i(e,r)}i(t,r)}function i(a,n){let i=e.get(n);i?i.addEvent(a):(i=new y(a),e.set(n,i),i.startTime?t.push(i):r.push(i))}return r.concat(t)}}var p,g;!function(e){e.Task="RunTask",e.Program="Program",e.EventDispatch="EventDispatch",e.GPUTask="GPUTask",e.Animation="Animation",e.RequestMainThreadFrame="RequestMainThreadFrame",e.BeginFrame="BeginFrame",e.NeedsBeginFrameChanged="NeedsBeginFrameChanged",e.BeginMainThreadFrame="BeginMainThreadFrame",e.ActivateLayerTree="ActivateLayerTree",e.DrawFrame="DrawFrame",e.DroppedFrame="DroppedFrame",e.HitTest="HitTest",e.ScheduleStyleRecalculation="ScheduleStyleRecalculation",e.RecalculateStyles="RecalculateStyles",e.UpdateLayoutTree="UpdateLayoutTree",e.InvalidateLayout="InvalidateLayout",e.Layerize="Layerize",e.Layout="Layout",e.LayoutShift="LayoutShift",e.UpdateLayer="UpdateLayer",e.UpdateLayerTree="UpdateLayerTree",e.PaintSetup="PaintSetup",e.Paint="Paint",e.PaintImage="PaintImage",e.PrePaint="PrePaint",e.Rasterize="Rasterize",e.RasterTask="RasterTask",e.ScrollLayer="ScrollLayer",e.Commit="Commit",e.CompositeLayers="CompositeLayers",e.ComputeIntersections="IntersectionObserverController::computeIntersections",e.InteractiveTime="InteractiveTime",e.ScheduleStyleInvalidationTracking="ScheduleStyleInvalidationTracking",e.StyleRecalcInvalidationTracking="StyleRecalcInvalidationTracking",e.StyleInvalidatorInvalidationTracking="StyleInvalidatorInvalidationTracking",e.LayoutInvalidationTracking="LayoutInvalidationTracking",e.ParseHTML="ParseHTML",e.ParseAuthorStyleSheet="ParseAuthorStyleSheet",e.TimerInstall="TimerInstall",e.TimerRemove="TimerRemove",e.TimerFire="TimerFire",e.XHRReadyStateChange="XHRReadyStateChange",e.XHRLoad="XHRLoad",e.CompileScript="v8.compile",e.CompileCode="V8.CompileCode",e.OptimizeCode="V8.OptimizeCode",e.EvaluateScript="EvaluateScript",e.CacheScript="v8.produceCache",e.CompileModule="v8.compileModule",e.EvaluateModule="v8.evaluateModule",e.CacheModule="v8.produceModuleCache",e.WasmStreamFromResponseCallback="v8.wasm.streamFromResponseCallback",e.WasmCompiledModule="v8.wasm.compiledModule",e.WasmCachedModule="v8.wasm.cachedModule",e.WasmModuleCacheHit="v8.wasm.moduleCacheHit",e.WasmModuleCacheInvalid="v8.wasm.moduleCacheInvalid",e.FrameStartedLoading="FrameStartedLoading",e.CommitLoad="CommitLoad",e.MarkLoad="MarkLoad",e.MarkDOMContent="MarkDOMContent",e.MarkFirstPaint="firstPaint",e.MarkFCP="firstContentfulPaint",e.MarkLCPCandidate="largestContentfulPaint::Candidate",e.MarkLCPInvalidate="largestContentfulPaint::Invalidate",e.NavigationStart="navigationStart",e.TimeStamp="TimeStamp",e.ConsoleTime="ConsoleTime",e.UserTiming="UserTiming",e.EventTiming="EventTiming",e.ResourceWillSendRequest="ResourceWillSendRequest",e.ResourceSendRequest="ResourceSendRequest",e.ResourceReceiveResponse="ResourceReceiveResponse",e.ResourceReceivedData="ResourceReceivedData",e.ResourceFinish="ResourceFinish",e.ResourceMarkAsCached="ResourceMarkAsCached",e.RunMicrotasks="RunMicrotasks",e.FunctionCall="FunctionCall",e.GCEvent="GCEvent",e.MajorGC="MajorGC",e.MinorGC="MinorGC",e.JSFrame="JSFrame",e.JSSample="JSSample",e.V8Sample="V8Sample",e.JitCodeAdded="JitCodeAdded",e.JitCodeMoved="JitCodeMoved",e.StreamingCompileScript="v8.parseOnBackground",e.StreamingCompileScriptWaiting="v8.parseOnBackgroundWaiting",e.StreamingCompileScriptParsing="v8.parseOnBackgroundParsing",e.V8Execute="V8.Execute",e.UpdateCounters="UpdateCounters",e.RequestAnimationFrame="RequestAnimationFrame",e.CancelAnimationFrame="CancelAnimationFrame",e.FireAnimationFrame="FireAnimationFrame",e.RequestIdleCallback="RequestIdleCallback",e.CancelIdleCallback="CancelIdleCallback",e.FireIdleCallback="FireIdleCallback",e.WebSocketCreate="WebSocketCreate",e.WebSocketSendHandshakeRequest="WebSocketSendHandshakeRequest",e.WebSocketReceiveHandshakeResponse="WebSocketReceiveHandshakeResponse",e.WebSocketDestroy="WebSocketDestroy",e.EmbedderCallback="EmbedderCallback",e.SetLayerTreeId="SetLayerTreeId",e.TracingStartedInPage="TracingStartedInPage",e.TracingSessionIdForWorker="TracingSessionIdForWorker",e.DecodeImage="Decode Image",e.ResizeImage="Resize Image",e.DrawLazyPixelRef="Draw LazyPixelRef",e.DecodeLazyPixelRef="Decode LazyPixelRef",e.LazyPixelRef="LazyPixelRef",e.LayerTreeHostImplSnapshot="cc::LayerTreeHostImpl",e.PictureSnapshot="cc::Picture",e.DisplayItemListSnapshot="cc::DisplayItemList",e.LatencyInfo="LatencyInfo",e.LatencyInfoFlow="LatencyInfo.Flow",e.InputLatencyMouseMove="InputLatency::MouseMove",e.InputLatencyMouseWheel="InputLatency::MouseWheel",e.ImplSideFling="InputHandlerProxy::HandleGestureFling::started",e.GCCollectGarbage="BlinkGC.AtomicPhase",e.CryptoDoEncrypt="DoEncrypt",e.CryptoDoEncryptReply="DoEncryptReply",e.CryptoDoDecrypt="DoDecrypt",e.CryptoDoDecryptReply="DoDecryptReply",e.CryptoDoDigest="DoDigest",e.CryptoDoDigestReply="DoDigestReply",e.CryptoDoSign="DoSign",e.CryptoDoSignReply="DoSignReply",e.CryptoDoVerify="DoVerify",e.CryptoDoVerifyReply="DoVerifyReply",e.CpuProfile="CpuProfile",e.Profile="Profile",e.AsyncTask="AsyncTask"}(p||(p={})),function(e){let t;e.Category={Console:"blink.console",UserTiming:"blink.user_timing",LatencyInfo:"latencyInfo",Loading:"loading"},function(e){e.LongTask="LongTask",e.ForcedStyle="ForcedStyle",e.ForcedLayout="ForcedLayout",e.IdleDeadlineExceeded="IdleDeadlineExceeded",e.LongHandler="LongHandler",e.LongRecurringHandler="LongRecurringHandler",e.V8Deopt="V8Deopt"}(t=e.WarningType||(e.WarningType={})),e.WorkerThreadName="DedicatedWorker thread",e.WorkerThreadNameLegacy="DedicatedWorker Thread",e.RendererMainThreadName="CrRendererMain",e.BrowserMainThreadName="CrBrowserMain",e.UtilityMainThreadName="CrUtilityMain",e.AuctionWorkletThreadName="AuctionV8HelperThread",e.DevToolsMetadataEvent={TracingStartedInBrowser:"TracingStartedInBrowser",TracingStartedInPage:"TracingStartedInPage",TracingSessionIdForWorker:"TracingSessionIdForWorker",FrameCommittedInBrowser:"FrameCommittedInBrowser",ProcessReadyInBrowser:"ProcessReadyInBrowser",FrameDeletedInBrowser:"FrameDeletedInBrowser",AuctionWorkletRunningInProcess:"AuctionWorkletRunningInProcess",AuctionWorkletDoneWithProcess:"AuctionWorkletDoneWithProcess"},e.Thresholds={LongTask:50,Handler:150,RecurringHandler:50,ForcedLayout:30,IdleCallbackAddon:5}}(u||(u={}));class T{name;type;forMainFrame;url;events;asyncEvents;tasks;syncEventsInternal;thread;constructor(){this.name="",this.type=g.Other,this.forMainFrame=!1,this.url=r.DevToolsPath.EmptyUrlString,this.events=[],this.asyncEvents=[],this.tasks=[],this.syncEventsInternal=null,this.thread=null}syncEvents(){if(this.events.length)return this.events;if(this.syncEventsInternal)return this.syncEventsInternal;const e=[];function t(){const t=e[e.length-1];if(void 0!==t){const e=t.endTime;if(void 0!==e)return e}throw new Error("End time does not exist on event.")}this.syncEventsInternal=[];for(const r of this.asyncEvents){const a=r.startTime;let i=r.endTime;for(void 0===i&&(i=a);e.length&&a>=t();)e.pop();if(e.length&&i>t()){this.syncEventsInternal=[];break}const s=new n.TracingModel.Event(r.categoriesString,r.name,n.TracingModel.Phase.Complete,a,r.thread);s.setEndTime(i),s.addArgs(r.args),this.syncEventsInternal.push(s),e.push(s)}return this.syncEventsInternal}}!function(e){e.MainThread="MainThread",e.Worker="Worker",e.Animation="Animation",e.Timings="Timings",e.Console="Console",e.Raster="Raster",e.GPU="GPU",e.Experience="Experience",e.Other="Other",e.UserInteractions="UserInteractions"}(g||(g={}));class f{frameId;url;name;children;parent;processes;deletedTime;ownerNode;constructor(e){this.frameId=e.frame,this.url=e.url||r.DevToolsPath.EmptyUrlString,this.name=e.name,this.children=[],this.parent=null,this.processes=[],this.deletedTime=null,this.ownerNode=null}update(e,t){this.url=t.url||"",this.name=t.name,t.processId?this.processes.push({time:e,processId:t.processId,processPseudoId:"",url:t.url||""}):this.processes.push({time:e,processId:-1,processPseudoId:t.processPseudoId,url:t.url||""})}processReady(e,t){for(const r of this.processes)r.processPseudoId===e&&(r.processPseudoId="",r.processId=t)}addChild(e){this.children.push(e),e.parent=this}}class v{targetId;processId;host;startTime;endTime;workletType;constructor(e,t){this.targetId="string"==typeof t.target?t.target:"",this.processId="number"==typeof t.pid?t.pid:0,this.host="string"==typeof t.host?t.host:void 0,this.startTime=e.startTime,this.endTime=1/0,"bidder"===t.type?this.workletType=1:"seller"===t.type?this.workletType=2:this.workletType=3}}class y{startTime;endTime;encodedDataLength;decodedBodyLength;children;timing;mimeType;url;requestMethod;transferSize;maybeDiskCached;memoryCachedInternal;priority;finishTime;responseTime;fromServiceWorker;hasCachedResource;constructor(e){const t=e.name===p.ResourceSendRequest||e.name===p.ResourceWillSendRequest;this.startTime=t?e.startTime:0,this.endTime=1/0,this.encodedDataLength=0,this.decodedBodyLength=0,this.children=[],this.transferSize=0,this.maybeDiskCached=!1,this.memoryCachedInternal=!1,this.addEvent(e)}addEvent(e){this.children.push(e),this.startTime=Math.min(this.startTime,e.startTime);const t=e.args.data;t.mimeType&&(this.mimeType=t.mimeType),"priority"in t&&(this.priority=t.priority),e.name===p.ResourceFinish&&(this.endTime=e.startTime),t.finishTime&&(this.finishTime=1e3*t.finishTime),this.responseTime||e.name!==p.ResourceReceiveResponse&&e.name!==p.ResourceReceivedData||(this.responseTime=e.startTime);const r=t.encodedDataLength||0;e.name===p.ResourceMarkAsCached&&(this.memoryCachedInternal=!0),e.name===p.ResourceReceiveResponse&&(t.fromCache&&(this.maybeDiskCached=!0),t.fromServiceWorker&&(this.fromServiceWorker=!0),t.hasCachedResource&&(this.hasCachedResource=!0),this.encodedDataLength=r),e.name===p.ResourceReceivedData&&(this.encodedDataLength+=r),e.name===p.ResourceFinish&&r&&(this.encodedDataLength=r,this.transferSize=r);const a=t.decodedBodyLength;e.name===p.ResourceFinish&&a&&(this.decodedBodyLength=a),this.url||(this.url=t.url),this.requestMethod||(this.requestMethod=t.requestMethod),this.timing||(this.timing=t.timing),t.fromServiceWorker&&(this.fromServiceWorker=!0)}cached(){return Boolean(this.memoryCachedInternal)||Boolean(this.maybeDiskCached)&&!this.transferSize&&!this.fromServiceWorker}memoryCached(){return this.memoryCachedInternal}getSendReceiveTiming(){if(this.cached()||!this.timing)return{sendStartTime:this.startTime,headersEndTime:this.startTime};const e=1e3*this.timing.requestTime;return{sendStartTime:e+this.timing.sendStart,headersEndTime:e+this.timing.receiveHeadersEnd}}getStartTime(){return Math.min(this.startTime,!this.cached()&&this.timing&&1e3*this.timing.requestTime||1/0)}beginTime(){return Math.min(this.getStartTime(),!this.cached()&&this.timing&&1e3*this.timing.pushStart||1/0)}}class I{type;startTime;tracingEvent;frame;nodeId;nodeName;invalidationSet;invalidatedSelectorId;changedId;changedClass;changedAttribute;changedPseudo;selectorPart;extraData;invalidationList;cause;linkedRecalcStyleEvent;linkedLayoutEvent;constructor(e,t){this.type=e.name,this.startTime=e.startTime,this.tracingEvent=e;const r=e.args.data;this.frame=r.frame,this.nodeId=r.nodeId,this.nodeName=r.nodeName,this.invalidationSet=r.invalidationSet,this.invalidatedSelectorId=r.invalidatedSelectorId,this.changedId=r.changedId,this.changedClass=r.changedClass,this.changedAttribute=r.changedAttribute,this.changedPseudo=r.changedPseudo,this.selectorPart=r.selectorPart,this.extraData=r.extraData,this.invalidationList=r.invalidationList,this.cause={reason:r.reason,stackTrace:t.stackTrace},this.linkedRecalcStyleEvent=!1,this.linkedLayoutEvent=!1,!this.cause.reason&&this.cause.stackTrace&&this.type===p.LayoutInvalidationTracking&&(this.cause.reason="Layout forced")}}class k{lastRecalcStyle;lastPaintWithLayer;didPaint;invalidations;invalidationsByNodeId;constructor(){this.lastRecalcStyle=null,this.lastPaintWithLayer=null,this.didPaint=!1,this.initializePerFrameState(),this.invalidations={},this.invalidationsByNodeId={}}static invalidationEventsFor(e){return R.get(e)||null}addInvalidation(e){if(this.startNewFrameIfNeeded(),!e.nodeId)return console.error("Invalidation lacks node information."),void console.error(e);if(e.type===p.StyleRecalcInvalidationTracking&&"StyleInvalidator"===e.cause.reason)return;if(e.type===p.ScheduleStyleInvalidationTracking||e.type===p.StyleInvalidatorInvalidationTracking||e.type===p.StyleRecalcInvalidationTracking){e.startTime&&this.lastRecalcStyle&&void 0!==this.lastRecalcStyle.endTime&&e.startTime>=this.lastRecalcStyle.startTime&&e.startTime<=this.lastRecalcStyle.endTime&&this.associateWithLastRecalcStyleEvent(e)}this.invalidations[e.type]?this.invalidations[e.type].push(e):this.invalidations[e.type]=[e],e.nodeId&&(this.invalidationsByNodeId[e.nodeId]?this.invalidationsByNodeId[e.nodeId].push(e):this.invalidationsByNodeId[e.nodeId]=[e])}didRecalcStyle(e){this.lastRecalcStyle=e;const t=[p.ScheduleStyleInvalidationTracking,p.StyleInvalidatorInvalidationTracking,p.StyleRecalcInvalidationTracking];for(const e of this.invalidationsOfTypes(t))this.associateWithLastRecalcStyleEvent(e)}associateWithLastRecalcStyleEvent(e){if(e.linkedRecalcStyleEvent)return;if(!this.lastRecalcStyle)throw new Error("Last recalculate style event not set.");const t=this.lastRecalcStyle.args.beginData.frame;e.type===p.StyleInvalidatorInvalidationTracking?this.addSyntheticStyleRecalcInvalidations(this.lastRecalcStyle,t,e):e.type===p.ScheduleStyleInvalidationTracking||this.addInvalidationToEvent(this.lastRecalcStyle,t,e),e.linkedRecalcStyleEvent=!0}addSyntheticStyleRecalcInvalidations(e,t,r){if(r.invalidationList){if(!r.nodeId)return console.error("Invalidation lacks node information."),void console.error(r);for(let e=0;e<r.invalidationList.length;e++){const a=r.invalidationList[e].id;let n;const i=this.invalidationsByNodeId[r.nodeId]||[];for(let e=0;e<i.length;e++){const r=i[e];r.frame===t&&r.invalidationSet===a&&r.type===p.ScheduleStyleInvalidationTracking&&(n=r)}n&&this.addSyntheticStyleRecalcInvalidation(n.tracingEvent,r)}}else this.addSyntheticStyleRecalcInvalidation(r.tracingEvent,r)}addSyntheticStyleRecalcInvalidation(e,t){const r=S.forEvent(e),a=new I(e,r);a.type=p.StyleRecalcInvalidationTracking,t.cause.reason&&(a.cause.reason=t.cause.reason),t.selectorPart&&(a.selectorPart=t.selectorPart),a.linkedRecalcStyleEvent||this.associateWithLastRecalcStyleEvent(a)}didLayout(e){const t=e.args.beginData.frame;for(const r of this.invalidationsOfTypes([p.LayoutInvalidationTracking]))r.linkedLayoutEvent||(this.addInvalidationToEvent(e,t,r),r.linkedLayoutEvent=!0)}addInvalidationToEvent(e,t,r){if(t!==r.frame)return;const a=R.get(e);a?a.push(r):R.set(e,[r])}invalidationsOfTypes(e){const t=this.invalidations;return e||(e=Object.keys(t)),function*(){if(e)for(let r=0;r<e.length;++r){const a=t[e[r]]||[];for(let e=0;e<a.length;++e)yield a[e]}}()}startNewFrameIfNeeded(){this.didPaint&&this.initializePerFrameState()}initializePerFrameState(){this.invalidations={},this.invalidationsByNodeId={},this.lastRecalcStyle=null,this.lastPaintWithLayer=null,this.didPaint=!1}}class F{initiatorByType;constructor(){if(F.initialize(),this.initiatorByType=new Map,F.asyncEvents)for(const e of F.asyncEvents.keys())this.initiatorByType.set(e,new Map)}static initialize(){if(F.asyncEvents)return;const e=new Map;e.set(p.TimerInstall,{causes:[p.TimerFire],joinBy:"timerId"}),e.set(p.ResourceSendRequest,{causes:[p.ResourceMarkAsCached,p.ResourceReceiveResponse,p.ResourceReceivedData,p.ResourceFinish],joinBy:"requestId"}),e.set(p.RequestAnimationFrame,{causes:[p.FireAnimationFrame],joinBy:"id"}),e.set(p.RequestIdleCallback,{causes:[p.FireIdleCallback],joinBy:"id"}),e.set(p.WebSocketCreate,{causes:[p.WebSocketSendHandshakeRequest,p.WebSocketReceiveHandshakeResponse,p.WebSocketDestroy],joinBy:"identifier"}),F.asyncEvents=e,F.typeToInitiator=new Map;for(const t of e){const e=t[1].causes;for(const r of e)F.typeToInitiator.set(r,t[0])}}processEvent(e){if(!F.typeToInitiator||!F.asyncEvents)return;let t=F.typeToInitiator.get(e.name);const r=!t;t||(t=e.name);const a=F.asyncEvents.get(t);if(!a)return;const n=u.globalEventId(e,a.joinBy);if(!n)return;const i=this.initiatorByType.get(t);if(i){if(r)return void i.set(n,e);const t=i.get(n),a=S.forEvent(e);a.setInitiator(t||null),!a.frameId&&t&&(a.frameId=u.eventFrameId(t))}}static asyncEvents=null;static typeToInitiator=null}class S{warning;previewElement;url;backendNodeIds;stackTrace;picture;initiatorInternal;frameId;timeWaitingForMainThread;constructor(){this.warning=null,this.previewElement=null,this.url=null,this.backendNodeIds=[],this.stackTrace=null,this.picture=null,this.initiatorInternal=null,this.frameId=null}setInitiator(e){if(this.initiatorInternal=e,!e||this.url)return;const t=S.forEvent(e).url;t&&(this.url=t)}initiator(){return this.initiatorInternal}topFrame(){const e=this.stackTraceForSelfOrInitiator();return e&&e[0]||null}stackTraceForSelfOrInitiator(){return this.stackTrace||this.initiatorInternal&&S.forEvent(this.initiatorInternal).stackTrace}static forEvent(e){let t=C.get(e);return t||(t=new S,C.set(e,t)),t}}const C=new WeakMap,R=new WeakMap;var E=Object.freeze({__proto__:null,get TimelineModelImpl(){return u},get RecordType(){return p},Track:T,get TrackType(){return g},PageFrame:f,AuctionWorklet:v,NetworkRequest:y,InvalidationTrackingEvent:I,InvalidationTracker:k,TimelineAsyncEventTracker:F,TimelineData:S});class P{accept(e){return!0}}class M extends P{visibleTypes;constructor(e){super(),this.visibleTypes=new Set(e)}accept(e){return this.visibleTypes.has(M.eventType(e))}static eventType(e){return e.hasCategory(u.Category.Console)?p.ConsoleTime:e.hasCategory(u.Category.UserTiming)?p.UserTiming:e.hasCategory(u.Category.LatencyInfo)?p.LatencyInfo:e.name}}var w=Object.freeze({__proto__:null,TimelineModelFilter:P,TimelineVisibleEventsFilter:M,TimelineInvisibleEventsFilter:class extends P{invisibleTypes;constructor(e){super(),this.invisibleTypes=new Set(e)}accept(e){return!this.invisibleTypes.has(M.eventType(e))}},ExclusiveNameFilter:class extends P{excludeNames;constructor(e){super(),this.excludeNames=new Set(e)}accept(e){return!this.excludeNames.has(e.name)}}});class L extends n.LayerTreeBase.LayerTreeBase{tileById;paintProfilerModel;constructor(e){super(e),this.tileById=new Map,this.paintProfilerModel=e&&e.model(n.PaintProfiler.PaintProfilerModel)}async setLayers(e,t,r){const a=new Set;if(e)this.extractNodeIdsToResolve(a,{},e);else if(t)for(let e=0;e<t.length;++e)this.extractNodeIdsToResolve(a,{},t[e]);await this.resolveBackendNodeIds(a);const n=this.layersById;if(this.layersById=new Map,this.setContentRoot(null),e){const t=this.innerSetLayers(n,e);this.setRoot(t)}else if(t){const e=t.map(this.innerSetLayers.bind(this,n)),r=this.contentRoot();if(!r)throw new Error("Content root is not set.");this.setRoot(r);for(let t=0;t<e.length;++t)e[t].id()!==r.id()&&r.addChild(e[t])}this.setPaints(r)}setTiles(e){this.tileById=new Map;for(const t of e)this.tileById.set(t.id,t)}pictureForRasterTile(t){const r=this.tileById.get("cc::Tile/"+t);if(!r)return e.Console.Console.instance().error(`Tile ${t} is missing`),Promise.resolve(null);const a=this.layerById(r.layer_id);return a?a.pictureForRect(r.content_rect):(e.Console.Console.instance().error(`Layer ${r.layer_id} for tile ${t} is not found`),Promise.resolve(null))}setPaints(e){for(let t=0;t<e.length;++t){const r=this.layersById.get(e[t].layerId());r&&r.addPaintEvent(e[t])}}innerSetLayers(e,t){let r=e.get(t.layer_id);r?r.reset(t):r=new b(this.paintProfilerModel,t),this.layersById.set(t.layer_id,r),t.owner_node&&r.setNode(this.backendNodeIdToNode().get(t.owner_node)||null),!this.contentRoot()&&r.drawsContent()&&this.setContentRoot(r);for(let a=0;t.children&&a<t.children.length;++a)r.addChild(this.innerSetLayers(e,t.children[a]));return r}extractNodeIdsToResolve(e,t,r){const a=r.owner_node;a&&!this.backendNodeIdToNode().has(a)&&e.add(a);for(let a=0;r.children&&a<r.children.length;++a)this.extractNodeIdsToResolve(e,t,r.children[a])}}class b{parentLayerId;parentInternal;layerId;nodeInternal;offsetXInternal;offsetYInternal;widthInternal;heightInternal;childrenInternal;quadInternal;scrollRectsInternal;gpuMemoryUsageInternal;paints;compositingReasonIds;drawsContentInternal;paintProfilerModel;constructor(e,t){this.parentLayerId=null,this.parentInternal=null,this.layerId="",this.nodeInternal=null,this.offsetXInternal=-1,this.offsetYInternal=-1,this.widthInternal=-1,this.heightInternal=-1,this.childrenInternal=[],this.quadInternal=[],this.scrollRectsInternal=[],this.gpuMemoryUsageInternal=-1,this.paints=[],this.compositingReasonIds=[],this.drawsContentInternal=!1,this.paintProfilerModel=e,this.reset(t)}reset(e){this.nodeInternal=null,this.layerId=String(e.layer_id),this.offsetXInternal=e.position[0],this.offsetYInternal=e.position[1],this.widthInternal=e.bounds.width,this.heightInternal=e.bounds.height,this.childrenInternal=[],this.parentLayerId=null,this.parentInternal=null,this.quadInternal=e.layer_quad||[],this.createScrollRects(e),this.compositingReasonIds=e.compositing_reason_ids||e.debug_info&&e.debug_info.compositing_reason_ids||[],this.drawsContentInternal=Boolean(e.draws_content),this.gpuMemoryUsageInternal=e.gpu_memory_usage,this.paints=[]}id(){return this.layerId}parentId(){return this.parentLayerId}parent(){return this.parentInternal}isRoot(){return!this.parentId()}children(){return this.childrenInternal}addChild(e){const t=e;t.parentInternal&&console.assert(!1,"Child already has a parent"),this.childrenInternal.push(t),t.parentInternal=this,t.parentLayerId=this.layerId}setNode(e){this.nodeInternal=e}node(){return this.nodeInternal}nodeForSelfOrAncestor(){let e=this;for(;e;e=e.parent())if(e.node())return e.node();return null}offsetX(){return this.offsetXInternal}offsetY(){return this.offsetYInternal}width(){return this.widthInternal}height(){return this.heightInternal}transform(){return null}quad(){return this.quadInternal}anchorPoint(){return[.5,.5,0]}invisible(){return!1}paintCount(){return 0}lastPaintRect(){return null}scrollRects(){return this.scrollRectsInternal}stickyPositionConstraint(){return null}gpuMemoryUsage(){return this.gpuMemoryUsageInternal}snapshots(){return this.paints.map((e=>e.snapshotPromise().then((e=>{if(!e)return null;return{rect:{x:e.rect[0],y:e.rect[1],width:e.rect[2],height:e.rect[3]},snapshot:e.snapshot}}))))}pictureForRect(e){return Promise.all(this.paints.map((e=>e.picturePromise()))).then((r=>{const a=r.filter((r=>{return r&&(a=r.rect,n=e,t(a[0],a[0]+a[2],n[0],n[0]+n[2])&&t(a[1],a[1]+a[3],n[1],n[1]+n[3]));var a,n})).map((e=>({x:e.rect[0],y:e.rect[1],picture:e.serializedPicture})));if(!a.length||!this.paintProfilerModel)return null;const n=a.reduce(((e,t)=>Math.min(e,t.x)),1/0),i=a.reduce(((e,t)=>Math.min(e,t.y)),1/0),s={x:e[0]-n,y:e[1]-i,width:e[2],height:e[3]};return this.paintProfilerModel.loadSnapshotFromFragments(a).then((e=>e?{rect:s,snapshot:e}:null))}));function t(e,t,r,a){return console.assert(e<=t&&r<=a,"segments should be specified as ordered pairs"),t>r&&e<a}}scrollRectsFromParams(e,t){return{rect:{x:e[0],y:e[1],width:e[2],height:e[3]},type:t}}createScrollRects(e){const t=[];e.non_fast_scrollable_region&&t.push(this.scrollRectsFromParams(e.non_fast_scrollable_region,"NonFastScrollable")),e.touch_event_handler_region&&t.push(this.scrollRectsFromParams(e.touch_event_handler_region,"TouchEventHandler")),e.wheel_event_handler_region&&t.push(this.scrollRectsFromParams(e.wheel_event_handler_region,"WheelEventHandler")),e.scroll_event_handler_region&&t.push(this.scrollRectsFromParams(e.scroll_event_handler_region,"RepaintsOnScroll")),this.scrollRectsInternal=t}addPaintEvent(e){this.paints.push(e)}requestCompositingReasonIds(){return Promise.resolve(this.compositingReasonIds)}drawsContent(){return this.drawsContentInternal}}var B=Object.freeze({__proto__:null,TracingLayerTree:L,TracingLayer:b});class N{categoryMapper;frames;frameById;beginFrameQueue;minimumRecordTime;lastFrame;mainFrameCommitted;mainFrameRequested;lastLayerTree;framePendingActivation;currentTaskTimeByCategory;target;framePendingCommit;lastBeginFrame;lastDroppedFrame;lastNeedsBeginFrame;lastTaskBeginTime;layerTreeId;currentProcessMainThread;constructor(e){this.categoryMapper=e,this.reset()}getFrames(){return this.frames}getFramesWithinWindow(e,t){const a=r.ArrayUtilities.lowerBound(this.frames,e||0,((e,t)=>e-t.endTime)),n=r.ArrayUtilities.lowerBound(this.frames,t||1/0,((e,t)=>e-t.startTime));return this.frames.slice(a,n)}hasRasterTile(e){const t=e.args.tileData;if(!t)return!1;const r=t.sourceFrameNumber,a=r&&this.frameById[r];return!(!a||!a.layerTree)}rasterTilePromise(e){if(!this.target)return Promise.resolve(null);const t=e.args.tileData,r=t.sourceFrameNumber,a=t.tileId&&t.tileId.id_ref,n=r&&this.frameById[r];return n&&n.layerTree&&a?n.layerTree.layerTreePromise().then((e=>e&&e.pictureForRasterTile(a))):Promise.resolve(null)}reset(){this.minimumRecordTime=1/0,this.frames=[],this.frameById={},this.beginFrameQueue=new U,this.lastFrame=null,this.lastLayerTree=null,this.mainFrameCommitted=!1,this.mainFrameRequested=!1,this.framePendingCommit=null,this.lastBeginFrame=null,this.lastDroppedFrame=null,this.lastNeedsBeginFrame=null,this.framePendingActivation=null,this.lastTaskBeginTime=null,this.target=null,this.layerTreeId=null,this.currentTaskTimeByCategory={}}handleBeginFrame(e,t){this.lastFrame||this.startFrame(e),this.lastBeginFrame=e,this.beginFrameQueue.addFrameIfNotExists(t,e,!1,!1)}handleDroppedFrame(e,t,r){this.lastFrame||this.startFrame(e),this.beginFrameQueue.addFrameIfNotExists(t,e,!0,r),this.beginFrameQueue.setDropped(t,!0),this.beginFrameQueue.setPartial(t,r)}handleDrawFrame(e,t){if(this.lastFrame){if(this.mainFrameCommitted||!this.mainFrameRequested){if(this.lastNeedsBeginFrame){(this.framePendingActivation?this.framePendingActivation.triggerTime:this.lastBeginFrame||this.lastNeedsBeginFrame)>this.lastFrame.startTime&&(this.lastFrame.idle=!0,this.lastBeginFrame=null),this.lastNeedsBeginFrame=null}const e=this.beginFrameQueue.processPendingBeginFramesOnDrawFrame(t);for(const t of e){const e=this.lastFrame.idle;this.startFrame(t.startTime),e&&this.framePendingActivation&&this.commitPendingFrame(),t.isDropped&&(this.lastFrame.dropped=!0),t.isPartial&&(this.lastFrame.isPartial=!0)}}this.mainFrameCommitted=!1}else this.startFrame(e)}handleActivateLayerTree(){this.lastFrame&&this.framePendingActivation&&!this.lastNeedsBeginFrame&&this.commitPendingFrame()}handleRequestMainThreadFrame(){this.lastFrame&&(this.mainFrameRequested=!0)}handleCommit(){this.framePendingCommit&&(this.framePendingActivation=this.framePendingCommit,this.framePendingCommit=null,this.mainFrameRequested=!1,this.mainFrameCommitted=!0)}handleLayerTreeSnapshot(e){this.lastLayerTree=e}handleNeedFrameChanged(e,t){t&&(this.lastNeedsBeginFrame=e)}startFrame(e){this.lastFrame&&this.flushFrame(this.lastFrame,e),this.lastFrame=new W(e,e-this.minimumRecordTime)}flushFrame(e,t){e.setLayerTree(this.lastLayerTree),e.setEndTime(t),this.lastLayerTree&&this.lastLayerTree.setPaints(e.paints);const r=this.frames[this.frames.length-1];this.frames.length&&r&&(e.startTime!==r.endTime||e.startTime>e.endTime)&&console.assert(!1,`Inconsistent frame time for frame ${this.frames.length} (${e.startTime} - ${e.endTime})`),this.frames.push(e),"number"==typeof e.mainFrameId&&(this.frameById[e.mainFrameId]=e)}commitPendingFrame(){this.framePendingActivation&&this.lastFrame&&(this.lastFrame.addTimeForCategories(this.framePendingActivation.timeByCategory),this.lastFrame.paints=this.framePendingActivation.paints,this.lastFrame.mainFrameId=this.framePendingActivation.mainFrameId,this.framePendingActivation=null)}addTraceEvents(e,t,r){this.target=e;let a=0;this.currentProcessMainThread=r.length&&r[0].thread||null;for(let e=0;e<t.length;++e){for(;a+1<r.length&&r[a+1].time<=t[e].startTime;)this.currentProcessMainThread=r[++a].thread;this.addTraceEvent(t[e])}this.currentProcessMainThread=null}addTraceEvent(e){if(e.startTime&&e.startTime<this.minimumRecordTime&&(this.minimumRecordTime=e.startTime),e.name===p.SetLayerTreeId)this.layerTreeId=e.args.layerTreeId||e.args.data.layerTreeId;else if(e.id&&e.phase===n.TracingModel.Phase.SnapshotObject&&e.name===p.LayerTreeHostImplSnapshot&&Number(e.id)===this.layerTreeId&&this.target){const t=e;this.handleLayerTreeSnapshot(new D(this.target,t))}else this.processCompositorEvents(e),e.thread===this.currentProcessMainThread?this.addMainThreadTraceEvent(e):this.lastFrame&&e.selfTime&&!n.TracingModel.TracingModel.isTopLevelEvent(e)&&this.lastFrame.addTimeForCategory(this.categoryMapper(e),e.selfTime)}processCompositorEvents(e){if(e.args.layerTreeId!==this.layerTreeId)return;const t=e.startTime;e.name===p.BeginFrame?this.handleBeginFrame(t,e.args.frameSeqId):e.name===p.DrawFrame?this.handleDrawFrame(t,e.args.frameSeqId):e.name===p.ActivateLayerTree?this.handleActivateLayerTree():e.name===p.RequestMainThreadFrame?this.handleRequestMainThreadFrame():e.name===p.NeedsBeginFrameChanged?this.handleNeedFrameChanged(t,e.args.data&&e.args.data.needsBeginFrame):e.name===p.DroppedFrame&&this.handleDroppedFrame(t,e.args.frameSeqId,e.args.hasPartialUpdate)}addMainThreadTraceEvent(e){n.TracingModel.TracingModel.isTopLevelEvent(e)&&(this.currentTaskTimeByCategory={},this.lastTaskBeginTime=e.startTime),!this.framePendingCommit&&N.mainFrameMarkers.indexOf(e.name)>=0&&(this.framePendingCommit=new x(this.lastTaskBeginTime||e.startTime,this.currentTaskTimeByCategory)),this.framePendingCommit?(this.addTimeForCategory(this.framePendingCommit.timeByCategory,e),e.name===p.BeginMainThreadFrame&&e.args.data&&e.args.data.frameId&&(this.framePendingCommit.mainFrameId=e.args.data.frameId),e.name===p.Paint&&e.args.data.layerId&&S.forEvent(e).picture&&this.target&&this.framePendingCommit.paints.push(new A(e,this.target)),e.name!==p.CompositeLayers&&e.name!==p.Commit||e.args.layerTreeId!==this.layerTreeId||this.handleCommit()):this.addTimeForCategory(this.currentTaskTimeByCategory,e)}addTimeForCategory(e,t){if(!t.selfTime)return;const r=this.categoryMapper(t);e[r]=(e[r]||0)+t.selfTime}static mainFrameMarkers=[p.ScheduleStyleRecalculation,p.InvalidateLayout,p.BeginMainThreadFrame,p.ScrollLayer]}class D{target;snapshot;paintsInternal;constructor(e,t){this.target=e,this.snapshot=t}async layerTreePromise(){const e=await this.snapshot.objectPromise();if(!e)return null;const t=e.device_viewport_size,r=e.active_tiles,a=e.active_tree.root_layer,n=e.active_tree.layers,i=new L(this.target);return i.setViewportSize(t),i.setTiles(r),await i.setLayers(a,n,this.paintsInternal||[]),i}paints(){return this.paintsInternal||[]}setPaints(e){this.paintsInternal=e}}class W{startTime;startTimeOffset;endTime;duration;timeByCategory;cpuTime;idle;dropped;isPartial;layerTree;paints;mainFrameId;constructor(e,t){this.startTime=e,this.startTimeOffset=t,this.endTime=this.startTime,this.duration=0,this.timeByCategory={},this.cpuTime=0,this.idle=!1,this.dropped=!1,this.isPartial=!1,this.layerTree=null,this.paints=[],this.mainFrameId=void 0}hasWarnings(){return!1}setEndTime(e){this.endTime=e,this.duration=this.endTime-this.startTime}setLayerTree(e){this.layerTree=e}addTimeForCategories(e){for(const t in e)this.addTimeForCategory(t,e[t])}addTimeForCategory(e,t){this.timeByCategory[e]=(this.timeByCategory[e]||0)+t,this.cpuTime+=t}}class A{eventInternal;target;constructor(e,t){this.eventInternal=e,this.target=t}layerId(){return this.eventInternal.args.data.layerId}event(){return this.eventInternal}picturePromise(){const e=S.forEvent(this.eventInternal).picture;return e?e.objectPromise().then((e=>{if(!e)return null;const t=e.params&&e.params.layer_rect,r=e.skp64;return t&&r?{rect:t,serializedPicture:r}:null})):Promise.resolve(null)}async snapshotPromise(){const e=this.target&&this.target.model(n.PaintProfiler.PaintProfilerModel),t=await this.picturePromise();if(!t||!e)return null;const r=await e.loadSnapshot(t.serializedPicture);return r?{rect:t.rect,snapshot:r}:null}}class x{timeByCategory;paints;mainFrameId;triggerTime;constructor(e,t){this.timeByCategory=t,this.paints=[],this.mainFrameId=void 0,this.triggerTime=e}}class _{seqId;startTime;isDropped;isPartial;constructor(e,t,r,a){this.seqId=e,this.startTime=t,this.isDropped=r,this.isPartial=a}}class U{queueFrames;mapFrames;constructor(){this.queueFrames=[],this.mapFrames={}}addFrameIfNotExists(e,t,r,a){e in this.mapFrames||(this.mapFrames[e]=new _(e,t,r,a),this.queueFrames.push(e))}setDropped(e,t){e in this.mapFrames&&(this.mapFrames[e].isDropped=t)}setPartial(e,t){e in this.mapFrames&&(this.mapFrames[e].isPartial=t)}processPendingBeginFramesOnDrawFrame(e){const t=[];if(e in this.mapFrames){for(;this.queueFrames[0]!==e;){const e=this.queueFrames[0];this.mapFrames[e].isDropped&&t.push(this.mapFrames[e]),delete this.mapFrames[e],this.queueFrames.shift()}t.push(this.mapFrames[e]),delete this.mapFrames[e],this.queueFrames.shift()}return t}}var q=Object.freeze({__proto__:null,TimelineFrameModel:N,TracingFrameLayerTree:D,TimelineFrame:W,LayerPaintEvent:A,PendingFrame:x,TimelineFrameBeginFrameQueue:U});class H{totalTime;selfTime;id;event;parent;groupId;isGroupNodeInternal;depth;constructor(e,t){this.totalTime=0,this.selfTime=0,this.id=e,this.event=t,this.groupId="",this.isGroupNodeInternal=!1,this.depth=0}isGroupNode(){return this.isGroupNodeInternal}hasChildren(){throw"Not implemented"}setHasChildren(e){throw"Not implemented"}children(){throw"Not implemented"}searchTree(e,t){t=t||[],this.event&&e(this.event)&&t.push(this);for(const r of this.children().values())r.searchTree(e,t);return t}}class G extends H{root;hasChildrenInternal;childrenInternal;parent;constructor(e,t,r){super(e,t),this.root=r&&r.root,this.hasChildrenInternal=!1,this.childrenInternal=null,this.parent=r}hasChildren(){return this.hasChildrenInternal}setHasChildren(e){this.hasChildrenInternal=e}children(){return this.childrenInternal||this.buildChildren()}buildChildren(){const e=[];for(let t=this;t.parent&&!t.isGroupNode();t=t.parent)e.push(t);e.reverse();const t=new Map,r=this,a=this.root;if(!a)return this.childrenInternal=t,this.childrenInternal;const n=a.startTime,i=a.endTime,s=a.doNotAggregate?function(t){++d,c===e.length&&d<=e.length+2&&m(t,0);--d}:void 0,o=a.doNotAggregate?void 0:j,l=a.getEventGroupIdCallback();let d=0,c=0,h=null;function m(a,n){if(d===e.length+2){if(!h)return;return h.setHasChildren(!0),void(h.selfTime-=n)}let i,s="";o?(i=o(a),s=l?l(a):"",s&&(i+="/"+s)):i=Symbol("uniqueId");let c=t.get(i);c||(c=new G(i,a,r),c.groupId=s,t.set(i,c)),c.selfTime+=n,c.totalTime+=n,h=c}return u.forEachEvent(a.events,(function(t){if(++d,d>e.length+2)return;if(!function(t){if(c===e.length)return!0;if(c!==d-1)return!1;if(!t.endTime)return!1;if(!o)return t===e[c].event&&++c,!1;let r=o(t);const a=l?l(t):"";a&&(r+="/"+a);r===e[c].id&&++c;return!1}(t))return;const r=(void 0!==t.endTime?Math.min(t.endTime,i):i)-Math.max(n,t.startTime);r<0&&console.error("Negative event duration");m(t,r)}),(function(e){--d,c>d&&(c=d)}),s,n,i,a.filter),this.childrenInternal=t,t}getRoot(){return this.root}}class O extends H{childrenInternal;isGroupNodeInternal;constructor(e,t,r){super(e,r),this.childrenInternal=new Map,this.parent=t,this.isGroupNodeInternal=!0}addChild(e,t,r){this.childrenInternal.set(e.id,e),this.selfTime+=t,this.totalTime+=r,e.parent=this}hasChildren(){return!0}children(){return this.childrenInternal}}class z extends H{parent;root;depth;cachedChildren;hasChildrenInternal;constructor(e,t,r,a,n){super(t,r),this.parent=n,this.root=e,this.depth=(n.depth||0)+1,this.cachedChildren=null,this.hasChildrenInternal=a}hasChildren(){return this.hasChildrenInternal}setHasChildren(e){this.hasChildrenInternal=e}children(){if(this.cachedChildren)return this.cachedChildren;const e=[0],t=[],r=[],a=new Map,n=this.root.startTime,i=this.root.endTime;let s=n;const o=this;return u.forEachEvent(this.root.events,(function(a){const s=(void 0!==a.endTime?Math.min(a.endTime,i):i)-Math.max(a.startTime,n);s<0&&console.assert(!1,"Negative duration of an event");e[e.length-1]-=s,e.push(s);const o=j(a);t.push(o),r.push(a)}),(function(n){const l=e.pop(),d=t.pop();let c;for(r.pop(),c=o;c.depth>1;c=c.parent)if(c.id!==t[t.length+1-c.depth])return;if(c.id!==d||t.length<o.depth)return;const h=t[t.length-o.depth];if(c=a.get(h),!c){const e=r[r.length-o.depth],t=r.length>o.depth;c=new z(o.root,h,e,t,o),a.set(h,c)}const m=void 0!==n.endTime?Math.min(n.endTime,i):i,u=m-Math.max(n.startTime,s);c.selfTime+=l||0,c.totalTime+=u,s=m}),void 0,n,i,this.root.filter),this.cachedChildren=this.root.filterChildren(a),this.cachedChildren}searchTree(e,t){return t=t||[],this.event&&e(this.event)&&t.push(this),t}}function $(e){return e.name===p.JSFrame?e.args.data||null:S.forEvent(e).topFrame()}function j(e){if(e.name===p.TimeStamp)return`${e.name}:${e.args.data.message}`;if(e.name!==p.JSFrame)return e.name;const t=e.args.data,r=t.scriptId||t.url||"",a=t.functionName;return`f:${l.isNativeRuntimeFrame(t)?l.nativeGroup(a)||a:`${a}:${t.lineNumber}:${t.columnNumber}`}@${r}`}var J=Object.freeze({__proto__:null,Node:H,TopDownNode:G,TopDownRootNode:class extends G{events;filter;startTime;endTime;eventGroupIdCallback;doNotAggregate;totalTime;selfTime;constructor(e,t,r,a,n,i){super("",null,null),this.root=this,this.events=e,this.filter=e=>t.every((t=>t.accept(e))),this.startTime=r,this.endTime=a,this.eventGroupIdCallback=i,this.doNotAggregate=n,this.totalTime=a-r,this.selfTime=this.totalTime}children(){return this.childrenInternal||this.grouppedTopNodes()}grouppedTopNodes(){const e=super.children();for(const t of e.values())this.selfTime-=t.totalTime;if(!this.eventGroupIdCallback)return e;const t=new Map;for(const r of e.values()){const e=this.eventGroupIdCallback(r.event);let a=t.get(e);a||(a=new O(e,this,r.event),t.set(e,a)),a.addChild(r,r.selfTime,r.totalTime)}return this.childrenInternal=t,t}getEventGroupIdCallback(){return this.eventGroupIdCallback}},BottomUpRootNode:class extends H{childrenInternal;events;textFilter;filter;startTime;endTime;eventGroupIdCallback;totalTime;constructor(e,t,r,a,n,i){super("",null),this.childrenInternal=null,this.events=e,this.textFilter=t,this.filter=e=>r.every((t=>t.accept(e))),this.startTime=a,this.endTime=n,this.eventGroupIdCallback=i,this.totalTime=n-a}hasChildren(){return!0}filterChildren(e){for(const[t,r]of e)r.event&&!this.textFilter.accept(r.event)&&e.delete(t);return e}children(){return this.childrenInternal||(this.childrenInternal=this.filterChildren(this.grouppedTopNodes())),this.childrenInternal}ungrouppedTopNodes(){const e=this,t=this.startTime,r=this.endTime,a=new Map,n=[r-t],i=[],s=new Map;u.forEachEvent(this.events,(function(e){const a=(void 0!==e.endTime?Math.min(e.endTime,r):r)-Math.max(e.startTime,t);n[n.length-1]-=a,n.push(a);const o=j(e),l=!s.has(o);l&&s.set(o,a);i.push(l)}),(function(t){const r=j(t);let o=a.get(r);o||(o=new z(e,r,t,!1,e),a.set(r,o));o.selfTime+=n.pop()||0,i.pop()&&(o.totalTime+=s.get(r)||0,s.delete(r));i.length&&o.setHasChildren(!0)}),void 0,t,r,this.filter),this.selfTime=n.pop()||0;for(const e of a)e[1].selfTime<=0&&a.delete(e[0]);return a}grouppedTopNodes(){const e=this.ungrouppedTopNodes();if(!this.eventGroupIdCallback)return e;const t=new Map;for(const r of e.values()){const e=this.eventGroupIdCallback(r.event);let a=t.get(e);a||(a=new O(e,this,r.event),t.set(e,a)),a.addChild(r,r.selfTime,r.selfTime)}return t}},GroupNode:O,BottomUpNode:z,eventURL:function(e){const t=e.args.data||e.args.beginData;if(t&&t.url)return t.url;let r=$(e);for(;r;){const e=r.url;if(e)return e;r=r.parent}return null},eventStackFrame:$,_eventId:j});export{q as TimelineFrameModel,d as TimelineJSProfile,E as TimelineModel,w as TimelineModelFilter,J as TimelineProfileTree,B as TracingLayerTree};
