import*as e from"../../core/common/common.js";import*as t from"../../core/platform/platform.js";import{assertNotNullOrUndefined as o}from"../../core/platform/platform.js";import*as r from"../../core/root/root.js";import*as i from"../../core/sdk/sdk.js";import*as s from"../workspace/workspace.js";import*as n from"../text_utils/text_utils.js";import*as a from"../../core/i18n/i18n.js";const c={unknownErrorLoadingFile:"Unknown error loading file"},u=a.i18n.registerUIStrings("models/bindings/ContentProviderBasedProject.ts",c),d=a.i18n.getLocalizedString.bind(void 0,u);class l extends s.Workspace.ProjectStore{#e;#t;constructor(e,t,o,r,i){super(e,t,o,r),this.#e=i,this.#t=new WeakMap,e.addProject(this)}async requestFileContent(e){const{contentProvider:t}=this.#t.get(e);try{const e=await t.requestContent(),o="wasmDisassemblyInfo"in e?e.wasmDisassemblyInfo:void 0;return{content:e.content,wasmDisassemblyInfo:o,isEncoded:e.isEncoded,error:"error"in e&&e.error||""}}catch(e){return{content:null,isEncoded:!1,error:e?String(e):d(c.unknownErrorLoadingFile)}}}isServiceProject(){return this.#e}async requestMetadata(e){const{metadata:t}=this.#t.get(e);return t}canSetFileContent(){return!1}async setFileContent(e,t,o){}fullDisplayName(e){let t=e.parentURL().replace(/^(?:https?|file)\:\/\//,"");try{t=decodeURI(t)}catch(e){}return t+"/"+e.displayName(!0)}mimeType(e){const{mimeType:t}=this.#t.get(e);return t}canRename(){return!1}rename(e,t,o){const r=e.url();this.performRename(r,t,((t,r)=>{t&&r&&this.renameUISourceCode(e,r),o(t,r)}))}excludeFolder(e){}canExcludeFolder(e){return!1}async createFile(e,t,o,r){return null}canCreateFile(){return!1}deleteFile(e){}remove(){}performRename(e,t,o){o(!1)}searchInFileContent(e,t,o,r){const{contentProvider:i}=this.#t.get(e);return i.searchInContent(t,o,r)}async findFilesMatchingSearchRequest(e,t,o){const r=[];return o.setTotalWork(t.length),await Promise.all(t.map(async function(t){const i=this.uiSourceCodeForURL(t);if(i){let o=!0;for(const t of e.queries().slice()){if(!(await this.searchInFileContent(i,t,!e.ignoreCase(),e.isRegex())).length){o=!1;break}}o&&r.push(t)}o.incrementWorked(1)}.bind(this))),o.done(),r}indexContent(e){queueMicrotask(e.done.bind(e))}addUISourceCodeWithProvider(e,t,o,r){this.#t.set(e,{mimeType:r,metadata:o,contentProvider:t}),this.addUISourceCode(e)}addContentProvider(e,t,o){const r=this.createUISourceCode(e,t.contentType());return this.addUISourceCodeWithProvider(r,t,null,o),r}reset(){this.removeProject(),this.workspace().addProject(this)}dispose(){this.removeProject()}}var p=Object.freeze({__proto__:null,ContentProviderBasedProject:l});const g={removeFromIgnoreList:"Remove from ignore list",addScriptToIgnoreList:"Add script to ignore list",addDirectoryToIgnoreList:"Add directory to ignore list",addAllContentScriptsToIgnoreList:"Add all content scripts to ignore list",addAllThirdPartyScriptsToIgnoreList:"Add all third-party scripts to ignore list"},h=a.i18n.registerUIStrings("models/bindings/IgnoreListManager.ts",g),m=a.i18n.getLocalizedString.bind(void 0,h);let S;class b{#o;#r;#i;constructor(t){this.#o=t,i.TargetManager.TargetManager.instance().addModelListener(i.DebuggerModel.DebuggerModel,i.DebuggerModel.Events.GlobalObjectCleared,this.clearCacheIfNeeded.bind(this),this),e.Settings.Settings.instance().moduleSetting("skipStackFramesPattern").addChangeListener(this.patternChanged.bind(this)),e.Settings.Settings.instance().moduleSetting("skipContentScripts").addChangeListener(this.patternChanged.bind(this)),e.Settings.Settings.instance().moduleSetting("automaticallyIgnoreListKnownThirdPartyScripts").addChangeListener(this.patternChanged.bind(this)),e.Settings.Settings.instance().moduleSetting("enableIgnoreListing").addChangeListener(this.patternChanged.bind(this)),this.#r=new Set,this.#i=new Map,i.TargetManager.TargetManager.instance().observeModels(i.DebuggerModel.DebuggerModel,this)}static instance(e={forceNew:null,debuggerWorkspaceBinding:null}){const{forceNew:t,debuggerWorkspaceBinding:o}=e;if(!S||t){if(!o)throw new Error(`Unable to create settings: debuggerWorkspaceBinding must be provided: ${(new Error).stack}`);S=new b(o)}return S}static removeInstance(){S=void 0}addChangeListener(e){this.#r.add(e)}removeChangeListener(e){this.#r.delete(e)}modelAdded(e){this.setIgnoreListPatterns(e);const t=e.sourceMapManager();t.addEventListener(i.SourceMapManager.Events.SourceMapAttached,this.sourceMapAttached,this),t.addEventListener(i.SourceMapManager.Events.SourceMapDetached,this.sourceMapDetached,this)}modelRemoved(e){this.clearCacheIfNeeded();const t=e.sourceMapManager();t.removeEventListener(i.SourceMapManager.Events.SourceMapAttached,this.sourceMapAttached,this),t.removeEventListener(i.SourceMapManager.Events.SourceMapDetached,this.sourceMapDetached,this)}clearCacheIfNeeded(){this.#i.size>1024&&this.#i.clear()}getSkipStackFramesPatternSetting(){return e.Settings.Settings.instance().moduleSetting("skipStackFramesPattern")}setIgnoreListPatterns(e){const t=this.enableIgnoreListing?this.getSkipStackFramesPatternSetting().getAsArray():[],o=[];for(const e of t)!e.disabled&&e.pattern&&o.push(e.pattern);return e.setBlackboxPatterns(o)}isUserOrSourceMapIgnoreListedUISourceCode(e){const t=e.project().type()===s.Workspace.projectTypes.ContentScripts;if(this.skipContentScripts&&t)return!0;const o=this.uiSourceCodeURL(e);return!!o&&this.isUserOrSourceMapIgnoreListedURL(o,e.isKnownThirdParty())}isUserOrSourceMapIgnoreListedURL(e,t){return!!this.isUserIgnoreListedURL(e)||!(!this.automaticallyIgnoreListKnownThirdPartyScripts||!t)}isUserIgnoreListedURL(e,t){if(!this.enableIgnoreListing)return!1;if(this.#i.has(e))return Boolean(this.#i.get(e));if(t&&this.skipContentScripts)return!0;const o=this.getSkipStackFramesPatternSetting().asRegExp(),r=o&&o.test(e)||!1;return this.#i.set(e,r),r}sourceMapAttached(e){const t=e.data.client,o=e.data.sourceMap;this.updateScriptRanges(t,o)}sourceMapDetached(e){const t=e.data.client;this.updateScriptRanges(t,void 0)}async updateScriptRanges(e,t){let o=!1;if(b.instance().isUserIgnoreListedURL(e.sourceURL,e.isContentScript())||(o=t?.sourceURLs().some((e=>this.isUserOrSourceMapIgnoreListedURL(e,t.hasIgnoreListHint(e))))??!1),!o)return f.get(e)&&await e.setBlackboxedRanges([])&&f.delete(e),void await this.#o.updateLocations(e);if(!t)return;const r=t.findRanges((e=>this.isUserOrSourceMapIgnoreListedURL(e,t.hasIgnoreListHint(e))),{isStartMatching:!0}).flatMap((e=>[e.start,e.end]));!function(e,t){if(e.length!==t.length)return!1;for(let o=0;o<e.length;++o)if(e[o].lineNumber!==t[o].lineNumber||e[o].columnNumber!==t[o].columnNumber)return!1;return!0}(f.get(e)||[],r)&&await e.setBlackboxedRanges(r)&&f.set(e,r),this.#o.updateLocations(e)}uiSourceCodeURL(e){return e.project().type()===s.Workspace.projectTypes.Debugger?null:e.url()}canIgnoreListUISourceCode(e){const t=this.uiSourceCodeURL(e);return!!t&&Boolean(this.urlToRegExpString(t))}ignoreListUISourceCode(e){const t=this.uiSourceCodeURL(e);t&&this.ignoreListURL(t)}unIgnoreListUISourceCode(e){e.project().type()===s.Workspace.projectTypes.ContentScripts&&this.unIgnoreListContentScripts(),e.isKnownThirdParty()&&this.unIgnoreListThirdParty();const t=this.uiSourceCodeURL(e);t&&this.unIgnoreListURL(t)}get enableIgnoreListing(){return e.Settings.Settings.instance().moduleSetting("enableIgnoreListing").get()}set enableIgnoreListing(t){e.Settings.Settings.instance().moduleSetting("enableIgnoreListing").set(t)}get skipContentScripts(){return this.enableIgnoreListing&&e.Settings.Settings.instance().moduleSetting("skipContentScripts").get()}get automaticallyIgnoreListKnownThirdPartyScripts(){return this.enableIgnoreListing&&e.Settings.Settings.instance().moduleSetting("automaticallyIgnoreListKnownThirdPartyScripts").get()}ignoreListContentScripts(){this.enableIgnoreListing||(this.enableIgnoreListing=!0),e.Settings.Settings.instance().moduleSetting("skipContentScripts").set(!0)}unIgnoreListContentScripts(){e.Settings.Settings.instance().moduleSetting("skipContentScripts").set(!1)}ignoreListThirdParty(){this.enableIgnoreListing||(this.enableIgnoreListing=!0),e.Settings.Settings.instance().moduleSetting("automaticallyIgnoreListKnownThirdPartyScripts").set(!0)}unIgnoreListThirdParty(){e.Settings.Settings.instance().moduleSetting("automaticallyIgnoreListKnownThirdPartyScripts").set(!1)}ignoreListURL(e){const t=this.urlToRegExpString(e);t&&this.ignoreListRegex(t,e)}ignoreListRegex(e,t){const o=this.getSkipStackFramesPatternSetting().getAsArray();let r=!1;for(let i=0;i<o.length;++i){const s=o[i];(s.pattern===e||t&&s.disabledForUrl===t)&&(s.disabled=!1,s.disabledForUrl=void 0,r=!0)}r||o.push({pattern:e,disabled:!1}),this.enableIgnoreListing||(this.enableIgnoreListing=!0),this.getSkipStackFramesPatternSetting().setAsArray(o)}unIgnoreListURL(e){let t=this.getSkipStackFramesPatternSetting().getAsArray();const o=b.instance().urlToRegExpString(e);if(o){t=t.filter((function(e){return e.pattern!==o}));for(let o=0;o<t.length;++o){const r=t[o];if(!r.disabled)try{new RegExp(r.pattern).test(e)&&(r.disabled=!0,r.disabledForUrl=e)}catch(e){}}this.getSkipStackFramesPatternSetting().setAsArray(t)}}removeIgnoreListPattern(e){let t=this.getSkipStackFramesPatternSetting().getAsArray();t=t.filter((function(t){return t.pattern!==e})),this.getSkipStackFramesPatternSetting().setAsArray(t)}ignoreListHasPattern(e,t){return this.getSkipStackFramesPatternSetting().getAsArray().some((o=>!(t&&o.disabled)&&o.pattern===e))}async patternChanged(){this.#i.clear();const e=[];for(const t of i.TargetManager.TargetManager.instance().models(i.DebuggerModel.DebuggerModel)){e.push(this.setIgnoreListPatterns(t));const o=t.sourceMapManager();for(const r of t.scripts())e.push(this.updateScriptRanges(r,o.sourceMapForClient(r)))}await Promise.all(e);const t=Array.from(this.#r);for(const e of t)e();this.patternChangeFinishedForTests()}patternChangeFinishedForTests(){}urlToRegExpString(o){const r=new e.ParsedURL.ParsedURL(o);if(r.isAboutBlank()||r.isDataURL())return"";if(!r.isValid)return"^"+t.StringUtilities.escapeForRegExp(o)+"$";let i=r.lastPathComponent;if(i?i="/"+i:r.folderPathComponents&&(i=r.folderPathComponents+"/"),i||(i=r.host),!i)return"";const s=r.scheme;let n="";return s&&"http"!==s&&"https"!==s&&(n="^"+s+"://","chrome-extension"===s&&(n+=r.host+"\\b"),n+=".*"),n+t.StringUtilities.escapeForRegExp(i)+(o.endsWith(i)?"$":"\\b")}getIgnoreListURLContextMenuItems(e){if(e.project().type()===s.Workspace.projectTypes.FileSystem)return[];const t=[],o=this.canIgnoreListUISourceCode(e),r=this.isUserOrSourceMapIgnoreListedUISourceCode(e),i=e.project().type()===s.Workspace.projectTypes.ContentScripts,n=e.isKnownThirdParty();return r?(o||i||n)&&t.push({text:m(g.removeFromIgnoreList),callback:this.unIgnoreListUISourceCode.bind(this,e)}):(o&&t.push({text:m(g.addScriptToIgnoreList),callback:this.ignoreListUISourceCode.bind(this,e)}),i&&t.push({text:m(g.addAllContentScriptsToIgnoreList),callback:this.ignoreListContentScripts.bind(this)}),n&&t.push({text:m(g.addAllThirdPartyScriptsToIgnoreList),callback:this.ignoreListThirdParty.bind(this)})),t}getIgnoreListFolderContextMenuItems(e){const o=[],r="^"+t.StringUtilities.escapeForRegExp(e)+"/";return this.ignoreListHasPattern(r,!0)?o.push({text:m(g.removeFromIgnoreList),callback:this.removeIgnoreListPattern.bind(this,r)}):o.push({text:m(g.addDirectoryToIgnoreList),callback:this.ignoreListRegex.bind(this,r)}),o}}const f=new WeakMap;var L=Object.freeze({__proto__:null,IgnoreListManager:b});const M=new WeakMap,C=new WeakMap;let I;class v extends e.ObjectWrapper.ObjectWrapper{constructor(){super()}static instance({forceNew:e}={forceNew:!1}){return I&&!e||(I=new v),I}}var w;!function(e){e.FrameAttributionAdded="FrameAttributionAdded",e.FrameAttributionRemoved="FrameAttributionRemoved"}(w||(w={}));class y{static resolveFrame(e,t){const o=y.targetForUISourceCode(e),r=o&&o.model(i.ResourceTreeModel.ResourceTreeModel);return r?r.frameForId(t):null}static setInitialFrameAttribution(e,t){if(!t)return;const o=y.resolveFrame(e,t);if(!o)return;const r=new Map;r.set(t,{frame:o,count:1}),M.set(e,r)}static cloneInitialFrameAttribution(e,t){const o=M.get(e);if(!o)return;const r=new Map;for(const e of o.keys()){const t=o.get(e);void 0!==t&&r.set(e,{frame:t.frame,count:t.count})}M.set(t,r)}static addFrameAttribution(e,t){const o=y.resolveFrame(e,t);if(!o)return;const r=M.get(e);if(!r)return;const i=r.get(t)||{frame:o,count:0};if(i.count+=1,r.set(t,i),1!==i.count)return;const s={uiSourceCode:e,frame:o};v.instance().dispatchEventToListeners(w.FrameAttributionAdded,s)}static removeFrameAttribution(e,t){const o=M.get(e);if(!o)return;const r=o.get(t);if(console.assert(Boolean(r),"Failed to remove frame attribution for url: "+e.url()),!r)return;if(r.count-=1,r.count>0)return;o.delete(t);const i={uiSourceCode:e,frame:r.frame};v.instance().dispatchEventToListeners(w.FrameAttributionRemoved,i)}static targetForUISourceCode(e){return C.get(e.project())||null}static setTargetForProject(e,t){C.set(e,t)}static getTargetForProject(e){return C.get(e)||null}static framesForUISourceCode(e){const t=y.targetForUISourceCode(e),o=t&&t.model(i.ResourceTreeModel.ResourceTreeModel),r=M.get(e);if(!o||!r)return[];return Array.from(r.keys()).map((e=>o.frameForId(e))).filter((e=>Boolean(e)))}}var R=Object.freeze({__proto__:null,NetworkProjectManager:v,get Events(){return w},NetworkProject:y});class T{#s;#o;#n=new Map;#a;#c;#u=new Map;#d=new Map;#l=new t.MapUtilities.Multimap;constructor(e,t,o){k.add(this),this.#s=e.sourceMapManager(),this.#o=o,this.#a=new l(t,"jsSourceMaps:stub:"+e.target().id(),s.Workspace.projectTypes.Service,"",!0),this.#c=[this.#s.addEventListener(i.SourceMapManager.Events.SourceMapWillAttach,this.sourceMapWillAttach,this),this.#s.addEventListener(i.SourceMapManager.Events.SourceMapFailedToAttach,this.sourceMapFailedToAttach,this),this.#s.addEventListener(i.SourceMapManager.Events.SourceMapAttached,this.sourceMapAttached,this),this.#s.addEventListener(i.SourceMapManager.Events.SourceMapDetached,this.sourceMapDetached,this)]}addStubUISourceCode(t){const o=this.#a.addContentProvider(e.ParsedURL.ParsedURL.concatenate(t.sourceURL,":sourcemap"),n.StaticContentProvider.StaticContentProvider.fromString(t.sourceURL,e.ResourceType.resourceTypes.Script,"\n\n\n\n\n// Please wait a bit.\n// Compiled script is not shown while source map is being loaded!"),"text/javascript");this.#n.set(t,o)}removeStubUISourceCode(e){const t=this.#n.get(e);this.#n.delete(e),t&&this.#a.removeUISourceCode(t.url())}static uiSourceCodeOrigin(e){const t=new Set;for(const o of k)for(const r of o.#l.get(e))t.add(r.compiledURL());return[...t]}getLocationRangesForSameSourceLocation(e){const t=e.debuggerModel,o=e.script();if(!o)return[];const r=this.#s.sourceMapForClient(o);if(!r)return[];const{lineNumber:i,columnNumber:s}=o.rawLocationToRelativeLocation(e),n=r.findEntry(i,s);if(!n||!n.sourceURL)return[];const a=this.#d.get(r);if(!a)return[];const c=a.uiSourceCodeForURL(n.sourceURL);if(!c)return[];if(!this.#l.hasValue(c,r))return[];return r.findReverseRanges(n.sourceURL,n.sourceLineNumber,n.sourceColumnNumber).map((({startLine:e,startColumn:r,endLine:i,endColumn:s})=>{const n=o.relativeLocationToRawLocation({lineNumber:e,columnNumber:r}),a=o.relativeLocationToRawLocation({lineNumber:i,columnNumber:s});return{start:t.createRawLocation(o,n.lineNumber,n.columnNumber),end:t.createRawLocation(o,a.lineNumber,a.columnNumber)}}))}uiSourceCodeForURL(e,t){const o=t?s.Workspace.projectTypes.ContentScripts:s.Workspace.projectTypes.Network;for(const t of this.#u.values()){if(t.type()!==o)continue;const r=t.uiSourceCodeForURL(e);if(r)return r}return null}rawLocationToUILocation(e){const t=e.script();if(!t)return null;const{lineNumber:o,columnNumber:r}=t.rawLocationToRelativeLocation(e),i=this.#n.get(t);if(i)return new s.UISourceCode.UILocation(i,o,r);const n=this.#s.sourceMapForClient(t);if(!n)return null;const a=this.#d.get(n);if(!a)return null;const c=n.findEntry(o,r);if(!c||!c.sourceURL)return null;const u=a.uiSourceCodeForURL(c.sourceURL);return u&&this.#l.hasValue(u,n)?u.uiLocation(c.sourceLineNumber,c.sourceColumnNumber):null}uiLocationToRawLocations(e,t,o){const r=[];for(const i of this.#l.get(e)){const s=i.sourceLineMapping(e.url(),t,o);if(!s)continue;const n=this.#s.clientForSourceMap(i);if(!n)continue;const a=n.relativeLocationToRawLocation(s);r.push(n.debuggerModel.createRawLocation(n,a.lineNumber,a.columnNumber))}return r}getMappedLines(e){if(!this.#l.has(e))return null;const t=new Set;for(const o of this.#l.get(e))for(const r of o.mappings())r.sourceURL===e.url()&&t.add(r.sourceLineNumber);return t}sourceMapWillAttach(e){const{client:t}=e.data;this.addStubUISourceCode(t),this.#o.updateLocations(t)}sourceMapFailedToAttach(e){const{client:t}=e.data;this.removeStubUISourceCode(t),this.#o.updateLocations(t)}sourceMapAttached(t){const{client:o,sourceMap:r}=t.data,a=new Set([o]);if(this.removeStubUISourceCode(o),!b.instance().isUserIgnoreListedURL(o.sourceURL,o.isContentScript())){const t=o.target(),c=`jsSourceMaps:${o.isContentScript()?"extensions":""}:${t.id()}`;let u=this.#u.get(c);if(!u){const e=o.isContentScript()?s.Workspace.projectTypes.ContentScripts:s.Workspace.projectTypes.Network;u=new l(this.#a.workspace(),c,e,"",!1),y.setTargetForProject(u,t),this.#u.set(c,u)}this.#d.set(r,u);for(const t of r.sourceURLs()){let c=u.uiSourceCodeForURL(t);if(c){const e=this.#l.get(c),[o]=e;if(!r.compatibleForURL(t,o)){for(const t of e){const e=this.#s.clientForSourceMap(t);e&&(y.removeFrameAttribution(c,e.frameId),a.add(e))}this.#l.deleteAll(c),u.removeUISourceCode(t),c=null}}if(c)y.addFrameAttribution(c,o.frameId);else{const a=e.ResourceType.resourceTypes.SourceMapScript;c=u.createUISourceCode(t,a),r.hasIgnoreListHint(t)&&c.markKnownThirdParty();const d=r.embeddedContentByURL(t),l=null!==d?n.StaticContentProvider.StaticContentProvider.fromString(t,a,d):new i.CompilerSourceMappingContentProvider.CompilerSourceMappingContentProvider(t,a,o.createPageResourceLoadInitiator()),p=null!==d?new s.UISourceCode.UISourceCodeMetadata(null,d.length):null,g=e.ResourceType.ResourceType.mimeFromURL(t)??a.canonicalMimeType();y.setInitialFrameAttribution(c,o.frameId),u.addUISourceCodeWithProvider(c,l,p,g)}this.#l.set(c,r)}}Promise.all([...a].map((e=>this.#o.updateLocations(e)))).then((()=>this.sourceMapAttachedForTest(r)))}sourceMapDetached(e){const{client:t,sourceMap:o}=e.data,r=this.#d.get(o);if(r){for(const e of r.uiSourceCodes())this.#l.delete(e,o)&&(y.removeFrameAttribution(e,t.frameId),this.#l.has(e)||r.removeUISourceCode(e.url()));this.#d.delete(o),this.#o.updateLocations(t)}}scriptsForUISourceCode(e){const t=[];for(const o of this.#l.get(e)){const e=this.#s.clientForSourceMap(o);e&&t.push(e)}return t}sourceMapAttachedForTest(e){}dispose(){k.delete(this),e.EventTarget.removeEventListeners(this.#c);for(const e of this.#u.values())e.dispose();this.#a.dispose()}}const k=new Set;var F=Object.freeze({__proto__:null,CompilerScriptMapping:T});const U={errorInDebuggerLanguagePlugin:"Error in debugger language plugin: {PH1}",loadingDebugSymbolsForVia:"[{PH1}] Loading debug symbols for {PH2} (via {PH3})...",loadingDebugSymbolsFor:"[{PH1}] Loading debug symbols for {PH2}...",loadedDebugSymbolsForButDidnt:"[{PH1}] Loaded debug symbols for {PH2}, but didn't find any source files",loadedDebugSymbolsForFound:"[{PH1}] Loaded debug symbols for {PH2}, found {PH3} source file(s)",failedToLoadDebugSymbolsFor:"[{PH1}] Failed to load debug symbols for {PH2} ({PH3})",failedToLoadDebugSymbolsForFunction:'No debug information for function "{PH1}"',debugSymbolsIncomplete:"The debug information for function {PH1} is incomplete"},P=a.i18n.registerUIStrings("models/bindings/DebuggerLanguagePlugins.ts",U),j=a.i18n.getLocalizedString.bind(void 0,P);class N{typeInfo;members;typeMap;constructor(e,t,o){this.typeInfo=e,this.members=t,this.typeMap=o}static create(e){if(0===e.length)return null;const t=new Map;for(const o of e)t.set(o.typeId,new N(o,[],t));for(const o of t.values())o.members=o.typeInfo.members.map((({typeId:o})=>{const r=t.get(o);if(!r)throw new Error(`Incomplete type information for type ${e[0].typeNames[0]||"<anonymous>"}`);return r}));return t.get(e[0].typeId)||null}}function E(e){return`${e.sourceURL}@${e.hash}`}function D(e){const{script:t}=e;return{rawModuleId:E(t),codeOffset:e.location().columnNumber-(t.codeOffset()||0),inlineFrameIndex:e.inlineFrameIndex}}class B extends i.RemoteObject.RemoteObjectImpl{inspectableAddress;callFrame;constructor(e,t,o,r,i,s,n,a,c,u,d){super(e.debuggerModel.runtimeModel(),t,o,r,i,n,a,c,u,d),this.inspectableAddress=s,this.callFrame=e}get sourceType(){throw new Error("Not Implemented")}}async function A(e,t,o,r){const s=D(e);let n;try{n=await t.getTypeInfo(o,s)}catch(t){throw W.makeLocal(e,t.message)}if(!n)return new i.RemoteObject.LocalJSONObject(void 0);const{base:a,typeInfos:c}=n,u=N.create(c);if(!u)return new i.RemoteObject.LocalJSONObject(void 0);if(u.typeInfo.hasValue&&!u.typeInfo.canExpand&&a)return O(e,t,u,a,[],r);const d=await H.getInspectableAddress(e,t,a,[],r);return new H(e,t,u,a,[],r,d)}async function O(e,t,o,r,i,s){const n=D(e);let a=await t.getFormatter({base:r,field:i},n);a||(a={js:""});const c=await e.debuggerModel.target().debuggerAgent().invoke_evaluateOnCallFrame({callFrameId:e.id,expression:a.js,objectGroup:s.objectGroup,includeCommandLineAPI:s.includeCommandLineAPI,silent:s.silent,returnByValue:s.returnByValue,generatePreview:s.generatePreview,throwOnSideEffect:s.throwOnSideEffect,timeout:s.timeout}),u=c.getError();if(u)throw new Error(u);const{result:d,exceptionDetails:l}=c;if(l)throw new W(e.debuggerModel.runtimeModel().createRemoteObject(d),l);const p=new x(e,o,t,d,null,s,void 0),g=await async function(e){const{tag:t,value:o,inspectableAddress:r,description:i}=await e.findProperties("tag","value","inspectableAddress","description");if(!t||!o)return null;const{className:s,symbol:n}=await t.findProperties("className","symbol");if(!s||!n)return null;const a=s.value;if("string"!=typeof a||void 0===n.objectId)return null;const c=i?.value;"string"==typeof c&&(o.description=c);return o.formatterTag={symbol:n.objectId,className:a},o.inspectableAddress=r?r.value:void 0,o}(p),h=g||p;return void 0===h.value&&"undefined"!==h.type&&(h.description=o.typeInfo.typeNames[0]),h}class x extends B{#p;#g;formatterTag;#h;constructor(e,t,o,r,i,s,n){super(e,r.objectId,r.type,r.subtype,r.value,n,r.unserializableValue,r.description,r.preview,r.customPreview,r.className),this.#p=o,this.#g=t,this.formatterTag=i,this.#h=s}get sourceType(){return this.#g}async findProperties(...e){const t={};for(const o of(await this.getOwnProperties(!1)).properties||[])e.indexOf(o.name)>=0&&o.value&&(t[o.name]=o.value);return t}async createRemoteObject(e){const t=await this.getEvalBaseFromObject(e);if(!t)return new x(this.callFrame,this.#g,this.#p,e,this.formatterTag,this.#h,void 0);const o=this.#g.typeMap.get(t.rootType.typeId);if(!o)throw new Error("Unknown typeId in eval base");if(t.rootType.hasValue&&!t.rootType.canExpand&&t)return O(this.callFrame,this.#p,o,t,[],this.#h);const r=await H.getInspectableAddress(this.callFrame,this.#p,t,[],this.#h);return new H(this.callFrame,this.#p,o,t,[],this.#h,r)}async getEvalBaseFromObject(e){const{objectId:t}=e;if(!e||!this.formatterTag)return null;const{className:o,symbol:r}=this.formatterTag;if(o!==e.className)return null;const i=await this.debuggerModel().target().runtimeAgent().invoke_callFunctionOn({functionDeclaration:"function(sym) { return this[sym]; }",objectId:t,arguments:[{objectId:r}]}),{result:s}=i;if(!s||"undefined"===s.type)return null;const n=new x(this.callFrame,this.#g,this.#p,s,null,this.#h,void 0),{payload:a,rootType:c}=await n.findProperties("payload","rootType");if(void 0===a||void 0===c)return null;const u=await async function(e,t){if(void 0!==t.value)return t.value;const o=await e.debuggerModel.target().runtimeAgent().invoke_callFunctionOn({functionDeclaration:"function() { return this; }",objectId:t.objectId,returnByValue:!0}),{result:r}=o;return r?r.value:void 0}(this.callFrame,a),{typeId:d}=await c.findProperties("typeId");if(void 0===u||void 0===d)return null;const l=this.#g.typeMap.get(d.value);return l?{payload:u,rootType:l.typeInfo}:null}}class W extends Error{exception;exceptionDetails;constructor(e,t){const{description:o}=t.exception||{};super(o||t.text),this.exception=e,this.exceptionDetails=t}static makeLocal(e,t){const o={type:"object",subtype:"error",description:t},r={text:"Uncaught",exceptionId:-1,columnNumber:0,lineNumber:0,exception:o},i=e.debuggerModel.runtimeModel().createRemoteObject(o);return new W(i,r)}}class H extends B{#m;#p;#g;#S;#b;#h;constructor(e,t,o,r,i,s,n){const a=o.typeInfo.typeNames[0]||"<anonymous>",c="object";super(e,void 0,c,void 0,null,n,void 0,a,void 0,void 0,a),this.#m=c,this.#p=t,this.#g=o,this.#S=r,this.#b=i,this.hasChildrenInternal=!0,this.#h=s}get type(){return this.#m}get sourceType(){return this.#g}async expandMember(e,t){const o=this.#b.concat(t);if(e.typeInfo.hasValue&&!e.typeInfo.canExpand&&this.#S)return O(this.callFrame,this.#p,e,this.#S,o,this.#h);const r=void 0!==this.inspectableAddress?this.inspectableAddress+t.offset:void 0;return new H(this.callFrame,this.#p,e,this.#S,o,this.#h,r)}static async getInspectableAddress(e,t,o,r,i){if(!o)return;const s=await t.getInspectableAddress({base:o,field:r});if(!s.js)return;const n=await e.debuggerModel.target().debuggerAgent().invoke_evaluateOnCallFrame({callFrameId:e.id,expression:s.js,objectGroup:i.objectGroup,includeCommandLineAPI:i.includeCommandLineAPI,silent:i.silent,returnByValue:!0,generatePreview:i.generatePreview,throwOnSideEffect:i.throwOnSideEffect,timeout:i.timeout}),a=n.getError();if(a)throw new Error(a);const{result:c,exceptionDetails:u}=n;if(u)throw new W(e.debuggerModel.runtimeModel().createRemoteObject(c),u);const d=c.value;if(Number.isSafeInteger(d)&&!(d<0))return d;console.error(`Inspectable address is not a positive, safe integer: ${d}`)}async doGetProperties(e,t,o){const{typeInfo:r}=this.#g;if(t||!r.canExpand)return{properties:[],internalProperties:[]};if(r.members.length>0){if(r.arraySize>0){const{typeId:e}=this.#g.typeInfo.members[0],t=[],o=this.#g.members[0];for(let s=0;s<r.arraySize;++s){const r=`${s}`,n={name:r,typeId:e,offset:o.typeInfo.size*s};t.push(new i.RemoteObject.RemoteObjectProperty(r,await this.expandMember(o,n),!1,!1,!0,!1))}return{properties:t,internalProperties:[]}}const e=Promise.all(this.#g.members.map((async(e,t)=>{const o=this.#g.typeInfo.members[t],r=await this.expandMember(e,o),s=o.name||"";return new i.RemoteObject.RemoteObjectProperty(s,r,!1,!1,!0,!1)})));return{properties:await e,internalProperties:[]}}return{properties:[],internalProperties:[]}}}class _ extends i.RemoteObject.LocalJSONObject{constructor(e){super(e)}get description(){return this.type}get type(){return"namespace"}}class z extends i.RemoteObject.RemoteObjectImpl{variables;#f;#p;stopId;constructor(e,t,o){super(e.debuggerModel.runtimeModel(),void 0,"object",void 0,null),this.variables=[],this.#f=e,this.#p=o,this.stopId=t}async doGetProperties(e,t,o){if(t)return{properties:[],internalProperties:[]};const r=[],s={};function n(e,t){return new i.RemoteObject.RemoteObjectProperty(e,t,!1,!1,!0,!1)}for(const e of this.variables){let t;try{const o=await this.#p.evaluate(e.name,D(this.#f),this.stopId);o&&(t=new K(this.#f,o,this.#p)),t||(t=await A(this.#f,this.#p,e.name,{generatePreview:!1,includeCommandLineAPI:!0,objectGroup:"backtrace",returnByValue:!1,silent:!1}))}catch(e){console.warn(e),t=new i.RemoteObject.LocalJSONObject(void 0)}if(e.nestedName&&e.nestedName.length>1){let o=s;for(let t=0;t<e.nestedName.length-1;t++){const r=e.nestedName[t];let i=o[r];i||(i=new _({}),o[r]=i),o=i.value}o[e.nestedName[e.nestedName.length-1]]=t}else r.push(n(e.name,t))}for(const e in s)r.push(n(e,s[e]));return{properties:r,internalProperties:[]}}}class V{#L;#M;#C;#I;#v;#w;#y;constructor(e,t,o,r,i,s){if(i&&"data:"!==new URL(i).protocol)throw new Error("The icon must be a data:-URL");this.#L=e,this.#M=o,this.#C=r,this.#I=i,this.#v=new z(e,t,s),this.#w=null,this.#y=null}async getVariableValue(e){for(let t=0;t<this.#v.variables.length;++t){if(this.#v.variables[t].name!==e)continue;const o=await this.#v.getAllProperties(!1,!1);if(!o.properties)continue;const{value:r}=o.properties[t];if(r)return r}return null}callFrame(){return this.#L}type(){return this.#M}typeName(){return this.#C}name(){}startLocation(){return this.#w}endLocation(){return this.#y}object(){return this.#v}description(){return""}icon(){return this.#I}}class K extends i.RemoteObject.RemoteObject{extensionObject;plugin;callFrame;constructor(e,t,o){super(),this.extensionObject=t,this.plugin=o,this.callFrame=e}get linearMemoryAddress(){return this.extensionObject.linearMemoryAddress}get linearMemorySize(){return this.extensionObject.linearMemorySize}get objectId(){return this.extensionObject.objectId}get type(){return"array"===this.extensionObject.type||"null"===this.extensionObject.type?"object":this.extensionObject.type}get subtype(){if("array"===this.extensionObject.type||"null"===this.extensionObject.type)return this.extensionObject.type}get value(){return this.extensionObject.value}unserializableValue(){}get description(){return this.extensionObject.description}set description(e){}get hasChildren(){return this.extensionObject.hasChildren}get preview(){}get className(){return this.extensionObject.className??null}arrayLength(){return 0}arrayBufferByteLength(){return 0}getOwnProperties(e,t){return this.getAllProperties(!1,e,t)}async getAllProperties(e,t,r){const{objectId:s}=this.extensionObject;if(s){o(this.plugin.getProperties);return{properties:(await this.plugin.getProperties(s)).map((e=>new i.RemoteObject.RemoteObjectProperty(e.name,new K(this.callFrame,e.value,this.plugin)))),internalProperties:null}}return{properties:null,internalProperties:null}}release(){const{objectId:e}=this.extensionObject;e&&(o(this.plugin.releaseObject),this.plugin.releaseObject(e))}debuggerModel(){return this.callFrame.debuggerModel}runtimeModel(){return this.callFrame.debuggerModel.runtimeModel()}}class G{#R;#o;#T;#k;#F;callFrameByStopId=new Map;stopIdByCallFrame=new Map;nextStopId=0n;constructor(e,t,o){this.#R=t,this.#o=o,this.#T=[],this.#k=new Map,e.observeModels(i.DebuggerModel.DebuggerModel,this),this.#F=new Map}async evaluateOnCallFrame(e,t){const{script:o}=e,{expression:r,returnByValue:i,throwOnSideEffect:s}=t,{plugin:n}=await this.rawModuleIdAndPluginForScript(o);if(!n)return null;const a=D(e);if(0===(await n.rawLocationToSourceLocation(a)).length)return null;if(i)return{error:"Cannot return by value"};if(s)return{error:"Cannot guarantee side-effect freedom"};try{const o=await n.evaluate(r,a,this.stopIdForCallFrame(e));if(!o){return{object:await A(e,n,r,t),exceptionDetails:void 0}}return{object:new K(e,o,n),exceptionDetails:void 0}}catch(t){if(t instanceof W){const{exception:e,exceptionDetails:o}=t;return{object:e,exceptionDetails:o}}const{exception:o,exceptionDetails:r}=W.makeLocal(e,t.message);return{object:o,exceptionDetails:r}}}stopIdForCallFrame(e){let t=this.stopIdByCallFrame.get(e);return void 0!==t||(t=this.nextStopId++,this.stopIdByCallFrame.set(e,t),this.callFrameByStopId.set(t,e)),t}callFrameForStopId(e){return this.callFrameByStopId.get(e)}expandCallFrames(e){return Promise.all(e.map((async e=>{const t=await this.getFunctionInfo(e.script,e.location());if(t){if("frames"in t&&t.frames.length)return t.frames.map((({name:t},o)=>e.createVirtualCallFrame(o,t)));if("missingSymbolFiles"in t&&t.missingSymbolFiles.length){const o=t.missingSymbolFiles,r=j(U.debugSymbolsIncomplete,{PH1:e.functionName});e.setMissingDebugInfoDetails({details:r,resources:o})}else e.setMissingDebugInfoDetails({resources:[],details:j(U.failedToLoadDebugSymbolsForFunction,{PH1:e.functionName})})}return e}))).then((e=>e.flat()))}modelAdded(e){this.#k.set(e,new $(e,this.#R)),e.addEventListener(i.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),e.addEventListener(i.DebuggerModel.Events.ParsedScriptSource,this.parsedScriptSource,this),e.addEventListener(i.DebuggerModel.Events.DebuggerResumed,this.debuggerResumed,this),e.setEvaluateOnCallFrameCallback(this.evaluateOnCallFrame.bind(this)),e.setExpandCallFramesCallback(this.expandCallFrames.bind(this))}modelRemoved(t){t.removeEventListener(i.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),t.removeEventListener(i.DebuggerModel.Events.ParsedScriptSource,this.parsedScriptSource,this),t.removeEventListener(i.DebuggerModel.Events.DebuggerResumed,this.debuggerResumed,this),t.setEvaluateOnCallFrameCallback(null),t.setExpandCallFramesCallback(null);const o=this.#k.get(t);o&&(o.dispose(),this.#k.delete(t)),this.#F.forEach(((o,r)=>{const i=o.scripts.filter((e=>e.debuggerModel!==t));0===i.length?(o.plugin.removeRawModule(r).catch((t=>{e.Console.Console.instance().error(j(U.errorInDebuggerLanguagePlugin,{PH1:t.message}))})),this.#F.delete(r)):o.scripts=i}))}globalObjectCleared(e){const t=e.data;this.modelRemoved(t),this.modelAdded(t)}addPlugin(e){this.#T.push(e);for(const e of this.#k.keys())for(const t of e.scripts())this.hasPluginForScript(t)||this.parsedScriptSource({data:t})}removePlugin(e){this.#T=this.#T.filter((t=>t!==e));const t=new Set;this.#F.forEach(((o,r)=>{o.plugin===e&&(o.scripts.forEach((e=>t.add(e))),this.#F.delete(r))}));for(const e of t){this.#k.get(e.debuggerModel).removeScript(e),this.parsedScriptSource({data:e})}}hasPluginForScript(e){const t=E(e),o=this.#F.get(t);return void 0!==o&&o.scripts.includes(e)}async rawModuleIdAndPluginForScript(e){const t=E(e),o=this.#F.get(t);return o&&(await o.addRawModulePromise,o===this.#F.get(t))?{rawModuleId:t,plugin:o.plugin}:{rawModuleId:t,plugin:null}}uiSourceCodeForURL(e,t){const o=this.#k.get(e);return o?o.getProject().uiSourceCodeForURL(t):null}async rawLocationToUILocation(t){const o=t.script();if(!o)return null;const{rawModuleId:r,plugin:i}=await this.rawModuleIdAndPluginForScript(o);if(!i)return null;const s={rawModuleId:r,codeOffset:t.columnNumber-(o.codeOffset()||0),inlineFrameIndex:t.inlineFrameIndex};try{const e=await i.rawLocationToSourceLocation(s);for(const t of e){const e=this.uiSourceCodeForURL(o.debuggerModel,t.sourceFileURL);if(e)return e.uiLocation(t.lineNumber,t.columnNumber>=0?t.columnNumber:void 0)}}catch(t){e.Console.Console.instance().error(j(U.errorInDebuggerLanguagePlugin,{PH1:t.message}))}return null}uiLocationToRawLocationRanges(t,o,r=-1){const s=[];return this.scriptsForUISourceCode(t).forEach((e=>{const n=E(e),a=this.#F.get(n);if(!a)return;const{plugin:c}=a;s.push(async function(e,s,n){const a={rawModuleId:e,sourceFileURL:t.url(),lineNumber:o,columnNumber:r},c=await s.sourceLocationToRawLocation(a);if(!c)return[];return c.map((e=>({start:new i.DebuggerModel.Location(n.debuggerModel,n.scriptId,0,Number(e.startOffset)+(n.codeOffset()||0)),end:new i.DebuggerModel.Location(n.debuggerModel,n.scriptId,0,Number(e.endOffset)+(n.codeOffset()||0))})))}(n,c,e))})),0===s.length?Promise.resolve(null):Promise.all(s).then((e=>e.flat())).catch((t=>(e.Console.Console.instance().error(j(U.errorInDebuggerLanguagePlugin,{PH1:t.message})),null)))}async uiLocationToRawLocations(e,t,o){const r=await this.uiLocationToRawLocationRanges(e,t,o);return r?r.map((({start:e})=>e)):null}scriptsForUISourceCode(e){for(const t of this.#k.values()){const o=t.uiSourceCodeToScripts.get(e);if(o)return o}return[]}setDebugInfoURL(e,t){this.hasPluginForScript(e)||(e.debugSymbols={type:"ExternalDWARF",externalURL:t},this.parsedScriptSource({data:e}),e.debuggerModel.setDebugInfoURL(e,t))}parsedScriptSource(t){const o=t.data;if(o.sourceURL)for(const t of this.#T){if(!t.handleScript(o))continue;const r=E(o);let i=this.#F.get(r);if(i)i.scripts.push(o);else{const s=(async()=>{const s=e.Console.Console.instance(),n=o.sourceURL,a=o.debugSymbols&&o.debugSymbols.externalURL||"";a?s.log(j(U.loadingDebugSymbolsForVia,{PH1:t.name,PH2:n,PH3:a})):s.log(j(U.loadingDebugSymbolsFor,{PH1:t.name,PH2:n}));try{const e=!a&&n.startsWith("wasm://")?await o.getWasmBytecode():void 0,c=await t.addRawModule(r,a,{url:n,code:e});if(i!==this.#F.get(r))return[];if("missingSymbolFiles"in c)return{missingSymbolFiles:c.missingSymbolFiles};const u=c;return 0===u.length?s.warn(j(U.loadedDebugSymbolsForButDidnt,{PH1:t.name,PH2:n})):s.log(j(U.loadedDebugSymbolsForFound,{PH1:t.name,PH2:n,PH3:u.length})),u}catch(e){return s.error(j(U.failedToLoadDebugSymbolsFor,{PH1:t.name,PH2:n,PH3:e.message})),this.#F.delete(r),[]}})();i={rawModuleId:r,plugin:t,scripts:[o],addRawModulePromise:s},this.#F.set(r,i)}return void i.addRawModulePromise.then((e=>{if(!("missingSymbolFiles"in e)&&o.debuggerModel.scriptForId(o.scriptId)===o){const t=this.#k.get(o.debuggerModel);t&&(t.addSourceFiles(o,e),this.#o.updateLocations(o))}}))}}debuggerResumed(e){const t=Array.from(this.callFrameByStopId.values()).filter((t=>t.debuggerModel===e.data));for(const e of t){const t=this.stopIdByCallFrame.get(e);o(t),this.stopIdByCallFrame.delete(e),this.callFrameByStopId.delete(t)}}getSourcesForScript(e){const t=E(e),o=this.#F.get(t);return o?o.addRawModulePromise:Promise.resolve(void 0)}async resolveScopeChain(t){const o=t.script,{rawModuleId:r,plugin:i}=await this.rawModuleIdAndPluginForScript(o);if(!i)return null;const s={rawModuleId:r,codeOffset:t.location().columnNumber-(o.codeOffset()||0),inlineFrameIndex:t.inlineFrameIndex},n=this.stopIdForCallFrame(t);try{if(0===(await i.rawLocationToSourceLocation(s)).length)return null;const e=new Map,o=await i.listVariablesInScope(s);for(const r of o||[]){let o=e.get(r.scope);if(!o){const{type:s,typeName:a,icon:c}=await i.getScopeInfo(r.scope);o=new V(t,n,s,a,c,i),e.set(r.scope,o)}o.object().variables.push(r)}return Array.from(e.values())}catch(t){return e.Console.Console.instance().error(j(U.errorInDebuggerLanguagePlugin,{PH1:t.message})),null}}async getFunctionInfo(t,o){const{rawModuleId:r,plugin:i}=await this.rawModuleIdAndPluginForScript(t);if(!i)return null;const s={rawModuleId:r,codeOffset:o.columnNumber-(t.codeOffset()||0),inlineFrameIndex:0};try{return await i.getFunctionInfo(s)}catch(t){return e.Console.Console.instance().warn(j(U.errorInDebuggerLanguagePlugin,{PH1:t.message})),{frames:[]}}}async getInlinedFunctionRanges(t){const o=t.script();if(!o)return[];const{rawModuleId:r,plugin:s}=await this.rawModuleIdAndPluginForScript(o);if(!s)return[];const n={rawModuleId:r,codeOffset:t.columnNumber-(o.codeOffset()||0)};try{return(await s.getInlinedFunctionRanges(n)).map((e=>({start:new i.DebuggerModel.Location(o.debuggerModel,o.scriptId,0,Number(e.startOffset)+(o.codeOffset()||0)),end:new i.DebuggerModel.Location(o.debuggerModel,o.scriptId,0,Number(e.endOffset)+(o.codeOffset()||0))})))}catch(t){return e.Console.Console.instance().warn(j(U.errorInDebuggerLanguagePlugin,{PH1:t.message})),[]}}async getInlinedCalleesRanges(t){const o=t.script();if(!o)return[];const{rawModuleId:r,plugin:s}=await this.rawModuleIdAndPluginForScript(o);if(!s)return[];const n={rawModuleId:r,codeOffset:t.columnNumber-(o.codeOffset()||0)};try{return(await s.getInlinedCalleesRanges(n)).map((e=>({start:new i.DebuggerModel.Location(o.debuggerModel,o.scriptId,0,Number(e.startOffset)+(o.codeOffset()||0)),end:new i.DebuggerModel.Location(o.debuggerModel,o.scriptId,0,Number(e.endOffset)+(o.codeOffset()||0))})))}catch(t){return e.Console.Console.instance().warn(j(U.errorInDebuggerLanguagePlugin,{PH1:t.message})),[]}}async getMappedLines(e){const t=await Promise.all(this.scriptsForUISourceCode(e).map((e=>this.rawModuleIdAndPluginForScript(e))));let o=null;for(const{rawModuleId:r,plugin:i}of t){if(!i)continue;const t=await i.getMappedLines(r,e.url());void 0!==t&&(null===o?o=new Set(t):t.forEach((e=>o.add(e))))}return o}}class ${project;uiSourceCodeToScripts;constructor(e,t){this.project=new l(t,"language_plugins::"+e.target().id(),s.Workspace.projectTypes.Network,"",!1),y.setTargetForProject(this.project,e.target()),this.uiSourceCodeToScripts=new Map}addSourceFiles(t,o){const r=t.createPageResourceLoadInitiator();for(const s of o){let o=this.project.uiSourceCodeForURL(s);if(o){const e=this.uiSourceCodeToScripts.get(o);e.includes(t)||e.push(t)}else{o=this.project.createUISourceCode(s,e.ResourceType.resourceTypes.SourceMapScript),y.setInitialFrameAttribution(o,t.frameId),this.uiSourceCodeToScripts.set(o,[t]);const n=new i.CompilerSourceMappingContentProvider.CompilerSourceMappingContentProvider(s,e.ResourceType.resourceTypes.SourceMapScript,r),a=e.ResourceType.ResourceType.mimeFromURL(s)||"text/javascript";this.project.addUISourceCodeWithProvider(o,n,null,a)}}}removeScript(e){this.uiSourceCodeToScripts.forEach(((t,o)=>{0===(t=t.filter((t=>t!==e))).length?(this.uiSourceCodeToScripts.delete(o),this.project.removeUISourceCode(o.url())):this.uiSourceCodeToScripts.set(o,t)}))}dispose(){this.project.dispose()}getProject(){return this.project}}var q=Object.freeze({__proto__:null,ValueNode:B,SourceScope:V,ExtensionRemoteObject:K,DebuggerLanguagePluginManager:G});class J{#o;#U;#c;#P;#j;constructor(e,t,o){Y.add(this),this.#o=o,this.#U=new l(t,"debugger:"+e.target().id(),s.Workspace.projectTypes.Debugger,"",!0),this.#c=[e.addEventListener(i.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),e.addEventListener(i.DebuggerModel.Events.ParsedScriptSource,this.parsedScriptSource,this),e.addEventListener(i.DebuggerModel.Events.DiscardedAnonymousScriptSource,this.discardedScriptSource,this)],this.#P=new Map,this.#j=new Map}static createV8ScriptURL(t){const o=e.ParsedURL.ParsedURL.extractName(t.sourceURL);return"debugger:///VM"+t.scriptId+(o?" "+o:"")}static scriptForUISourceCode(e){for(const t of Y){const o=t.#P.get(e);if(void 0!==o)return o}return null}uiSourceCodeForScript(e){return this.#j.get(e)??null}rawLocationToUILocation(e){const t=e.script();if(!t)return null;const o=this.#j.get(t);if(!o)return null;const{lineNumber:r,columnNumber:i}=t.rawLocationToRelativeLocation(e);return o.uiLocation(r,i)}uiLocationToRawLocations(e,t,o){const r=this.#P.get(e);return r?(({lineNumber:t,columnNumber:o}=r.relativeLocationToRawLocation({lineNumber:t,columnNumber:o})),[r.debuggerModel.createRawLocation(r,t,o??0)]):[]}parsedScriptSource(t){const o=t.data,r=J.createV8ScriptURL(o),i=this.#U.createUISourceCode(r,e.ResourceType.resourceTypes.Script);this.#P.set(i,o),this.#j.set(o,i),this.#U.addUISourceCodeWithProvider(i,o,null,"text/javascript"),this.#o.updateLocations(o)}discardedScriptSource(e){const t=e.data,o=this.#j.get(t);void 0!==o&&(this.#j.delete(t),this.#P.delete(o),this.#U.removeUISourceCode(o.url()))}globalObjectCleared(){this.#j.clear(),this.#P.clear(),this.#U.reset()}dispose(){Y.delete(this),e.EventTarget.removeEventListeners(this.#c),this.globalObjectCleared(),this.#U.dispose()}}const Y=new Set;var Q=Object.freeze({__proto__:null,DefaultScriptMapping:J});class X{#N;#E;#D;constructor(e,t){this.#N=e,this.#E=t,this.#E.add(this),this.#D=null}async update(){this.#N&&(this.#D?await this.#D.then((()=>this.update())):(this.#D=this.#N(this),await this.#D,this.#D=null))}async uiLocation(){throw"Not implemented"}dispose(){this.#E.delete(this),this.#N=null}isDisposed(){return!this.#E.has(this)}async isIgnoreListed(){throw"Not implemented"}}class Z{#B;constructor(){this.#B=new Set}add(e){this.#B.add(e)}delete(e){this.#B.delete(e)}has(e){return this.#B.has(e)}disposeAll(){for(const e of this.#B)e.dispose()}}var ee=Object.freeze({__proto__:null,LiveLocationWithPool:X,LiveLocationPool:Z});function te(e){for(const t of i.TargetManager.TargetManager.instance().models(i.ResourceTreeModel.ResourceTreeModel)){const o=t.resourceForURL(e);if(o)return o}return null}function oe(e,t,o){const r=e.model(i.ResourceTreeModel.ResourceTreeModel);if(!r)return null;const s=r.frameForId(t);return s?re(s.resourceForURL(o)):null}function re(e){return!e||"number"!=typeof e.contentSize()&&!e.lastModified()?null:new s.UISourceCode.UISourceCodeMetadata(e.lastModified(),e.contentSize())}var ie=Object.freeze({__proto__:null,resourceForURL:te,displayNameForURL:function(o){if(!o)return"";const r=te(o);if(r)return r.displayName;const n=s.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(o);if(n)return n.displayName();const a=i.TargetManager.TargetManager.instance().inspectedURL();if(!a)return t.StringUtilities.trimURL(o,"");const c=e.ParsedURL.ParsedURL.fromString(a);if(!c)return o;const u=c.lastPathComponent,d=a.indexOf(u);if(-1!==d&&d+u.length===a.length){const e=a.substring(0,d);if(o.startsWith(e))return o.substring(d)}const l=t.StringUtilities.trimURL(o,c.host);return"/"===l?c.host+"/":l},metadataForURL:oe,resourceMetadata:re});const se={liveEditFailed:"`LiveEdit` failed: {PH1}",liveEditCompileFailed:"`LiveEdit` compile failed: {PH1}"},ne=a.i18n.registerUIStrings("models/bindings/ResourceScriptMapping.ts",se),ae=a.i18n.getLocalizedString.bind(void 0,ne);class ce{debuggerModel;#R;debuggerWorkspaceBinding;#A;#u;#j;#c;constructor(e,t,o){this.debuggerModel=e,this.#R=t,this.debuggerWorkspaceBinding=o,this.#A=new Map,this.#u=new Map,this.#j=new Map;const r=e.runtimeModel();this.#c=[this.debuggerModel.addEventListener(i.DebuggerModel.Events.ParsedScriptSource,(e=>this.addScript(e.data)),this),this.debuggerModel.addEventListener(i.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),r.addEventListener(i.RuntimeModel.Events.ExecutionContextDestroyed,this.executionContextDestroyed,this),r.target().targetManager().addEventListener(i.TargetManager.Events.InspectedURLChanged,this.inspectedURLChanged,this)]}project(e){const t=(e.isContentScript()?"js:extensions:":"js::")+this.debuggerModel.target().id()+":"+e.frameId;let o=this.#u.get(t);if(!o){const r=e.isContentScript()?s.Workspace.projectTypes.ContentScripts:s.Workspace.projectTypes.Network;o=new l(this.#R,t,r,"",!1),y.setTargetForProject(o,this.debuggerModel.target()),this.#u.set(t,o)}return o}uiSourceCodeForScript(e){return this.#j.get(e)??null}rawLocationToUILocation(e){const t=e.script();if(!t)return null;const o=this.#j.get(t);if(!o)return null;const r=this.#A.get(o);if(!r)return null;if(r.hasDivergedFromVM()&&!r.isMergingToVM()||r.isDivergingFromVM())return null;if(!r.hasScripts([t]))return null;const{lineNumber:i,columnNumber:s=0}=e;return o.uiLocation(i,s)}uiLocationToRawLocations(e,t,o){const r=this.#A.get(e);if(!r)return[];const{script:i}=r;return i?[this.debuggerModel.createRawLocation(i,t,o)]:[]}inspectedURLChanged(e){for(let t=this.debuggerModel.target();t!==e.data;t=t.parentTarget())if(null===t)return;for(const e of Array.from(this.#j.keys()))this.removeScript(e),this.addScript(e)}addScript(t){if(t.isLiveEdit())return;let o=t.sourceURL;if(!o)return;if(t.hasSourceURL)o=i.SourceMapManager.SourceMapManager.resolveRelativeSourceURL(t.debuggerModel.target(),o);else{if(t.isInlineScript())return;if(t.isContentScript()){if(!new e.ParsedURL.ParsedURL(o).isValid)return}}const r=this.project(t),s=r.uiSourceCodeForURL(o);if(s){const e=this.#A.get(s);e&&e.script&&this.removeScript(e.script)}const n=t.originalContentProvider(),a=r.createUISourceCode(o,n.contentType());y.setInitialFrameAttribution(a,t.frameId);const c=oe(this.debuggerModel.target(),t.frameId,o),u=new ue(this,a,[t]);this.#A.set(a,u),this.#j.set(t,a);const d=t.isWasm()?"application/wasm":"text/javascript";r.addUISourceCodeWithProvider(a,n,c,d),this.debuggerWorkspaceBinding.updateLocations(t)}scriptFile(e){return this.#A.get(e)||null}removeScript(e){const t=this.#j.get(e);if(!t)return;const o=this.#A.get(t);o&&o.dispose(),this.#A.delete(t),this.#j.delete(e);t.project().removeUISourceCode(t.url()),this.debuggerWorkspaceBinding.updateLocations(e)}executionContextDestroyed(e){const t=e.data;for(const e of this.debuggerModel.scriptsForExecutionContext(t))this.removeScript(e)}globalObjectCleared(){for(const e of this.#j.keys())this.removeScript(e)}resetForTest(){this.globalObjectCleared()}dispose(){e.EventTarget.removeEventListeners(this.#c),this.globalObjectCleared();for(const e of this.#u.values())e.removeProject();this.#u.clear()}}class ue extends e.ObjectWrapper.ObjectWrapper{#O;#x;scriptInternal;#W;#H;#_;#z;constructor(e,t,o){super(),console.assert(o.length>0),this.#O=e,this.#x=t,this.#x.contentType().isScript()&&(this.scriptInternal=o[o.length-1]),this.#x.addEventListener(s.UISourceCode.Events.WorkingCopyChanged,this.workingCopyChanged,this),this.#x.addEventListener(s.UISourceCode.Events.WorkingCopyCommitted,this.workingCopyCommitted,this)}hasScripts(e){return Boolean(this.scriptInternal)&&this.scriptInternal===e[0]}isDiverged(){if(this.#x.isDirty())return!0;if(!this.scriptInternal)return!1;if(void 0===this.#W||null===this.#W)return!1;const e=this.#x.workingCopy();if(!e)return!1;if(!e.startsWith(this.#W.trimEnd()))return!0;const t=this.#x.workingCopy().substr(this.#W.length);return Boolean(t.length)&&!t.match(i.Script.sourceURLRegex)}workingCopyChanged(){this.update()}workingCopyCommitted(){if(this.#x.project().canSetFileContent())return;if(!this.scriptInternal)return;const e=fe.instance().breakpointLocationsForUISourceCode(this.#x).map((e=>e.breakpoint)),t=this.#x.workingCopy();this.scriptInternal.editSource(t).then((({changed:o,status:r,exceptionDetails:i})=>{this.scriptSourceWasSet(t,e,o,r,i)}))}async scriptSourceWasSet(t,o,r,i,n){if("Ok"===i&&(this.#W=t),await this.update(),"Ok"===i&&r)return void await Promise.all(o.map((e=>e.refreshInDebugger())));if(!n)return void e.Console.Console.instance().addMessage(ae(se.liveEditFailed,{PH1:function(e){switch(e){case"BlockedByActiveFunction":return"Functions that are on the stack (currently being executed) can not be edited";case"BlockedByActiveGenerator":return"Async functions/generators that are active can not be edited";case"CompileError":case"Ok":throw new Error("Compile errors and Ok status must not be reported on the console")}}(i)}),e.Console.MessageLevel.Warning);const a=ae(se.liveEditCompileFailed,{PH1:n.text});this.#x.addLineMessage(s.UISourceCode.Message.Level.Error,a,n.lineNumber,n.columnNumber)}async update(){this.isDiverged()&&!this.#_?await this.divergeFromVM():!this.isDiverged()&&this.#_&&await this.mergeToVM()}async divergeFromVM(){this.scriptInternal&&(this.#H=!0,await this.#O.debuggerWorkspaceBinding.updateLocations(this.scriptInternal),this.#H=void 0,this.#_=!0,this.dispatchEventToListeners("DidDivergeFromVM"))}async mergeToVM(){this.scriptInternal&&(this.#_=void 0,this.#z=!0,await this.#O.debuggerWorkspaceBinding.updateLocations(this.scriptInternal),this.#z=void 0,this.dispatchEventToListeners("DidMergeToVM"))}hasDivergedFromVM(){return Boolean(this.#_)}isDivergingFromVM(){return Boolean(this.#H)}isMergingToVM(){return Boolean(this.#z)}checkMapping(){this.scriptInternal&&void 0===this.#W?this.scriptInternal.requestContent().then((e=>{this.#W=e.content,this.update().then((()=>this.mappingCheckedForTest()))})):this.mappingCheckedForTest()}mappingCheckedForTest(){}dispose(){this.#x.removeEventListener(s.UISourceCode.Events.WorkingCopyChanged,this.workingCopyChanged,this),this.#x.removeEventListener(s.UISourceCode.Events.WorkingCopyCommitted,this.workingCopyCommitted,this)}addSourceMapURL(e){this.scriptInternal&&this.scriptInternal.debuggerModel.setSourceMapURL(this.scriptInternal,e)}addDebugInfoURL(e){if(!this.scriptInternal)return;const{pluginManager:t}=pe.instance();t&&t.setDebugInfoURL(this.scriptInternal,e)}hasSourceMapURL(){return void 0!==this.scriptInternal&&Boolean(this.scriptInternal.sourceMapURL)}async missingSymbolFiles(){if(!this.scriptInternal)return null;const{pluginManager:e}=this.#O.debuggerWorkspaceBinding;if(!e)return null;const t=await e.getSourcesForScript(this.scriptInternal);return t&&"missingSymbolFiles"in t?t.missingSymbolFiles:null}get script(){return this.scriptInternal||null}get uiSourceCode(){return this.#x}}var de=Object.freeze({__proto__:null,ResourceScriptMapping:ce,ResourceScriptFile:ue});let le;class pe{resourceMapping;#V;#k;#K;pluginManager;#G;constructor(e,t){this.resourceMapping=e,this.#V=[],this.#k=new Map,t.addModelListener(i.DebuggerModel.DebuggerModel,i.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),t.addModelListener(i.DebuggerModel.DebuggerModel,i.DebuggerModel.Events.DebuggerResumed,this.debuggerResumed,this),t.observeModels(i.DebuggerModel.DebuggerModel,this),this.#G=t,this.#K=new Set,this.pluginManager=r.Runtime.experiments.isEnabled("wasmDWARFDebugging")?new G(t,e.workspace,this):null}initPluginManagerForTest(){return r.Runtime.experiments.isEnabled("wasmDWARFDebugging")?this.pluginManager||(this.pluginManager=new G(this.#G,this.resourceMapping.workspace,this)):this.pluginManager=null,this.pluginManager}static instance(e={forceNew:null,resourceMapping:null,targetManager:null}){const{forceNew:t,resourceMapping:o,targetManager:r}=e;if(!le||t){if(!o||!r)throw new Error(`Unable to create DebuggerWorkspaceBinding: resourceMapping and targetManager must be provided: ${(new Error).stack}`);le=new pe(o,r)}return le}static removeInstance(){le=void 0}addSourceMapping(e){this.#V.push(e)}removeSourceMapping(e){const t=this.#V.indexOf(e);-1!==t&&this.#V.splice(t,1)}async computeAutoStepRanges(e,t){function o(e,t){const{start:o,end:r}=t;return o.scriptId===e.scriptId&&(!(e.lineNumber<o.lineNumber||e.lineNumber>r.lineNumber)&&(!(e.lineNumber===o.lineNumber&&e.columnNumber<o.columnNumber)&&!(e.lineNumber===r.lineNumber&&e.columnNumber>=r.columnNumber)))}const r=t.location();if(!r)return[];const s=this.pluginManager;let n=[];if(s){if(e===i.DebuggerModel.StepMode.StepOut)return await s.getInlinedFunctionRanges(r);const t=await s.rawLocationToUILocation(r);if(t)return n=await s.uiLocationToRawLocationRanges(t.uiSourceCode,t.lineNumber,t.columnNumber)||[],n=n.filter((e=>o(r,e))),e===i.DebuggerModel.StepMode.StepOver&&(n=n.concat(await s.getInlinedCalleesRanges(r))),n}const a=this.#k.get(r.debuggerModel)?.compilerMapping;return a?e===i.DebuggerModel.StepMode.StepOut?[]:(n=a.getLocationRangesForSameSourceLocation(r),n=n.filter((e=>o(r,e))),n):[]}modelAdded(e){this.#k.set(e,new ge(e,this)),e.setComputeAutoStepRangesCallback(this.computeAutoStepRanges.bind(this))}modelRemoved(e){e.setComputeAutoStepRangesCallback(null);const t=this.#k.get(e);t&&(t.dispose(),this.#k.delete(e))}async pendingLiveLocationChangesPromise(){await Promise.all(this.#K)}recordLiveLocationChange(e){e.then((()=>{this.#K.delete(e)})),this.#K.add(e)}async updateLocations(e){const t=this.#k.get(e.debuggerModel);if(t){const o=t.updateLocations(e);this.recordLiveLocationChange(o),await o}}async createLiveLocation(e,t,o){const r=this.#k.get(e.debuggerModel);if(!r)return null;const i=r.createLiveLocation(e,t,o);return this.recordLiveLocationChange(i),i}async createStackTraceTopFrameLiveLocation(e,t,o){console.assert(e.length>0);const r=me.createStackTraceTopFrameLocation(e,this,t,o);return this.recordLiveLocationChange(r),r}async createCallFrameLiveLocation(e,t,o){if(!e.script())return null;const r=e.debuggerModel,i=this.createLiveLocation(e,t,o);this.recordLiveLocationChange(i);const s=await i;return s?(this.registerCallFrameLiveLocation(r,s),s):null}async rawLocationToUILocation(e){for(const t of this.#V){const o=t.rawLocationToUILocation(e);if(o)return o}if(this.pluginManager){const t=await this.pluginManager.rawLocationToUILocation(e);if(t)return t}const t=this.#k.get(e.debuggerModel);return t?t.rawLocationToUILocation(e):null}uiSourceCodeForSourceMapSourceURL(e,t,o){const r=this.#k.get(e);return r?r.compilerMapping.uiSourceCodeForURL(t,o):null}async uiSourceCodeForSourceMapSourceURLPromise(e,t,o){return this.uiSourceCodeForSourceMapSourceURL(e,t,o)||this.waitForUISourceCodeAdded(t,e.target())}async uiSourceCodeForDebuggerLanguagePluginSourceURLPromise(e,t){if(this.pluginManager){return this.pluginManager.uiSourceCodeForURL(e,t)||this.waitForUISourceCodeAdded(t,e.target())}return null}uiSourceCodeForScript(e){const t=this.#k.get(e.debuggerModel);return t?t.uiSourceCodeForScript(e):null}waitForUISourceCodeAdded(e,t){return new Promise((o=>{const r=s.Workspace.WorkspaceImpl.instance(),i=r.addEventListener(s.Workspace.Events.UISourceCodeAdded,(n=>{const a=n.data;a.url()===e&&y.targetForUISourceCode(a)===t&&(r.removeEventListener(s.Workspace.Events.UISourceCodeAdded,i.listener),o(a))}))}))}async uiLocationToRawLocations(e,t,o){for(const r of this.#V){const i=r.uiLocationToRawLocations(e,t,o);if(i.length)return i}const r=await(this.pluginManager?.uiLocationToRawLocations(e,t,o));if(r)return r;for(const r of this.#k.values()){const i=r.uiLocationToRawLocations(e,t,o);if(i.length)return i}return[]}uiLocationToRawLocationsForUnformattedJavaScript(e,t,o){console.assert(e.contentType().isScript());const r=[];for(const i of this.#k.values())r.push(...i.uiLocationToRawLocations(e,t,o));return r}async normalizeUILocation(e){const t=await this.uiLocationToRawLocations(e.uiSourceCode,e.lineNumber,e.columnNumber);for(const e of t){const t=await this.rawLocationToUILocation(e);if(t)return t}return e}async getMappedLines(e){for(const t of this.#k.values()){const o=t.getMappedLines(e);if(null!==o)return o}const{pluginManager:t}=this;return t?await t.getMappedLines(e):null}scriptFile(e,t){const o=this.#k.get(t);return o?o.getResourceScriptMapping().scriptFile(e):null}scriptsForUISourceCode(e){const t=new Set;this.pluginManager&&this.pluginManager.scriptsForUISourceCode(e).forEach((e=>t.add(e)));for(const o of this.#k.values()){const r=o.getResourceScriptMapping().scriptFile(e);r&&r.script&&t.add(r.script),o.compilerMapping.scriptsForUISourceCode(e).forEach((e=>t.add(e)))}return[...t]}supportsConditionalBreakpoints(e){if(!this.pluginManager)return!0;return this.pluginManager.scriptsForUISourceCode(e).every((e=>e.isJavaScript()))}globalObjectCleared(e){this.reset(e.data)}reset(e){const t=this.#k.get(e);if(t){for(const e of t.callFrameLocations.values())this.removeLiveLocation(e);t.callFrameLocations.clear()}}resetForTest(e){const t=e.model(i.DebuggerModel.DebuggerModel),o=this.#k.get(t);o&&o.getResourceScriptMapping().resetForTest()}registerCallFrameLiveLocation(e,t){const o=this.#k.get(e);if(o){o.callFrameLocations.add(t)}}removeLiveLocation(e){const t=this.#k.get(e.rawLocation.debuggerModel);t&&t.disposeLocation(e)}debuggerResumed(e){this.reset(e.data)}}class ge{#$;#o;callFrameLocations;#q;#J;#O;compilerMapping;#B;constructor(e,o){this.#$=e,this.#o=o,this.callFrameLocations=new Set;const{workspace:r}=o.resourceMapping;this.#q=new J(e,r,o),this.#J=o.resourceMapping,this.#O=new ce(e,r,o),this.compilerMapping=new T(e,r,o),this.#B=new t.MapUtilities.Multimap,e.setBeforePausedCallback(this.beforePaused.bind(this))}async createLiveLocation(e,t,o){console.assert(""!==e.scriptId);const r=e.scriptId,i=new he(r,e,this.#o,t,o);return this.#B.set(r,i),await i.update(),i}disposeLocation(e){this.#B.delete(e.scriptId,e)}async updateLocations(e){const t=[];for(const o of this.#B.get(e.scriptId))t.push(o.update());await Promise.all(t)}rawLocationToUILocation(e){let t=this.compilerMapping.rawLocationToUILocation(e);return t=t||this.#O.rawLocationToUILocation(e),t=t||this.#J.jsLocationToUILocation(e),t=t||this.#q.rawLocationToUILocation(e),t}uiSourceCodeForScript(e){let t=null;return t=t||this.#O.uiSourceCodeForScript(e),t=t||this.#J.uiSourceCodeForScript(e),t=t||this.#q.uiSourceCodeForScript(e),t}uiLocationToRawLocations(e,t,o=0){let r=this.compilerMapping.uiLocationToRawLocations(e,t,o);return r=r.length?r:this.#O.uiLocationToRawLocations(e,t,o),r=r.length?r:this.#J.uiLocationToJSLocations(e,t,o),r=r.length?r:this.#q.uiLocationToRawLocations(e,t,o),r}getMappedLines(e){let t=this.compilerMapping.getMappedLines(e);return t=t??this.#J.getMappedLines(e),t}beforePaused(e){return Boolean(e.callFrames[0])}dispose(){this.#$.setBeforePausedCallback(null),this.compilerMapping.dispose(),this.#O.dispose(),this.#q.dispose()}getResourceScriptMapping(){return this.#O}}class he extends X{scriptId;rawLocation;#Y;constructor(e,t,o,r,i){super(r,i),this.scriptId=e,this.rawLocation=t,this.#Y=o}async uiLocation(){const e=this.rawLocation;return this.#Y.rawLocationToUILocation(e)}dispose(){super.dispose(),this.#Y.removeLiveLocation(this)}async isIgnoreListed(){const e=await this.uiLocation();return!!e&&b.instance().isUserOrSourceMapIgnoreListedUISourceCode(e.uiSourceCode)}}class me extends X{#Q;#X;#B;constructor(e,t){super(e,t),this.#Q=!0,this.#X=null,this.#B=null}static async createStackTraceTopFrameLocation(e,t,o,r){const i=new me(o,r),s=e.map((e=>t.createLiveLocation(e,i.scheduleUpdate.bind(i),r)));return i.#B=(await Promise.all(s)).filter((e=>Boolean(e))),await i.updateLocation(),i}async uiLocation(){return this.#X?this.#X.uiLocation():null}async isIgnoreListed(){return!!this.#X&&this.#X.isIgnoreListed()}dispose(){if(super.dispose(),this.#B)for(const e of this.#B)e.dispose();this.#B=null,this.#X=null}async scheduleUpdate(){this.#Q||(this.#Q=!0,queueMicrotask((()=>{this.updateLocation()})))}async updateLocation(){if(this.#Q=!1,this.#B&&0!==this.#B.length){this.#X=this.#B[0];for(const e of this.#B)if(!await e.isIgnoreListed()){this.#X=e;break}this.update()}}}var Se=Object.freeze({__proto__:null,DebuggerWorkspaceBinding:pe,Location:he});let be;class fe extends e.ObjectWrapper.ObjectWrapper{storage;#R;targetManager;debuggerWorkspaceBinding;#Z;#ee;#te;#oe;constructor(e,t,o){super(),this.storage=new Ie,this.#R=t,this.targetManager=e,this.debuggerWorkspaceBinding=o,this.#ee=new Map,this.#Z=new Map,this.#te=new Map,this.#R.addEventListener(s.Workspace.Events.UISourceCodeAdded,this.uiSourceCodeAdded,this),this.#R.addEventListener(s.Workspace.Events.UISourceCodeRemoved,this.uiSourceCodeRemoved,this),this.#R.addEventListener(s.Workspace.Events.ProjectRemoved,this.projectRemoved,this),this.targetManager.observeModels(i.DebuggerModel.DebuggerModel,this),this.#oe=[]}static instance(e={forceNew:null,targetManager:null,workspace:null,debuggerWorkspaceBinding:null}){const{forceNew:t,targetManager:o,workspace:r,debuggerWorkspaceBinding:i}=e;if(!be||t){if(!o||!r||!i)throw new Error(`Unable to create settings: targetManager, workspace, and debuggerWorkspaceBinding must be provided: ${(new Error).stack}`);be=new fe(o,r,i)}return be}modelAdded(e){r.Runtime.experiments.isEnabled(r.Runtime.ExperimentName.INSTRUMENTATION_BREAKPOINTS)&&e.setSynchronizeBreakpointsCallback(this.restoreBreakpointsForScript.bind(this))}modelRemoved(e){e.setSynchronizeBreakpointsCallback(null)}addUpdateBindingsCallback(e){this.#oe.push(e)}async copyBreakpoints(e,t){const o=this.storage.breakpointItems(e.url(),e.contentType().name());for(const e of o)await this.setBreakpoint(t,e.lineNumber,e.columnNumber,e.condition,e.enabled,e.isLogpoint,"RESTORED")}async restoreBreakpointsForScript(e){if(!r.Runtime.experiments.isEnabled(r.Runtime.ExperimentName.INSTRUMENTATION_BREAKPOINTS))return;if(!e.sourceURL)return;const t=await this.getUISourceCodeWithUpdatedBreakpointInfo(e);this.#re(e.sourceURL)&&await this.#ie(t);const i=e.debuggerModel,s=await i.sourceMapManager().sourceMapForClientPromise(e);if(s)for(const t of s.sourceURLs())if(this.#re(t)){const o=await this.debuggerWorkspaceBinding.uiSourceCodeForSourceMapSourceURLPromise(i,t,e.isContentScript());await this.#ie(o)}const{pluginManager:n}=this.debuggerWorkspaceBinding;if(n){const t=await n.getSourcesForScript(e);if(Array.isArray(t))for(const e of t)if(this.#re(e)){const t=await this.debuggerWorkspaceBinding.uiSourceCodeForDebuggerLanguagePluginSourceURLPromise(i,e);o(t),await this.#ie(t)}}}async getUISourceCodeWithUpdatedBreakpointInfo(e){const t=this.debuggerWorkspaceBinding.uiSourceCodeForScript(e);return o(t),await this.#se(t),t}async#se(e){if(this.#oe.length>0){const t=[];for(const o of this.#oe)t.push(o(e));await Promise.all(t)}}async#ie(e){this.restoreBreakpoints(e);const t=this.#te.values(),o=Array.from(t).filter((t=>t.uiSourceCodes.has(e)));await Promise.all(o.map((e=>e.updateBreakpoint())))}#re(e){return this.storage.breakpointItems(e).length>0}static getScriptForInlineUiSourceCode(e){const t=J.scriptForUISourceCode(e);return t&&t.isInlineScript()&&!t.hasSourceURL?t:null}static breakpointLocationFromUiLocation(e){const t=e.uiSourceCode,o=fe.getScriptForInlineUiSourceCode(t),{lineNumber:r,columnNumber:i}=o?o.relativeLocationToRawLocation(e):e;return{lineNumber:r,columnNumber:i}}static uiLocationFromBreakpointLocation(e,t,o){const r=fe.getScriptForInlineUiSourceCode(e);return r&&({lineNumber:t,columnNumber:o}=r.rawLocationToRelativeLocation({lineNumber:t,columnNumber:o})),e.uiLocation(t,o)}static isValidPositionInScript(e,t,o){return!o||!(e<o.lineOffset||e>o.endLine)&&(!(e===o.lineOffset&&t&&t<o.columnOffset)&&!(e===o.endLine&&(!t||t>=o.endColumn)))}restoreBreakpoints(e){const t=fe.getScriptForInlineUiSourceCode(e),o=t?.sourceURL??e.url();if(!o)return;const r=e.contentType();this.storage.mute();const i=this.storage.breakpointItems(o,r.name());for(const o of i){const{lineNumber:r,columnNumber:i}=o;fe.isValidPositionInScript(r,i,t)&&this.innerSetBreakpoint(e,r,i,o.condition,o.enabled,o.isLogpoint,"RESTORED")}this.storage.unmute()}uiSourceCodeAdded(e){const t=e.data;this.restoreBreakpoints(t)}uiSourceCodeRemoved(e){const t=e.data;this.removeUISourceCode(t)}projectRemoved(e){const t=e.data;for(const e of t.uiSourceCodes())this.removeUISourceCode(e)}removeUISourceCode(e){this.#ne(e).forEach((t=>t.removeUISourceCode(e)))}async setBreakpoint(t,o,r,i,n,a,c){let u=new s.UISourceCode.UILocation(t,o,r);const d=await this.debuggerWorkspaceBinding.normalizeUILocation(u);d.id()!==u.id()&&(e.Revealer.reveal(d),u=d);const l=fe.breakpointLocationFromUiLocation(u);return this.innerSetBreakpoint(u.uiSourceCode,l.lineNumber,l.columnNumber,i,n,a,c)}innerSetBreakpoint(e,t,o,r,i,s,n){const a=fe.getScriptForInlineUiSourceCode(e)?.sourceURL??e.url(),c=e.contentType().name(),u=Ie.computeId({url:a,resourceTypeName:c,lineNumber:t,columnNumber:o,condition:r,enabled:i,isLogpoint:s});let d=this.#te.get(u);return d?(d.updateState({...d.storageState,condition:r,enabled:i,isLogpoint:s}),d.addUISourceCode(e),d.updateBreakpoint(),d):(d=new Me(this,e,a,t,o,r,i,s,n),this.#te.set(u,d),d)}findBreakpoint(e){const t=this.#ee.get(e.uiSourceCode);return t&&t.get(e.id())||null}addHomeUISourceCode(e,t){let o=this.#Z.get(e);o||(o=new Set,this.#Z.set(e,o)),o.add(t)}removeHomeUISourceCode(e,t){const o=this.#Z.get(e);o&&(o.delete(t),0===o.size&&this.#Z.delete(e))}async possibleBreakpoints(e,t){const{pluginManager:o}=this.debuggerWorkspaceBinding;if(o){const r=await o.uiLocationToRawLocations(e,t.startLine);if(r){const e=[];for(const t of r){const o=await this.debuggerWorkspaceBinding.rawLocationToUILocation(t);o&&e.push(o)}return e}}const r=this.debuggerWorkspaceBinding.uiLocationToRawLocations(e,t.startLine,t.startColumn),i=pe.instance().uiLocationToRawLocations(e,t.endLine,t.endColumn),[n,a]=await Promise.all([r,i]),c=new Map;for(const e of a)c.set(e.debuggerModel,e);let u=null,d=null;for(const e of n){const t=c.get(e.debuggerModel);if(t){u=e,d=t;break}}return u&&d?u.debuggerModel.getPossibleBreakpoints(u,d,!1).then(async function(t){const o=t.map((e=>this.debuggerWorkspaceBinding.rawLocationToUILocation(e))),r=(await Promise.all(o)).filter((t=>t&&t.uiSourceCode===e));if(!r.length)return[];r.sort(s.UISourceCode.UILocation.comparator);let i=r[0];const n=[i];for(const e of r)e.id()!==i.id()&&(n.push(e),i=e);return n}.bind(this)):[]}breakpointLocationsForUISourceCode(e){const t=this.#ee.get(e);return t?Array.from(t.values()):[]}#ne(e){return this.breakpointLocationsForUISourceCode(e).map((e=>e.breakpoint)).concat(Array.from(this.#Z.get(e)??[]))}allBreakpointLocations(){const e=[];for(const t of this.#ee.values())e.push(...t.values());return e}removeBreakpoint(e,t){const o=e.breakpointStorageId();t&&this.storage.removeBreakpoint(o),this.#te.delete(o)}uiLocationAdded(e,t){let o=this.#ee.get(t.uiSourceCode);o||(o=new Map,this.#ee.set(t.uiSourceCode,o));const r=new ve(e,t);o.set(t.id(),r),this.dispatchEventToListeners(Le.BreakpointAdded,r)}uiLocationRemoved(e,t){const o=this.#ee.get(t.uiSourceCode);if(!o)return;const r=o.get(t.id())||null;r&&(o.delete(t.id()),0===o.size&&this.#ee.delete(t.uiSourceCode),this.dispatchEventToListeners(Le.BreakpointRemoved,r))}supportsConditionalBreakpoints(e){return this.debuggerWorkspaceBinding.supportsConditionalBreakpoints(e)}}var Le;!function(e){e.BreakpointAdded="breakpoint-added",e.BreakpointRemoved="breakpoint-removed"}(Le||(Le={}));class Me{breakpointManager;#ae;uiSourceCodes;#ce;#ue;isRemoved=!1;currentState;#de;constructor(e,t,o,r,s,n,a,c,u){this.breakpointManager=e,this.#ue=u,this.#ae=new Set,this.uiSourceCodes=new Set,this.currentState=null,this.#de=new Map;const d=t.contentType().name();this.updateState({url:o,resourceTypeName:d,lineNumber:r,columnNumber:s,condition:n,enabled:a,isLogpoint:c}),this.addUISourceCode(t),this.breakpointManager.targetManager.observeModels(i.DebuggerModel.DebuggerModel,this)}get origin(){return this.#ue}async refreshInDebugger(){if(!this.isRemoved){const e=Array.from(this.#de.values());await Promise.all(e.map((async e=>(await e.resetBreakpoint(),this.#le(e)))))}}modelAdded(e){const t=this.breakpointManager.debuggerWorkspaceBinding,o=new Ce(e,this,t);this.#de.set(e,o),this.#le(o),e.addEventListener(i.DebuggerModel.Events.DebuggerWasEnabled,this.#pe,this),e.addEventListener(i.DebuggerModel.Events.DebuggerWasDisabled,this.#ge,this)}modelRemoved(e){this.#de.get(e)?.cleanUpAfterDebuggerIsGone(),this.#de.delete(e),this.#he(e)}#he(e){e.removeEventListener(i.DebuggerModel.Events.DebuggerWasEnabled,this.#pe,this),e.removeEventListener(i.DebuggerModel.Events.DebuggerWasDisabled,this.#ge,this)}#pe(e){const t=e.data,o=this.#de.get(t);o&&this.#le(o)}#ge(e){const t=e.data;this.#de.get(t)?.cleanUpAfterDebuggerIsGone()}modelBreakpoint(e){return this.#de.get(e)}addUISourceCode(e){this.uiSourceCodes.has(e)||(this.uiSourceCodes.add(e),this.breakpointManager.addHomeUISourceCode(e,this),this.bound()||this.breakpointManager.uiLocationAdded(this,this.defaultUILocation(e)))}clearUISourceCodes(){this.bound()||this.removeAllUnboundLocations();for(const e of this.uiSourceCodes)this.removeUISourceCode(e)}removeUISourceCode(e){if(this.uiSourceCodes.has(e)&&(this.uiSourceCodes.delete(e),this.breakpointManager.removeHomeUISourceCode(e,this),this.bound()||this.breakpointManager.uiLocationRemoved(this,this.defaultUILocation(e))),this.bound()){for(const t of this.#ae)t.uiSourceCode===e&&(this.#ae.delete(t),this.breakpointManager.uiLocationRemoved(this,t));this.bound()||this.isRemoved||this.addAllUnboundLocations()}}url(){return this.#ce.url}lineNumber(){return this.#ce.lineNumber}columnNumber(){return this.#ce.columnNumber}uiLocationAdded(e){this.isRemoved||(this.bound()||this.removeAllUnboundLocations(),this.#ae.add(e),this.breakpointManager.uiLocationAdded(this,e))}uiLocationRemoved(e){this.#ae.has(e)&&(this.#ae.delete(e),this.breakpointManager.uiLocationRemoved(this,e),this.bound()||this.isRemoved||this.addAllUnboundLocations())}enabled(){return this.#ce.enabled}bound(){return 0!==this.#ae.size}hasBoundScript(){for(const e of this.uiSourceCodes)if(e.project().type()===s.Workspace.projectTypes.Network)return!0;return!1}setEnabled(e){this.updateState({...this.#ce,enabled:e})}condition(){return this.#ce.condition}backendCondition(){return this.isLogpoint()?`${we}${this.#ce.condition}${ye}`:this.#ce.condition}setCondition(e,t){this.updateState({...this.#ce,condition:e,isLogpoint:t})}isLogpoint(){return this.#ce.isLogpoint}get storageState(){return this.#ce}updateState(e){this.#ce?.enabled===e.enabled&&this.#ce?.condition===e.condition&&this.#ce?.isLogpoint===e.isLogpoint||(this.#ce=e,this.breakpointManager.storage.updateBreakpoint(this.#ce),this.updateBreakpoint())}async updateBreakpoint(){return this.bound()||(this.removeAllUnboundLocations(),this.isRemoved||this.addAllUnboundLocations()),this.#me()}async remove(e){if(this.getIsRemoved())return;this.isRemoved=!0;const t=!e;for(const e of this.#de.keys())this.#he(e);await this.#me(),this.breakpointManager.removeBreakpoint(this,t),this.breakpointManager.targetManager.unobserveModels(i.DebuggerModel.DebuggerModel,this),this.clearUISourceCodes()}breakpointStorageId(){return Ie.computeId(this.#ce)}defaultUILocation(e){return fe.uiLocationFromBreakpointLocation(e,this.#ce.lineNumber,this.#ce.columnNumber)}removeAllUnboundLocations(){for(const e of this.uiSourceCodes)this.breakpointManager.uiLocationRemoved(this,this.defaultUILocation(e))}addAllUnboundLocations(){for(const e of this.uiSourceCodes)this.breakpointManager.uiLocationAdded(this,this.defaultUILocation(e))}getUiSourceCodes(){return this.uiSourceCodes}getIsRemoved(){return this.isRemoved}async#me(){await Promise.all(Array.from(this.#de.values()).map((e=>this.#le(e))))}async#le(e){const t=await e.scheduleUpdateInDebugger();"ERROR_BACKEND"===t?await this.remove(!0):"ERROR_BREAKPOINT_CLASH"===t&&await this.remove(!1)}}class Ce{#$;#Se;#o;#be;#ae;#fe=new e.Mutex.Mutex;#Le;#Me;#Ce;constructor(e,t,o){this.#$=e,this.#Se=t,this.#o=o,this.#be=new Z,this.#ae=new Map,this.#Le=!1,this.#Me=null,this.#Ce=[]}get currentState(){return this.#Me}resetLocations(){for(const e of this.#ae.values())this.#Se.uiLocationRemoved(e);this.#ae.clear(),this.#be.disposeAll()}async scheduleUpdateInDebugger(){if(!this.#$.debuggerEnabled())return"OK";const e=await this.#fe.acquire();let t="PENDING";for(;"PENDING"===t;)t=await this.#Ie();return e(),t}scriptDiverged(){for(const e of this.#Se.getUiSourceCodes()){const t=this.#o.scriptFile(e,this.#$);if(t&&t.hasDivergedFromVM())return!0}return!1}async#Ie(){if(this.#$.target().isDisposed())return this.cleanUpAfterDebuggerIsGone(),"OK";const e=this.#Se.lineNumber(),t=this.#Se.columnNumber(),o=this.#Se.backendCondition();let i=null;if(!this.#Se.getIsRemoved()&&this.#Se.enabled()&&!this.scriptDiverged()){let s=[];for(const o of this.#Se.getUiSourceCodes()){const{lineNumber:r,columnNumber:i}=fe.uiLocationFromBreakpointLocation(o,e,t);if(s=(await pe.instance().uiLocationToRawLocations(o,r,i)).filter((e=>e.debuggerModel===this.#$)),s.length)break}if(s.length&&s.every((e=>e.script()))){const e=s.map((e=>{const t=e.script();return{url:t.sourceURL,scriptHash:t.hash,lineNumber:e.lineNumber,columnNumber:e.columnNumber}}));i=new Me.State(e,o)}else if(!r.Runtime.experiments.isEnabled(r.Runtime.ExperimentName.INSTRUMENTATION_BREAKPOINTS))if(this.#Se.currentState)i=new Me.State(this.#Se.currentState.positions,o);else{const r={url:this.#Se.url(),scriptHash:"",lineNumber:e,columnNumber:t};i=new Me.State([r],o)}}const s=this.#Ce.length;if(s&&Me.State.equals(i,this.#Me))return"OK";if(this.#Se.currentState=i,s)return await this.resetBreakpoint(),"PENDING";if(!i)return"OK";const{breakpointIds:n,locations:a,serverError:c}=await this.#ve(i),u=c&&this.#$.debuggerEnabled()&&!this.#$.isReadyToPause();if(!n.length&&u)return"PENDING";if(this.#Me=i,this.#Le)return this.#Le=!1,"OK";if(!n.length)return"ERROR_BACKEND";this.#Ce=n,this.#Ce.forEach((e=>this.#$.addBreakpointListener(e,this.breakpointResolved,this)));return(await Promise.all(a.map((e=>this.addResolvedLocation(e))))).includes("ERROR")?"ERROR_BREAKPOINT_CLASH":"OK"}async#ve({positions:e,condition:t}){const o=await Promise.all(e.map((e=>e.url?this.#$.setBreakpointByURL(e.url,e.lineNumber,e.columnNumber,t):this.#$.setBreakpointInAnonymousScript(e.scriptHash,e.lineNumber,e.columnNumber,t)))),r=[];let i=[],s=!1;for(const e of o)e.breakpointId?(r.push(e.breakpointId),i=i.concat(e.locations)):s=!0;return{breakpointIds:r,locations:i,serverError:s}}async resetBreakpoint(){this.#Ce.length&&(this.resetLocations(),await Promise.all(this.#Ce.map((e=>this.#$.removeBreakpoint(e)))),this.didRemoveFromDebugger(),this.#Me=null)}didRemoveFromDebugger(){this.#Le?this.#Le=!1:(this.resetLocations(),this.#Ce.forEach((e=>this.#$.removeBreakpointListener(e,this.breakpointResolved,this))),this.#Ce=[])}async breakpointResolved({data:e}){"ERROR"===await this.addResolvedLocation(e)&&await this.#Se.remove(!1)}async locationUpdated(e){const t=this.#ae.get(e),o=await e.uiLocation();t&&this.#Se.uiLocationRemoved(t),o?(this.#ae.set(e,o),this.#Se.uiLocationAdded(o)):this.#ae.delete(e)}async addResolvedLocation(e){const t=await this.#o.rawLocationToUILocation(e);if(!t)return"OK";const o=this.#Se.breakpointManager.findBreakpoint(t);return o&&o.breakpoint!==this.#Se?"ERROR":(await this.#o.createLiveLocation(e,this.locationUpdated.bind(this),this.#be),"OK")}cleanUpAfterDebuggerIsGone(){this.#Le=!0,this.resetLocations(),this.#Me=null,this.#Ce.length&&this.didRemoveFromDebugger()}}!function(e){e.State=class{positions;condition;constructor(e,t){this.positions=e,this.condition=t}static equals(e,t){if(!e||!t)return!1;if(e.condition!==t.condition)return!1;if(e.positions.length!==t.positions.length)return!1;for(let o=0;o<e.positions.length;o++){const r=e.positions[o],i=t.positions[o];if(r.url!==i.url)return!1;if(r.scriptHash!==i.scriptHash)return!1;if(r.lineNumber!==i.lineNumber)return!1;if(r.columnNumber!==i.columnNumber)return!1}return!0}}}(Me||(Me={}));class Ie{setting;breakpoints;#we;constructor(){this.setting=e.Settings.Settings.instance().createLocalSetting("breakpoints",[]),this.breakpoints=new Map,this.#we=!1;for(const e of this.setting.get())this.breakpoints.set(Ie.computeId(e),e)}mute(){this.#we=!0}unmute(){this.#we=!1}breakpointItems(e,t){const o=[];for(const r of this.breakpoints.values())r.url===e&&(r.resourceTypeName!==t&&void 0!==t||o.push(r));return o}updateBreakpoint(e){if(this.#we)return;const t=Ie.computeId(e);t&&(this.breakpoints.set(t,e),this.save())}removeBreakpoint(e){this.#we||(this.breakpoints.delete(e),this.save())}save(){this.setting.set(Array.from(this.breakpoints.values()))}static computeId({url:e,resourceTypeName:t,lineNumber:o,columnNumber:r}){if(!e)return"";let i=`${e}:${t}:${o}`;return void 0!==r&&(i+=`:${r}`),i}}class ve{breakpoint;uiLocation;constructor(e,t){this.breakpoint=e,this.uiLocation=t}}const we="/** DEVTOOLS_LOGPOINT */ console.log(",ye=")";var Re=Object.freeze({__proto__:null,BreakpointManager:fe,get Events(){return Le},get Breakpoint(){return Me},ModelBreakpoint:Ce,EMPTY_BREAKPOINT_CONDITION:"",NEVER_PAUSE_HERE_CONDITION:"false",BreakpointLocation:ve});class Te{#s;#U;#c;#ye;constructor(e,t,o){this.#s=t,this.#U=new l(o,"cssSourceMaps:"+e.id(),s.Workspace.projectTypes.Network,"",!1),y.setTargetForProject(this.#U,e),this.#ye=new Map,this.#c=[this.#s.addEventListener(i.SourceMapManager.Events.SourceMapAttached,this.sourceMapAttached,this),this.#s.addEventListener(i.SourceMapManager.Events.SourceMapDetached,this.sourceMapDetached,this)]}sourceMapAttachedForTest(e){}async sourceMapAttached(e){const t=e.data.client,o=e.data.sourceMap,r=this.#U,i=this.#ye;for(const e of o.sourceURLs()){let s=i.get(e);s||(s=new Fe(r,e,t.createPageResourceLoadInitiator()),i.set(e,s)),s.addSourceMap(o,t.frameId)}await Be.instance().updateLocations(t),this.sourceMapAttachedForTest(o)}async sourceMapDetached(e){const t=e.data.client,o=e.data.sourceMap,r=this.#ye;for(const e of o.sourceURLs()){const i=r.get(e);i&&(i.removeSourceMap(o,t.frameId),i.getUiSourceCode()||r.delete(e))}await Be.instance().updateLocations(t)}rawLocationToUILocation(e){const t=e.header();if(!t)return null;const o=this.#s.sourceMapForClient(t);if(!o)return null;let{lineNumber:r,columnNumber:i}=e;o.mapsOrigin()&&t.isInline&&(r-=t.startLine,0===r&&(i-=t.startColumn));const s=o.findEntry(r,i);if(!s||!s.sourceURL)return null;const n=this.#U.uiSourceCodeForURL(s.sourceURL);return n?n.uiLocation(s.sourceLineNumber,s.sourceColumnNumber):null}uiLocationToRawLocations(e){const{uiSourceCode:t,lineNumber:o,columnNumber:r=0}=e,s=ke.get(t);if(!s)return[];const n=[];for(const e of s.getReferringSourceMaps()){const s=e.findReverseEntries(t.url(),o,r),a=this.#s.clientForSourceMap(e);a&&n.push(...s.map((e=>new i.CSSModel.CSSLocation(a,e.lineNumber,e.columnNumber))))}return n}static uiSourceOrigin(e){const t=ke.get(e);return t?t.getReferringSourceMaps().map((e=>e.compiledURL())):[]}dispose(){e.EventTarget.removeEventListeners(this.#c),this.#U.dispose()}}const ke=new WeakMap;class Fe{#U;#Re;#Te;referringSourceMaps;uiSourceCode;constructor(e,t,o){this.#U=e,this.#Re=t,this.#Te=o,this.referringSourceMaps=[],this.uiSourceCode=null}recreateUISourceCodeIfNeeded(t){const o=this.referringSourceMaps[this.referringSourceMaps.length-1],r=e.ResourceType.resourceTypes.SourceMapStyleSheet,a=o.embeddedContentByURL(this.#Re),c=null!==a?n.StaticContentProvider.StaticContentProvider.fromString(this.#Re,r,a):new i.CompilerSourceMappingContentProvider.CompilerSourceMappingContentProvider(this.#Re,r,this.#Te),u=this.#U.createUISourceCode(this.#Re,r);ke.set(u,this);const d=e.ResourceType.ResourceType.mimeFromURL(this.#Re)||r.canonicalMimeType(),l="string"==typeof a?new s.UISourceCode.UISourceCodeMetadata(null,a.length):null;this.uiSourceCode?(y.cloneInitialFrameAttribution(this.uiSourceCode,u),this.#U.removeUISourceCode(this.uiSourceCode.url())):y.setInitialFrameAttribution(u,t),this.uiSourceCode=u,this.#U.addUISourceCodeWithProvider(this.uiSourceCode,c,l,d)}addSourceMap(e,t){this.uiSourceCode&&y.addFrameAttribution(this.uiSourceCode,t),this.referringSourceMaps.push(e),this.recreateUISourceCodeIfNeeded(t)}removeSourceMap(e,t){const o=this.uiSourceCode;y.removeFrameAttribution(o,t);const r=this.referringSourceMaps.lastIndexOf(e);-1!==r&&this.referringSourceMaps.splice(r,1),this.referringSourceMaps.length?this.recreateUISourceCodeIfNeeded(t):(this.#U.removeUISourceCode(o.url()),this.uiSourceCode=null)}getReferringSourceMaps(){return this.referringSourceMaps}getUiSourceCode(){return this.uiSourceCode}}var Ue=Object.freeze({__proto__:null,SASSSourceMapping:Te});const Pe=new WeakMap;class je{#ke;#U;#Fe;#c;constructor(e,t){this.#ke=e;const o=this.#ke.target();this.#U=new l(t,"css:"+o.id(),s.Workspace.projectTypes.Network,"",!1),y.setTargetForProject(this.#U,o),this.#Fe=new Map,this.#c=[this.#ke.addEventListener(i.CSSModel.Events.StyleSheetAdded,this.styleSheetAdded,this),this.#ke.addEventListener(i.CSSModel.Events.StyleSheetRemoved,this.styleSheetRemoved,this),this.#ke.addEventListener(i.CSSModel.Events.StyleSheetChanged,this.styleSheetChanged,this)]}rawLocationToUILocation(e){const t=e.header();if(!t||!this.acceptsHeader(t))return null;const o=this.#Fe.get(t.resourceURL());if(!o)return null;let r=e.lineNumber,i=e.columnNumber;if(t.isInline&&t.hasSourceURL){r-=t.lineNumberInSource(0);const e=t.columnNumberInSource(r,0);void 0===e?i=e:i-=e}return o.getUiSourceCode().uiLocation(r,i)}uiLocationToRawLocations(e){const t=Pe.get(e.uiSourceCode);if(!t)return[];const o=[];for(const r of t.getHeaders()){let t=e.lineNumber,s=e.columnNumber;r.isInline&&r.hasSourceURL&&(s=r.columnNumberInSource(t,e.columnNumber||0),t=r.lineNumberInSource(t)),o.push(new i.CSSModel.CSSLocation(r,t,s))}return o}acceptsHeader(e){return!e.isConstructedByNew()&&(!(e.isInline&&!e.hasSourceURL&&"inspector"!==e.origin)&&!!e.resourceURL())}styleSheetAdded(e){const t=e.data;if(!this.acceptsHeader(t))return;const o=t.resourceURL();let r=this.#Fe.get(o);r?r.addHeader(t):(r=new Ne(this.#ke,this.#U,t),this.#Fe.set(o,r))}styleSheetRemoved(e){const t=e.data;if(!this.acceptsHeader(t))return;const o=t.resourceURL(),r=this.#Fe.get(o);r&&(1===r.getHeaders().size?(r.dispose(),this.#Fe.delete(o)):r.removeHeader(t))}styleSheetChanged(e){const t=this.#ke.styleSheetHeaderForId(e.data.styleSheetId);if(!t||!this.acceptsHeader(t))return;const o=this.#Fe.get(t.resourceURL());o&&o.styleSheetChanged(t)}dispose(){for(const e of this.#Fe.values())e.dispose();this.#Fe.clear(),e.EventTarget.removeEventListeners(this.#c),this.#U.removeProject()}}class Ne{#ke;#U;headers;uiSourceCode;#c;#Ue;#Pe;#je;#Ne;constructor(t,o,r){this.#ke=t,this.#U=o,this.headers=new Set([r]);const i=t.target(),n=r.resourceURL(),a=oe(i,r.frameId,n);this.uiSourceCode=this.#U.createUISourceCode(n,r.contentType()),Pe.set(this.uiSourceCode,this),y.setInitialFrameAttribution(this.uiSourceCode,r.frameId),this.#U.addUISourceCodeWithProvider(this.uiSourceCode,this,a,"text/css"),this.#c=[this.uiSourceCode.addEventListener(s.UISourceCode.Events.WorkingCopyChanged,this.workingCopyChanged,this),this.uiSourceCode.addEventListener(s.UISourceCode.Events.WorkingCopyCommitted,this.workingCopyCommitted,this)],this.#Ue=new e.Throttler.Throttler(Ne.updateTimeout),this.#Pe=!1}addHeader(e){this.headers.add(e),y.addFrameAttribution(this.uiSourceCode,e.frameId)}removeHeader(e){this.headers.delete(e),y.removeFrameAttribution(this.uiSourceCode,e.frameId)}styleSheetChanged(e){if(console.assert(this.headers.has(e)),this.#Ne||!this.headers.has(e))return;const t=this.mirrorContent.bind(this,e,!0);this.#Ue.schedule(t,!1)}workingCopyCommitted(){if(this.#je)return;const e=this.mirrorContent.bind(this,this.uiSourceCode,!0);this.#Ue.schedule(e,!0)}workingCopyChanged(){if(this.#je)return;const e=this.mirrorContent.bind(this,this.uiSourceCode,!1);this.#Ue.schedule(e,!1)}async mirrorContent(e,t){if(this.#Pe)return void this.styleFileSyncedForTest();let o=null;if(e===this.uiSourceCode)o=this.uiSourceCode.workingCopy();else{o=(await e.requestContent()).content}if(null===o||this.#Pe)return void this.styleFileSyncedForTest();e!==this.uiSourceCode&&(this.#je=!0,this.uiSourceCode.addRevision(o),this.#je=!1),this.#Ne=!0;const r=[];for(const i of this.headers)i!==e&&r.push(this.#ke.setStyleSheetText(i.id,o,t));await Promise.all(r),this.#Ne=!1,this.styleFileSyncedForTest()}styleFileSyncedForTest(){}dispose(){this.#Pe||(this.#Pe=!0,this.#U.removeUISourceCode(this.uiSourceCode.url()),e.EventTarget.removeEventListeners(this.#c))}contentURL(){return console.assert(this.headers.size>0),this.headers.values().next().value.originalContentProvider().contentURL()}contentType(){return console.assert(this.headers.size>0),this.headers.values().next().value.originalContentProvider().contentType()}requestContent(){return console.assert(this.headers.size>0),this.headers.values().next().value.originalContentProvider().requestContent()}searchInContent(e,t,o){return console.assert(this.headers.size>0),this.headers.values().next().value.originalContentProvider().searchInContent(e,t,o)}static updateTimeout=200;getHeaders(){return this.headers}getUiSourceCode(){return this.uiSourceCode}}var Ee=Object.freeze({__proto__:null,StylesSourceMapping:je,StyleFile:Ne});let De;class Be{#J;#Ee;#V;#K;constructor(e,t){this.#J=e,this.#Ee=new Map,this.#V=[],t.observeModels(i.CSSModel.CSSModel,this),this.#K=new Set}static instance(e={forceNew:null,resourceMapping:null,targetManager:null}){const{forceNew:t,resourceMapping:o,targetManager:r}=e;if(!De||t){if(!o||!r)throw new Error(`Unable to create CSSWorkspaceBinding: resourceMapping and targetManager must be provided: ${(new Error).stack}`);De=new Be(o,r)}return De}static removeInstance(){De=void 0}get modelToInfo(){return this.#Ee}getCSSModelInfo(e){return this.#Ee.get(e)}modelAdded(e){this.#Ee.set(e,new Ae(e,this.#J))}modelRemoved(e){this.getCSSModelInfo(e).dispose(),this.#Ee.delete(e)}async pendingLiveLocationChangesPromise(){await Promise.all(this.#K)}recordLiveLocationChange(e){e.then((()=>{this.#K.delete(e)})),this.#K.add(e)}async updateLocations(e){const t=this.getCSSModelInfo(e.cssModel()).updateLocations(e);this.recordLiveLocationChange(t),await t}createLiveLocation(e,t,o){const r=this.getCSSModelInfo(e.cssModel()).createLiveLocation(e,t,o);return this.recordLiveLocationChange(r),r}propertyRawLocation(e,t){const o=e.ownerStyle;if(!o||o.type!==i.CSSStyleDeclaration.Type.Regular||!o.styleSheetId)return null;const r=o.cssModel().styleSheetHeaderForId(o.styleSheetId);if(!r)return null;const s=t?e.nameRange():e.valueRange();if(!s)return null;const n=s.startLine,a=s.startColumn;return new i.CSSModel.CSSLocation(r,r.lineNumberInSource(n),r.columnNumberInSource(n,a))}propertyUILocation(e,t){const o=this.propertyRawLocation(e,t);return o?this.rawLocationToUILocation(o):null}rawLocationToUILocation(e){for(let t=this.#V.length-1;t>=0;--t){const o=this.#V[t].rawLocationToUILocation(e);if(o)return o}return this.getCSSModelInfo(e.cssModel()).rawLocationToUILocation(e)}uiLocationToRawLocations(e){for(let t=this.#V.length-1;t>=0;--t){const o=this.#V[t].uiLocationToRawLocations(e);if(o.length)return o}const t=[];for(const o of this.#Ee.values())t.push(...o.uiLocationToRawLocations(e));return t}addSourceMapping(e){this.#V.push(e)}removeSourceMapping(e){const t=this.#V.indexOf(e);-1!==t&&this.#V.splice(t,1)}}class Ae{#c;#J;#De;#Be;#B;#Ae;constructor(e,o){this.#c=[e.addEventListener(i.CSSModel.Events.StyleSheetAdded,(e=>{this.styleSheetAdded(e)}),this),e.addEventListener(i.CSSModel.Events.StyleSheetRemoved,(e=>{this.styleSheetRemoved(e)}),this)],this.#J=o,this.#De=new je(e,o.workspace);const r=e.sourceMapManager();this.#Be=new Te(e.target(),r,o.workspace),this.#B=new t.MapUtilities.Multimap,this.#Ae=new t.MapUtilities.Multimap}get locations(){return this.#B}async createLiveLocation(e,t,o){const r=new Oe(e,this,t,o),i=e.header();return i?(r.setHeader(i),this.#B.set(i,r),await r.update()):this.#Ae.set(e.url,r),r}disposeLocation(e){const t=e.header();t?this.#B.delete(t,e):this.#Ae.delete(e.url,e)}updateLocations(e){const t=[];for(const o of this.#B.get(e))t.push(o.update());return Promise.all(t)}async styleSheetAdded(e){const t=e.data;if(!t.sourceURL)return;const o=[];for(const e of this.#Ae.get(t.sourceURL))e.setHeader(t),this.#B.set(t,e),o.push(e.update());await Promise.all(o),this.#Ae.deleteAll(t.sourceURL)}async styleSheetRemoved(e){const t=e.data,o=[];for(const e of this.#B.get(t))e.setHeader(t),this.#Ae.set(e.url,e),o.push(e.update());await Promise.all(o),this.#B.deleteAll(t)}rawLocationToUILocation(e){let t=null;return t=t||this.#Be.rawLocationToUILocation(e),t=t||this.#De.rawLocationToUILocation(e),t=t||this.#J.cssLocationToUILocation(e),t}uiLocationToRawLocations(e){let t=this.#Be.uiLocationToRawLocations(e);return t.length?t:(t=this.#De.uiLocationToRawLocations(e),t.length?t:this.#J.uiLocationToCSSLocations(e))}dispose(){e.EventTarget.removeEventListeners(this.#c),this.#De.dispose(),this.#Be.dispose()}}class Oe extends X{url;#Oe;#xe;#We;headerInternal;constructor(e,t,o,r){super(o,r),this.url=e.url,this.#Oe=e.lineNumber,this.#xe=e.columnNumber,this.#We=t,this.headerInternal=null}header(){return this.headerInternal}setHeader(e){this.headerInternal=e}async uiLocation(){if(!this.headerInternal)return null;const e=new i.CSSModel.CSSLocation(this.headerInternal,this.#Oe,this.#xe);return Be.instance().rawLocationToUILocation(e)}dispose(){super.dispose(),this.#We.disposeLocation(this)}async isIgnoreListed(){return!1}}var xe=Object.freeze({__proto__:null,CSSWorkspaceBinding:Be,ModelInfo:Ae,LiveLocation:Oe});class We{#He;#_e;#ze;#Ve;#Ke;#Ge;#$e;#qe;#Je;#Ye;#Qe;#Xe;constructor(e,t,o){this.#He=e,this.#_e=e.size,this.#ze=0,this.#Ke=t,this.#Ge=o,this.#$e=new TextDecoder,this.#qe=!1,this.#Je=null,this.#Ve=null}async read(e){if(this.#Ge&&this.#Ge(this),this.#He?.type.endsWith("gzip")){const e=this.#He.stream(),t=this.decompressStream(e);this.#Ve=t.getReader()}else this.#Xe=new FileReader,this.#Xe.onload=this.onChunkLoaded.bind(this),this.#Xe.onerror=this.onError.bind(this);return this.#Qe=e,this.loadChunk(),new Promise((e=>{this.#Ye=e}))}cancel(){this.#qe=!0}loadedSize(){return this.#ze}fileSize(){return this.#_e}fileName(){return this.#He?this.#He.name:""}error(){return this.#Je}decompressStream(e){const t=new DecompressionStream("gzip");return e.pipeThrough(t)}onChunkLoaded(e){if(this.#qe)return;if(e.target.readyState!==FileReader.DONE)return;if(!this.#Xe)return;const t=this.#Xe.result;this.#ze+=t.byteLength;const o=this.#ze===this.#_e;this.decodeChunkBuffer(t,o)}async decodeChunkBuffer(e,t){if(!this.#Qe)return;const o=this.#$e.decode(e,{stream:!t});await this.#Qe.write(o),this.#qe||(this.#Ge&&this.#Ge(this),t?this.finishRead():this.loadChunk())}async finishRead(){this.#Qe&&(this.#He=null,this.#Xe=null,await this.#Qe.close(),this.#Ye(!this.#Je))}async loadChunk(){if(this.#Qe&&this.#He){if(this.#Ve){const{value:e,done:t}=await this.#Ve.read();if(t||!e)return this.finishRead();this.decodeChunkBuffer(e.buffer,!1)}if(this.#Xe){const e=this.#ze,t=Math.min(this.#_e,e+this.#Ke),o=this.#He.slice(e,t);this.#Xe.readAsArrayBuffer(o)}}}onError(e){const t=e.target;this.#Je=t.error,this.#Ye(!1)}}var He=Object.freeze({__proto__:null,ChunkedFileReader:We,FileOutputStream:class{#Ze;#et;#tt;constructor(){this.#Ze=[]}async open(e){this.#tt=!1,this.#Ze=[],this.#et=e;const t=await s.FileManager.FileManager.instance().save(this.#et,"",!0);return t&&s.FileManager.FileManager.instance().addEventListener(s.FileManager.Events.AppendedToURL,this.onAppendDone,this),Boolean(t)}write(e){return new Promise((t=>{this.#Ze.push(t),s.FileManager.FileManager.instance().append(this.#et,e)}))}async close(){this.#tt=!0,this.#Ze.length||(s.FileManager.FileManager.instance().removeEventListener(s.FileManager.Events.AppendedToURL,this.onAppendDone,this),s.FileManager.FileManager.instance().close(this.#et))}onAppendDone(e){if(e.data!==this.#et)return;const t=this.#Ze.shift();t&&t(),this.#Ze.length||this.#tt&&(s.FileManager.FileManager.instance().removeEventListener(s.FileManager.Events.AppendedToURL,this.onAppendDone,this),s.FileManager.FileManager.instance().close(this.#et))}}});const _e=new WeakMap;class ze{#$;#ot;#rt;#E;constructor(e){this.#$=e,this.#ot=new Map,this.#rt=[],e.addEventListener(i.DebuggerModel.Events.ParsedScriptSource,(e=>{queueMicrotask((()=>{this.parsedScriptSource(e)}))})),e.addEventListener(i.DebuggerModel.Events.GlobalObjectCleared,this.debuggerReset,this),this.#E=new Z}consoleMessageAdded(e){const t=this.rawLocation(e);t?this.addConsoleMessageToScript(e,t):this.addPendingConsoleMessage(e)}rawLocation(e){if(e.scriptId)return this.#$.createRawLocationByScriptId(e.scriptId,e.line,e.column);const t=e.stackTrace&&e.stackTrace.callFrames?e.stackTrace.callFrames[0]:null;return t?this.#$.createRawLocationByScriptId(t.scriptId,t.lineNumber,t.columnNumber):e.url?this.#$.createRawLocationByURL(e.url,e.line,e.column):null}addConsoleMessageToScript(e,t){this.#rt.push(new Ve(e,t,this.#E))}addPendingConsoleMessage(e){if(!e.url)return;const t=this.#ot.get(e.url);t?t.push(e):this.#ot.set(e.url,[e])}parsedScriptSource(e){const t=e.data,o=this.#ot.get(t.sourceURL);if(!o)return;const r=[];for(const e of o){const o=this.rawLocation(e);o&&t.scriptId===o.scriptId?this.addConsoleMessageToScript(e,o):r.push(e)}r.length?this.#ot.set(t.sourceURL,r):this.#ot.delete(t.sourceURL)}consoleCleared(){this.#ot=new Map,this.debuggerReset()}debuggerReset(){for(const e of this.#rt)e.dispose();this.#rt=[],this.#E.disposeAll()}}class Ve extends s.UISourceCode.Message{#it;constructor(e,t,o){super("error"===e.level?s.UISourceCode.Message.Level.Error:s.UISourceCode.Message.Level.Warning,e.messageText),pe.instance().createLiveLocation(t,this.updateLocation.bind(this),o)}async updateLocation(e){this.#it&&this.#it.removeMessage(this);const t=await e.uiLocation();t&&(this.range=n.TextRange.TextRange.createFromLocation(t.lineNumber,t.columnNumber||0),this.#it=t.uiSourceCode,this.#it.addMessage(this))}dispose(){this.#it&&this.#it.removeMessage(this)}}var Ke=Object.freeze({__proto__:null,PresentationConsoleMessageManager:class{constructor(){i.TargetManager.TargetManager.instance().observeModels(i.DebuggerModel.DebuggerModel,this),i.ConsoleModel.ConsoleModel.instance().addEventListener(i.ConsoleModel.Events.ConsoleCleared,this.consoleCleared,this),i.ConsoleModel.ConsoleModel.instance().addEventListener(i.ConsoleModel.Events.MessageAdded,(e=>this.consoleMessageAdded(e.data))),i.ConsoleModel.ConsoleModel.instance().messages().forEach(this.consoleMessageAdded,this)}modelAdded(e){_e.set(e,new ze(e))}modelRemoved(e){const t=_e.get(e);t&&t.consoleCleared()}consoleMessageAdded(e){const t=e.runtimeModel();if(!e.isErrorOrWarning()||!e.runtimeModel()||"violation"===e.source||!t)return;const o=_e.get(t.debuggerModel());o&&o.consoleMessageAdded(e)}consoleCleared(){for(const e of i.TargetManager.TargetManager.instance().models(i.DebuggerModel.DebuggerModel)){const t=_e.get(e);t&&t.consoleCleared()}}},PresentationConsoleMessageHelper:ze,PresentationConsoleMessage:Ve});const Ge=new WeakMap,$e=new WeakMap,qe=new WeakSet;class Je{project;#ye;#ke;#c;constructor(e,t){const o=t.target();this.project=new l(e,"resources:"+o.id(),s.Workspace.projectTypes.Network,"",!1),y.setTargetForProject(this.project,o),this.#ye=new Map;const r=o.model(i.CSSModel.CSSModel);console.assert(Boolean(r)),this.#ke=r,this.#c=[t.addEventListener(i.ResourceTreeModel.Events.ResourceAdded,this.resourceAdded,this),t.addEventListener(i.ResourceTreeModel.Events.FrameWillNavigate,this.frameWillNavigate,this),t.addEventListener(i.ResourceTreeModel.Events.FrameDetached,this.frameDetached,this),this.#ke.addEventListener(i.CSSModel.Events.StyleSheetChanged,(e=>{this.styleSheetChanged(e)}),this)]}async styleSheetChanged(e){const t=this.#ke.styleSheetHeaderForId(e.data.styleSheetId);if(!t||!t.isInline||t.isInline&&t.isMutable)return;const o=this.#ye.get(t.resourceURL());o&&await o.styleSheetChanged(t,e.data.edit||null)}acceptsResource(t){const o=t.resourceType();return(o===e.ResourceType.resourceTypes.Image||o===e.ResourceType.resourceTypes.Font||o===e.ResourceType.resourceTypes.Document||o===e.ResourceType.resourceTypes.Manifest)&&(!(o===e.ResourceType.resourceTypes.Image&&t.mimeType&&!t.mimeType.startsWith("image"))&&(!(o===e.ResourceType.resourceTypes.Font&&t.mimeType&&!t.mimeType.includes("font"))&&(o!==e.ResourceType.resourceTypes.Image&&o!==e.ResourceType.resourceTypes.Font||!t.contentURL().startsWith("data:"))))}resourceAdded(e){const t=e.data;if(!this.acceptsResource(t))return;let o=this.#ye.get(t.url);o?o.addResource(t):(o=new Ye(this.project,t),this.#ye.set(t.url,o))}removeFrameResources(e){for(const t of e.resources()){if(!this.acceptsResource(t))continue;const e=this.#ye.get(t.url);e&&(1===e.resources.size?(e.dispose(),this.#ye.delete(t.url)):e.removeResource(t))}}frameWillNavigate(e){this.removeFrameResources(e.data)}frameDetached(e){this.removeFrameResources(e.data.frame)}resetForTest(){for(const e of this.#ye.values())e.dispose();this.#ye.clear()}dispose(){e.EventTarget.removeEventListeners(this.#c);for(const e of this.#ye.values())e.dispose();this.#ye.clear(),this.project.removeProject()}getProject(){return this.project}}class Ye{resources;#U;#it;#st;constructor(e,t){this.resources=new Set([t]),this.#U=e,this.#it=this.#U.createUISourceCode(t.url,t.contentType()),qe.add(this.#it),t.frameId&&y.setInitialFrameAttribution(this.#it,t.frameId),this.#U.addUISourceCodeWithProvider(this.#it,this,re(t),t.mimeType),this.#st=[],Promise.all([...this.inlineScripts().map((e=>pe.instance().updateLocations(e))),...this.inlineStyles().map((e=>Be.instance().updateLocations(e)))])}inlineStyles(){const e=y.targetForUISourceCode(this.#it),t=[];if(!e)return t;const o=e.model(i.CSSModel.CSSModel);if(o)for(const e of o.getStyleSheetIdsForURL(this.#it.url())){const r=o.styleSheetHeaderForId(e);r&&t.push(r)}return t}inlineScripts(){const e=y.targetForUISourceCode(this.#it);if(!e)return[];const t=e.model(i.DebuggerModel.DebuggerModel);return t?t.scripts().filter((e=>e.embedderName()===this.#it.url())):[]}async styleSheetChanged(e,t){if(this.#st.push({stylesheet:e,edit:t}),this.#st.length>1)return;const{content:o}=await this.#it.requestContent();null!==o&&await this.innerStyleSheetChanged(o),this.#st=[]}async innerStyleSheetChanged(e){const t=this.inlineScripts(),o=this.inlineStyles();let r=new n.Text.Text(e);for(const e of this.#st){const i=e.edit;if(!i)continue;const s=e.stylesheet,a=Ge.get(s)||n.TextRange.TextRange.createFromLocation(s.startLine,s.startColumn),c=i.oldRange.relativeFrom(a.startLine,a.startColumn),u=i.newRange.relativeFrom(a.startLine,a.startColumn);r=new n.Text.Text(r.replaceRange(c,i.newText));const d=[];for(const e of t){const t=$e.get(e)||n.TextRange.TextRange.createFromLocation(e.lineOffset,e.columnOffset);t.follows(c)&&($e.set(e,t.rebaseAfterTextEdit(c,u)),d.push(pe.instance().updateLocations(e)))}for(const e of o){const t=Ge.get(e)||n.TextRange.TextRange.createFromLocation(e.startLine,e.startColumn);t.follows(c)&&(Ge.set(e,t.rebaseAfterTextEdit(c,u)),d.push(Be.instance().updateLocations(e)))}await Promise.all(d)}this.#it.addRevision(r.value())}addResource(e){this.resources.add(e),e.frameId&&y.addFrameAttribution(this.#it,e.frameId)}removeResource(e){this.resources.delete(e),e.frameId&&y.removeFrameAttribution(this.#it,e.frameId)}dispose(){this.#U.removeUISourceCode(this.#it.url()),Promise.all([...this.inlineScripts().map((e=>pe.instance().updateLocations(e))),...this.inlineStyles().map((e=>Be.instance().updateLocations(e)))])}firstResource(){return console.assert(this.resources.size>0),this.resources.values().next().value}contentURL(){return this.firstResource().contentURL()}contentType(){return this.firstResource().contentType()}requestContent(){return this.firstResource().requestContent()}searchInContent(e,t,o){return this.firstResource().searchInContent(e,t,o)}}var Qe=Object.freeze({__proto__:null,ResourceMapping:class{workspace;#Ee;constructor(e,t){this.workspace=t,this.#Ee=new Map,e.observeModels(i.ResourceTreeModel.ResourceTreeModel,this)}modelAdded(e){const t=new Je(this.workspace,e);this.#Ee.set(e,t)}modelRemoved(e){const t=this.#Ee.get(e);t&&(t.dispose(),this.#Ee.delete(e))}infoForTarget(e){const t=e.model(i.ResourceTreeModel.ResourceTreeModel);return t&&this.#Ee.get(t)||null}uiSourceCodeForScript(e){const t=this.infoForTarget(e.debuggerModel.target());if(!t)return null;return t.getProject().uiSourceCodeForURL(e.sourceURL)}cssLocationToUILocation(e){const t=e.header();if(!t)return null;const o=this.infoForTarget(e.cssModel().target());if(!o)return null;const r=o.getProject().uiSourceCodeForURL(e.url);if(!r)return null;const i=Ge.get(t)||n.TextRange.TextRange.createFromLocation(t.startLine,t.startColumn),s=e.lineNumber+i.startLine-t.startLine;let a=e.columnNumber;return e.lineNumber===t.startLine&&(a+=i.startColumn-t.startColumn),r.uiLocation(s,a)}jsLocationToUILocation(e){const t=e.script();if(!t)return null;const o=this.infoForTarget(e.debuggerModel.target());if(!o)return null;const r=t.embedderName();if(!r)return null;const i=o.getProject().uiSourceCodeForURL(r);if(!i)return null;const s=$e.get(t)||n.TextRange.TextRange.createFromLocation(t.lineOffset,t.columnOffset);let a=e.lineNumber+s.startLine-t.lineOffset,c=e.columnNumber;return e.lineNumber===t.lineOffset&&(c+=s.startColumn-t.columnOffset),t.hasSourceURL&&(0===a&&(c+=t.columnOffset),a+=t.lineOffset),i.uiLocation(a,c)}uiLocationToJSLocations(e,t,o){if(!qe.has(e))return[];const r=y.targetForUISourceCode(e);if(!r)return[];const s=r.model(i.DebuggerModel.DebuggerModel);if(!s)return[];const a=[];for(const r of s.scripts()){if(r.embedderName()!==e.url())continue;const{startLine:i,startColumn:c}=$e.get(r)||n.TextRange.TextRange.createFromLocation(r.lineOffset,r.columnOffset);if(t<i||t===i&&o<c)continue;const u=i+(r.endLine-r.lineOffset),d=i===u?c+(r.endColumn-r.columnOffset):r.endColumn;if(t>u||t===u&&o>d)continue;let l=t,p=o;r.hasSourceURL&&(l-=i,0===l&&(p-=c)),a.push(s.createRawLocation(r,l,p))}return a}getMappedLines(e){if(!qe.has(e))return null;const t=y.targetForUISourceCode(e);if(!t)return null;const o=t.model(i.DebuggerModel.DebuggerModel);if(!o)return null;const r=new Set;for(const t of o.scripts()){if(t.embedderName()!==e.url())continue;const{startLine:o}=$e.get(t)||n.TextRange.TextRange.createFromLocation(t.lineOffset,t.columnOffset),i=o+(t.endLine-t.lineOffset);for(let e=o;e<=i;++e)r.add(e)}return r}uiLocationToCSSLocations(e){if(!qe.has(e.uiSourceCode))return[];const t=y.targetForUISourceCode(e.uiSourceCode);if(!t)return[];const o=t.model(i.CSSModel.CSSModel);return o?o.createRawLocationsByURL(e.uiSourceCode.url(),e.lineNumber,e.columnNumber):[]}resetForTest(e){const t=e.model(i.ResourceTreeModel.ResourceTreeModel),o=t?this.#Ee.get(t):null;o&&o.resetForTest()}}});class Xe{#nt;constructor(){this.#nt=null}write(e){this.#nt&&e.unshift(this.#nt),this.#nt=new Blob(e,{type:"text/plain"})}read(){return this.readRange()}size(){return this.#nt?this.#nt.size:0}async readRange(t,o){if(!this.#nt)return e.Console.Console.instance().error("Attempt to read a temp file that was never written"),"";const r="number"==typeof t||"number"==typeof o?this.#nt.slice(t,o):this.#nt,i=new FileReader;try{await new Promise(((e,t)=>{i.onloadend=e,i.onerror=t,i.readAsText(r)}))}catch(t){e.Console.Console.instance().error("Failed to read from temp file: "+t.message)}return i.result}async copyToOutputStream(e,t){if(!this.#nt)return e.close(),null;const o=new We(this.#nt,1e7,t);return o.read(e).then((e=>e?null:o.error()))}remove(){this.#nt=null}}var Ze=Object.freeze({__proto__:null,TempFile:Xe,TempFileBackingStorage:class{#He;#at;#ct;constructor(){this.#He=null,this.reset()}appendString(e){this.#at.push(e),this.#ct+=e.length;this.#ct>10485760&&this.flush()}appendAccessibleString(e){if(this.flush(),!this.#He)return async()=>null;const t=this.#He.size();return this.#at.push(e),this.flush(),this.#He.readRange.bind(this.#He,t,this.#He.size())}flush(){this.#at.length&&(this.#He||(this.#He=new Xe),this.#ct=0,this.#He.write(this.#at.splice(0)))}finishWriting(){this.flush()}reset(){this.#He&&this.#He.remove(),this.#He=null,this.#at=[],this.#ct=0}writeToStream(e){return this.#He?this.#He.copyToOutputStream(e):Promise.resolve(null)}}});export{Re as BreakpointManager,xe as CSSWorkspaceBinding,F as CompilerScriptMapping,p as ContentProviderBasedProject,q as DebuggerLanguagePlugins,Se as DebuggerWorkspaceBinding,Q as DefaultScriptMapping,He as FileUtils,L as IgnoreListManager,ee as LiveLocation,R as NetworkProject,Ke as PresentationConsoleMessageHelper,Qe as ResourceMapping,de as ResourceScriptMapping,ie as ResourceUtils,Ue as SASSSourceMapping,Ee as StylesSourceMapping,Ze as TempFile};
