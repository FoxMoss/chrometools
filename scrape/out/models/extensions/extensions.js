import*as e from"../../core/platform/platform.js";import*as t from"../../core/sdk/sdk.js";import*as n from"../../ui/legacy/legacy.js";import*as s from"../../core/common/common.js";import*as i from"../../core/host/host.js";import*as r from"../../core/i18n/i18n.js";import*as o from"../../core/root/root.js";import*as a from"../logs/logs.js";import*as c from"../../ui/legacy/components/utils/utils.js";import*as d from"../../ui/legacy/theme_support/theme_support.js";import*as u from"../bindings/bindings.js";import*as l from"../har/har.js";import*as h from"../workspace/workspace.js";self.injectedExtensionAPI=function(t,n,s,i,r,o,a){const c=new Set(i),d=window.chrome||{};if(Object.getOwnPropertyDescriptor(d,"devtools"))return;let u=!1;function l(e,t){this._type=e,this._listeners=[],this._customDispatch=t}function h(){this.onRequestFinished=new _("network-request-finished",(function(e){const t=e.arguments[1];t.__proto__=new P(e.arguments[0]),this._fire(t)})),E(this,"network","onFinished","onRequestFinished"),this.onNavigated=new _("inspected-url-changed")}function p(e){this._id=e}function g(){const e={elements:new C,sources:new H};function t(t){return e[t]}for(const n in e)Object.defineProperty(this,n,{get:t.bind(null,n),enumerable:!0});this.applyStyleSheet=function(e){$.sendRequest({command:"applyStyleSheet",styleSheet:e})}}function m(e){this._id=e,e&&(this.onShown=new _("view-shown-"+e,(function(e){const t=e.arguments[0];"number"==typeof t?this._fire(window.parent.frames[t]):this._fire()})),this.onHidden=new _("view-hidden,"+e))}function f(e){m.call(this,null),this._hostPanelName=e,this.onSelectionChanged=new _("panel-objectSelected-"+e)}function b(){this._plugins=new Map}function w(){this._plugins=new Map}function R(e){return function(...t){const n={__proto__:e.prototype};e.apply(n,t),function(e,t){for(const n in t){if("_"===n.charAt(0))continue;let s=null;for(let e=t;e&&!s;e=e.__proto__)s=Object.getOwnPropertyDescriptor(e,n);s&&("function"==typeof s.value?e[n]=s.value.bind(t):"function"==typeof s.get?e.__defineGetter__(n,s.get.bind(t)):Object.defineProperty(e,n,s))}}(this,n)}}function E(e,t,n,s){let i=!1;e.__defineGetter__(n,(function(){return i||(console.warn(t+"."+n+" is deprecated. Use "+t+"."+s+" instead"),i=!0),e[s]}))}function y(e){const t=e[e.length-1];return"function"==typeof t?t:void 0}l.prototype={addListener:function(e){if("function"!=typeof e)throw"addListener: callback is not a function";0===this._listeners.length&&$.sendRequest({command:"subscribe",type:this._type}),this._listeners.push(e),$.registerHandler("notify-"+this._type,this._dispatch.bind(this))},removeListener:function(e){const t=this._listeners;for(let n=0;n<t.length;++n)if(t[n]===e){t.splice(n,1);break}0===this._listeners.length&&$.sendRequest({command:"unsubscribe",type:this._type})},_fire:function(...e){const t=this._listeners.slice();for(let e=0;e<t.length;++e)t[e].apply(null,Array.from(arguments))},_dispatch:function(e){this._customDispatch?this._customDispatch.call(this,e):this._fire.apply(this,e.arguments)}},h.prototype={getHAR:function(e){$.sendRequest({command:"getHAR"},e&&function(t){const n=t,s=n&&n.entries||[];for(let e=0;e<s.length;++e)s[e].__proto__=new P(s[e]._requestId),delete s[e]._requestId;e&&e(n)})},addRequestHeaders:function(e){$.sendRequest({command:"addRequestHeaders",headers:e,extensionId:window.location.hostname})}},p.prototype={getContent:function(e){$.sendRequest({command:"getRequestContent",id:this._id},e&&function(t){const{content:n,encoding:s}=t;e&&e(n,s)})}},g.prototype={create:function(e,t,n,s){const i="extension-panel-"+$.nextObjectId();$.sendRequest({command:"createPanel",id:i,title:e,page:n},s&&(()=>s.call(this,new S(i))))},setOpenResourceHandler:function(e){const t=$.hasHandler("open-resource");e?$.registerHandler("open-resource",(function(t){u=!0;try{const{resource:n,lineNumber:s}=t;W(n)&&e.call(null,new A(n),s)}finally{u=!1}})):$.unregisterHandler("open-resource"),t===!e&&$.sendRequest({command:"setOpenResourceHandler",handlerPresent:Boolean(e)})},setThemeChangeHandler:function(e){const t=$.hasHandler("host-theme-change");e?$.registerHandler("host-theme-change",(function(t){const{themeName:n}=t;d.devtools.panels.themeName=n,e.call(null,n)})):$.unregisterHandler("host-theme-change"),t===!e&&$.sendRequest({command:"setThemeChangeHandler",handlerPresent:Boolean(e)})},openResource:function(e,t,n,s){const i=y(arguments),r="number"==typeof n?n:0;$.sendRequest({command:"openResource",url:e,lineNumber:t,columnNumber:r},i)},get SearchAction(){return{CancelSearch:"cancelSearch",PerformSearch:"performSearch",NextSearchResult:"nextSearchResult",PreviousSearchResult:"previousSearchResult"}}},f.prototype={createSidebarPane:function(e,t){const n="extension-sidebar-"+$.nextObjectId();$.sendRequest({command:"createSidebarPane",panel:this._hostPanelName,id:n,title:e},t&&function(){t&&t(new T(n))})},__proto__:m.prototype},b.prototype={registerRecorderExtensionPlugin:async function(e,t,n){if(this._plugins.has(e))throw new Error(`Tried to register plugin '${t}' twice`);const s=new MessageChannel,i=s.port1;this._plugins.set(e,i),i.onmessage=({data:t})=>{const{requestId:n}=t;(async function(t){switch(t.method){case"stringify":return e.stringify(t.parameters.recording);case"stringifyStep":return e.stringifyStep(t.parameters.step);default:throw new Error(`'${t.method}' is not recognized`)}})(t).then((e=>i.postMessage({requestId:n,result:e}))).catch((e=>i.postMessage({requestId:n,error:{message:e.message}})))},await new Promise((e=>{$.sendRequest({command:"registerRecorderExtensionPlugin",pluginName:t,mediaType:n,port:s.port2},(()=>e()),[s.port2])}))},unregisterRecorderExtensionPlugin:async function(e){const t=this._plugins.get(e);if(!t)throw new Error("Tried to unregister a plugin that was not previously registered");this._plugins.delete(e),t.postMessage({event:"unregisteredRecorderExtensionPlugin"}),t.close()}},w.prototype={registerLanguageExtensionPlugin:async function(e,t,n){if(this._plugins.has(e))throw new Error(`Tried to register plugin '${t}' twice`);const s=new MessageChannel,i=s.port1;this._plugins.set(e,i),i.onmessage=({data:t})=>{const{requestId:n}=t;console.time(`${n}: ${t.method}`),function(t){switch(t.method){case"addRawModule":return e.addRawModule(t.parameters.rawModuleId,t.parameters.symbolsURL,t.parameters.rawModule);case"removeRawModule":return e.removeRawModule(t.parameters.rawModuleId);case"sourceLocationToRawLocation":return e.sourceLocationToRawLocation(t.parameters.sourceLocation);case"rawLocationToSourceLocation":return e.rawLocationToSourceLocation(t.parameters.rawLocation);case"getScopeInfo":return e.getScopeInfo(t.parameters.type);case"listVariablesInScope":return e.listVariablesInScope(t.parameters.rawLocation);case"getTypeInfo":return e.getTypeInfo(t.parameters.expression,t.parameters.context);case"getFormatter":return e.getFormatter(t.parameters.expressionOrField,t.parameters.context);case"getInspectableAddress":return"getInspectableAddress"in e?e.getInspectableAddress(t.parameters.field):Promise.resolve({js:""});case"getFunctionInfo":return e.getFunctionInfo(t.parameters.rawLocation);case"getInlinedFunctionRanges":return e.getInlinedFunctionRanges(t.parameters.rawLocation);case"getInlinedCalleesRanges":return e.getInlinedCalleesRanges(t.parameters.rawLocation);case"getMappedLines":return"getMappedLines"in e?e.getMappedLines(t.parameters.rawModuleId,t.parameters.sourceFileURL):Promise.resolve(void 0);case"formatValue":return"evaluate"in e&&e.evaluate?e.evaluate(t.parameters.expression,t.parameters.context,t.parameters.stopId):Promise.resolve(void 0);case"getProperties":if("getProperties"in e&&e.getProperties)return e.getProperties(t.parameters.objectId);if(!("evaluate"in e)||!e.evaluate)return Promise.resolve(void 0);break;case"releaseObject":if("releaseObject"in e&&e.releaseObject)return e.releaseObject(t.parameters.objectId);if(!("evaluate"in e)&&e.evaluate)return Promise.resolve(void 0)}throw new Error(`Unknown language plugin method ${t.method}`)}(t).then((e=>i.postMessage({requestId:n,result:e}))).catch((e=>i.postMessage({requestId:n,error:{message:e.message}}))).finally((()=>console.timeEnd(`${n}: ${t.method}`)))},await new Promise((e=>{$.sendRequest({command:"registerLanguageExtensionPlugin",pluginName:t,port:s.port2,supportedScriptTypes:n},(()=>e()),[s.port2])}))},unregisterLanguageExtensionPlugin:async function(e){const t=this._plugins.get(e);if(!t)throw new Error("Tried to unregister a plugin that was not previously registered");this._plugins.delete(e),t.postMessage({event:"unregisteredLanguageExtensionPlugin"}),t.close()},getWasmLinearMemory:async function(e,t,n){const s=await new Promise((s=>$.sendRequest({command:"getWasmLinearMemory",offset:e,length:t,stopId:n},s)));return Array.isArray(s)?new Uint8Array(s).buffer:new ArrayBuffer(0)},getWasmLocal:async function(e,t){return new Promise((n=>$.sendRequest({command:"getWasmLocal",local:e,stopId:t},n)))},getWasmGlobal:async function(e,t){return new Promise((n=>$.sendRequest({command:"getWasmGlobal",global:e,stopId:t},n)))},getWasmOp:async function(e,t){return new Promise((n=>$.sendRequest({command:"getWasmOp",op:e,stopId:t},n)))}};const I=R(w),v=R(b),x=R(M),_=R(l),S=R(q),T=R(k),O=R(f),P=R(p),A=R(F),L=R(j);class C extends O{constructor(){super("elements")}}class H extends O{constructor(){super("sources")}}function q(e){m.call(this,e),this.onSearch=new _("panel-search-"+e)}function k(e){m.call(this,e)}function M(e){this._id=e,this.onClicked=new _("button-clicked-"+e)}function N(){}function j(e){this._id=e}function D(e){this.onRecordingStarted=new _("trace-recording-started-"+e,(function(e){const t=e.arguments[0];this._fire(new L(t))})),this.onRecordingStopped=new _("trace-recording-stopped-"+e)}function W(e){return t.allowFileAccess||!e.url.startsWith("file://")}function B(){this.onResourceAdded=new _("resource-added",(function(e){const t=e.arguments[0];W(t)&&this._fire(new A(t))})),this.onResourceContentCommitted=new _("resource-content-committed",(function(e){const t=e.arguments[0];W(t)&&this._fire(new A(t),e.arguments[1])}))}function F(e){if(!W)throw new Error("Resource access not allowed");this._url=e.url,this._type=e.type}q.prototype={createStatusBarButton:function(e,t,n){const s="button-"+$.nextObjectId();return $.sendRequest({command:"createToolbarButton",panel:this._id,id:s,icon:e,tooltip:t,disabled:Boolean(n)}),new x(s)},show:function(){u&&$.sendRequest({command:"showPanel",id:this._id})},__proto__:m.prototype},k.prototype={setHeight:function(e){$.sendRequest({command:"setSidebarHeight",id:this._id,height:e})},setExpression:function(e,t,n,s){$.sendRequest({command:"setSidebarContent",id:this._id,expression:e,rootTitle:t,evaluateOnPage:!0,evaluateOptions:"object"==typeof n?n:{}},y(arguments))},setObject:function(e,t,n){$.sendRequest({command:"setSidebarContent",id:this._id,expression:e,rootTitle:t},n)},setPage:function(e){$.sendRequest({command:"setSidebarPage",id:this._id,page:e})},__proto__:m.prototype},M.prototype={update:function(e,t,n){$.sendRequest({command:"updateButton",id:this._id,icon:e,tooltip:t,disabled:Boolean(n)})}},N.prototype={addTraceProvider:function(e,t){const n="extension-trace-provider-"+$.nextObjectId();return $.sendRequest({command:"addTraceProvider",id:n,categoryName:e,categoryTooltip:t}),new D(n)}},j.prototype={complete:function(t,n){$.sendRequest({command:"completeTra.eSession",id:this._id,url:t||e.DevToolsPath.EmptyUrlString,timeOffset:n||0})}},B.prototype={reload:function(e){let t=null;"object"==typeof e?t=e:"string"==typeof e&&(t={userAgent:e},console.warn("Passing userAgent as string parameter to inspectedWindow.reload() is deprecated. Use inspectedWindow.reload({ userAgent: value}) instead.")),$.sendRequest({command:"Reload",options:t})},eval:function(e,t){const n=y(arguments);function s(e){const{isError:t,isException:s,value:i}=e;t||s?n&&n(void 0,e):n&&n(i)}return $.sendRequest({command:"evaluateOnInspectedPage",expression:e,evaluateOptions:"object"==typeof t?t:void 0},n&&s),null},getResources:function(e){function t(e){return new A(e)}$.sendRequest({command:"getPageResources"},e&&function(n){e&&e(n.map(t).filter(W))})}},F.prototype={get url(){return this._url},get type(){return this._type},getContent:function(e){$.sendRequest({command:"getResourceContent",url:this._url},e&&function(t){const{content:n,encoding:s}=t;e&&e(n,s)})},setContent:function(e,t,n){$.sendRequest({command:"setResourceContent",url:this._url,content:e,commit:t},n)}};let U=[],G=null;function V(){G=null,$.sendRequest({command:"_forwardKeyboardEvent",entries:U}),U=[]}function K(e){this._callbacks={},this._handlers={},this._lastRequestId=0,this._lastObjectId=0,this.registerHandler("callback",this._onCallback.bind(this));const t=new MessageChannel;this._port=t.port1,this._port.addEventListener("message",this._onMessage.bind(this),!1),this._port.start(),e.postMessage("registerExtension","*",[t.port2])}document.addEventListener("keydown",(function(e){const t=document.activeElement;if(t){if(("INPUT"===t.nodeName||"TEXTAREA"===t.nodeName||t.isContentEditable)&&!(e.ctrlKey||e.altKey||e.metaKey))return}let n=0;e.shiftKey&&(n|=1),e.ctrlKey&&(n|=2),e.altKey&&(n|=4),e.metaKey&&(n|=8);const s=255&e.keyCode|n<<8;if(!c.has(s))return;e.preventDefault();const i={eventType:e.type,ctrlKey:e.ctrlKey,altKey:e.altKey,metaKey:e.metaKey,shiftKey:e.shiftKey,keyIdentifier:e.keyIdentifier,key:e.key,code:e.code,location:e.location,keyCode:e.keyCode};U.push(i),G||(G=window.setTimeout(V,0))}),!1),K.prototype={sendRequest:function(e,t,n){"function"==typeof t&&(e.requestId=this._registerCallback(t)),this._port.postMessage(e,n)},hasHandler:function(e){return Boolean(this._handlers[e])},registerHandler:function(e,t){this._handlers[e]=t},unregisterHandler:function(e){delete this._handlers[e]},nextObjectId:function(){return o.toString()+"_"+ ++this._lastObjectId},_registerCallback:function(e){const t=++this._lastRequestId;return this._callbacks[t]=e,t},_onCallback:function(e){if(e.requestId in this._callbacks){const t=this._callbacks[e.requestId];delete this._callbacks[e.requestId],t(e.result)}},_onMessage:function(e){const t=e.data,n=this._handlers[t.command];n&&n.call(this,t)}};const $=new K(a||window.parent),z=new function(){this.inspectedWindow=new B,this.panels=new g,this.network=new h,this.timeline=new N,this.languageServices=new I,this.recorder=new v,E(this,"webInspector","resources","network")};if(Object.defineProperty(d,"devtools",{value:{},enumerable:!0}),d.devtools.inspectedWindow={},Object.defineProperty(d.devtools.inspectedWindow,"tabId",{get:function(){return n}}),d.devtools.inspectedWindow.__proto__=z.inspectedWindow,d.devtools.network=z.network,d.devtools.panels=z.panels,d.devtools.panels.themeName=s,d.devtools.languageServices=z.languageServices,d.devtools.recorder=z.recorder,!1!==t.exposeExperimentalAPIs){d.experimental=d.experimental||{},d.experimental.devtools=d.experimental.devtools||{};const e=Object.getOwnPropertyNames(z);for(let t=0;t<e.length;++t){const n=Object.getOwnPropertyDescriptor(z,e[t]);n&&Object.defineProperty(d.experimental.devtools,e[t],n)}d.experimental.devtools.inspectedWindow=d.devtools.inspectedWindow}t.exposeWebInspectorNamespace&&(window.webInspector=z),r($,z)},self.buildExtensionAPIInjectedScript=function(e,t,n,s,i){const r=[e,t||null,n,s].map((e=>JSON.stringify(e))).join(",");return i||(i=()=>{}),"(function(injectedScriptId){ ("+self.injectedExtensionAPI.toString()+")("+r+","+i+", injectedScriptId);})"};var p=Object.freeze({__proto__:null});class g extends n.Widget.Widget{server;id;iframe;frameIndex;constructor(e,t,n,s){super(),this.setHideOnDetach(),this.element.className="vbox flex-auto",this.element.tabIndex=-1,this.server=e,this.id=t,this.iframe=document.createElement("iframe"),this.iframe.addEventListener("load",this.onLoad.bind(this),!1),this.iframe.src=n,this.iframe.className=s,this.setDefaultFocusedElement(this.element),this.element.appendChild(this.iframe)}wasShown(){super.wasShown(),"number"==typeof this.frameIndex&&this.server.notifyViewShown(this.id,this.frameIndex)}willHide(){"number"==typeof this.frameIndex&&this.server.notifyViewHidden(this.id)}onLoad(){const e=window.frames;this.frameIndex=Array.prototype.indexOf.call(e,this.iframe.contentWindow),this.isShowing()&&this.server.notifyViewShown(this.id,this.frameIndex)}}class m extends n.Widget.VBox{server;id;constructor(e,t){super(),this.server=e,this.id=t}wasShown(){this.server.notifyViewShown(this.id)}willHide(){this.server.notifyViewHidden(this.id)}}var f=Object.freeze({__proto__:null,ExtensionView:g,ExtensionNotifierView:m});class b extends n.Panel.Panel{server;id;panelToolbar;searchableViewInternal;constructor(e,t,s,i){super(t),this.server=e,this.id=s,this.setHideOnDetach(),this.panelToolbar=new n.Toolbar.Toolbar("hidden",this.element),this.searchableViewInternal=new n.SearchableView.SearchableView(this,null),this.searchableViewInternal.show(this.element);new g(e,this.id,i,"extension").show(this.searchableViewInternal.element)}addToolbarItem(e){this.panelToolbar.element.classList.remove("hidden"),this.panelToolbar.appendToolbarItem(e)}onSearchCanceled(){this.server.notifySearchAction(this.id,"cancelSearch"),this.searchableViewInternal.updateSearchMatchesCount(0)}searchableView(){return this.searchableViewInternal}performSearch(e,t,n){const s=e.query;this.server.notifySearchAction(this.id,"performSearch",s)}jumpToNextSearchResult(){this.server.notifySearchAction(this.id,"nextSearchResult")}jumpToPreviousSearchResult(){this.server.notifySearchAction(this.id,"previousSearchResult")}supportsCaseSensitiveSearch(){return!1}supportsRegexSearch(){return!1}}class w{id;toolbarButtonInternal;constructor(e,t,s,i,r){this.id=t,this.toolbarButtonInternal=new n.Toolbar.ToolbarButton("",""),this.toolbarButtonInternal.addEventListener(n.Toolbar.ToolbarButton.Events.Click,e.notifyButtonClicked.bind(e,this.id)),this.update(s,i,r)}update(e,t,n){"string"==typeof e&&this.toolbarButtonInternal.setBackgroundImage(e),"string"==typeof t&&this.toolbarButtonInternal.setTitle(t),"boolean"==typeof n&&this.toolbarButtonInternal.setEnabled(!n)}toolbarButton(){return this.toolbarButtonInternal}}class R extends n.View.SimpleView{panelNameInternal;server;idInternal;extensionView;objectPropertiesView;constructor(e,t,n,s){super(n),this.element.classList.add("fill"),this.panelNameInternal=t,this.server=e,this.idInternal=s}id(){return this.idInternal}panelName(){return this.panelNameInternal}setObject(e,n,s){this.createObjectPropertiesView(),this.setObjectInternal(t.RemoteObject.RemoteObject.fromLocalObject(e),n,s)}setExpression(e,t,n,s,i){this.createObjectPropertiesView(),this.server.evaluate(e,!0,!1,n,s,this.onEvaluate.bind(this,t,i))}setPage(e){this.objectPropertiesView&&(this.objectPropertiesView.detach(),delete this.objectPropertiesView),this.extensionView&&this.extensionView.detach(!0),this.extensionView=new g(this.server,this.idInternal,e,"extension fill"),this.extensionView.show(this.element),this.element.style.height||this.setHeight("150px")}setHeight(e){this.element.style.height=e}onEvaluate(e,t,n,s,i){n?t(n.toString()):s?this.setObjectInternal(s,e,t):t()}createObjectPropertiesView(){this.objectPropertiesView||(this.extensionView&&(this.extensionView.detach(!0),delete this.extensionView),this.objectPropertiesView=new m(this.server,this.idInternal),this.objectPropertiesView.show(this.element))}setObjectInternal(e,t,s){const i=this.objectPropertiesView;i?(i.element.removeChildren(),n.UIUtils.Renderer.render(e,{title:t,editable:!1}).then((e=>{if(!e)return void s();const t=e.tree&&e.tree.firstChild();t&&t.expand(),i.element.appendChild(e.node),s()}))):s("operation cancelled")}}var E=Object.freeze({__proto__:null,ExtensionPanel:b,ExtensionButton:w,ExtensionSidebarPane:R});class y{extensionOrigin;id;categoryName;categoryTooltip;constructor(e,t,n,s){this.extensionOrigin=e,this.id=t,this.categoryName=n,this.categoryTooltip=s}start(e){const t=String(++I);M.instance().startTraceRecording(this.id,t,e)}stop(){M.instance().stopTraceRecording(this.id)}shortDisplayName(){return this.categoryName}longDisplayName(){return this.categoryTooltip}persistentIdentifier(){return`${this.extensionOrigin}/${this.categoryName}`}}let I=0;var v=Object.freeze({__proto__:null,ExtensionTraceProvider:y});class x{port;nextRequestId=0;pendingRequests;constructor(e){this.port=e,this.port.onmessage=this.onResponse.bind(this),this.pendingRequests=new Map}sendRequest(e,t){return new Promise(((n,s)=>{const i=this.nextRequestId++;this.pendingRequests.set(i,{resolve:n,reject:s}),this.port.postMessage({requestId:i,method:e,parameters:t})}))}disconnect(){for(const{reject:e}of this.pendingRequests.values())e(new Error("Extension endpoint disconnected"));this.pendingRequests.clear(),this.port.close()}onResponse({data:e}){if("event"in e)return void this.handleEvent(e);const{requestId:t,result:n,error:s}=e,i=this.pendingRequests.get(t);i?(this.pendingRequests.delete(t),s?i.reject(new Error(s.message)):i.resolve(n)):console.error(`No pending request ${t}`)}handleEvent(e){throw new Error("handleEvent is not implemented")}}class _ extends x{plugin;constructor(e,t){super(t),this.plugin=e}handleEvent({event:e}){switch(e){case"unregisteredLanguageExtensionPlugin":{this.disconnect();const{pluginManager:e}=u.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance();e&&e.removePlugin(this.plugin);break}}}}class S{supportedScriptTypes;endpoint;name;constructor(e,t,n){this.name=e,this.supportedScriptTypes=t,this.endpoint=new _(this,n)}handleScript(e){const t=e.scriptLanguage();return null!==t&&null!==e.debugSymbols&&t===this.supportedScriptTypes.language&&this.supportedScriptTypes.symbol_types.includes(e.debugSymbols.type)}addRawModule(e,t,n){return this.endpoint.sendRequest("addRawModule",{rawModuleId:e,symbolsURL:t,rawModule:n})}removeRawModule(e){return this.endpoint.sendRequest("removeRawModule",{rawModuleId:e})}sourceLocationToRawLocation(e){return this.endpoint.sendRequest("sourceLocationToRawLocation",{sourceLocation:e})}rawLocationToSourceLocation(e){return this.endpoint.sendRequest("rawLocationToSourceLocation",{rawLocation:e})}getScopeInfo(e){return this.endpoint.sendRequest("getScopeInfo",{type:e})}listVariablesInScope(e){return this.endpoint.sendRequest("listVariablesInScope",{rawLocation:e})}getFunctionInfo(e){return this.endpoint.sendRequest("getFunctionInfo",{rawLocation:e})}getInlinedFunctionRanges(e){return this.endpoint.sendRequest("getInlinedFunctionRanges",{rawLocation:e})}getInlinedCalleesRanges(e){return this.endpoint.sendRequest("getInlinedCalleesRanges",{rawLocation:e})}getTypeInfo(e,t){return this.endpoint.sendRequest("getTypeInfo",{expression:e,context:t})}getFormatter(e,t){return this.endpoint.sendRequest("getFormatter",{expressionOrField:e,context:t})}getInspectableAddress(e){return this.endpoint.sendRequest("getInspectableAddress",{field:e})}async getMappedLines(e,t){return this.endpoint.sendRequest("getMappedLines",{rawModuleId:e,sourceFileURL:t})}evaluate(e,t,n){return this.endpoint.sendRequest("formatValue",{expression:e,context:t,stopId:n})}getProperties(e){return this.endpoint.sendRequest("getProperties",{objectId:e})}releaseObject(e){return this.endpoint.sendRequest("releaseObject",{objectId:e})}}let T=null;class O extends s.ObjectWrapper.ObjectWrapper{#e=new Set;static instance(){return T||(T=new O),T}addPlugin(e){this.#e.add(e),this.dispatchEventToListeners(P.PluginAdded,e)}removePlugin(e){this.#e.delete(e),this.dispatchEventToListeners(P.PluginRemoved,e)}plugins(){return Array.from(this.#e.values())}}var P;!function(e){e.PluginAdded="pluginAdded",e.PluginRemoved="pluginRemoved"}(P||(P={}));var A=Object.freeze({__proto__:null,RecorderPluginManager:O,get Events(){return P}});class L extends x{name;mediaType;constructor(e,t,n){super(n),this.name=e,this.mediaType=t}getName(){return this.name}getMediaType(){return this.mediaType}handleEvent({event:e}){if("unregisteredRecorderExtensionPlugin"!==e)throw new Error(`Unrecognized Recorder extension endpoint event: ${e}`);this.disconnect(),O.instance().removePlugin(this)}stringify(e){return this.sendRequest("stringify",{recording:e})}stringifyStep(e){return this.sendRequest("stringifyStep",{step:e})}}var C=Object.freeze({__proto__:null,RecorderExtensionEndpoint:L});const H=new WeakMap,q=["chrome://newtab","chrome://new-tab-page"].map((e=>new URL(e).origin));let k;class M extends s.ObjectWrapper.ObjectWrapper{clientObjects;handlers;subscribers;subscriptionStartHandlers;subscriptionStopHandlers;extraHeaders;requests;requestIds;lastRequestId;registeredExtensions;status;sidebarPanesInternal;traceProvidersInternal;traceSessions;extensionsEnabled;inspectedTabId;extensionAPITestHook;themeChangeHandlers=new Map;constructor(){super(),this.clientObjects=new Map,this.handlers=new Map,this.subscribers=new Map,this.subscriptionStartHandlers=new Map,this.subscriptionStopHandlers=new Map,this.extraHeaders=new Map,this.requests=new Map,this.requestIds=new Map,this.lastRequestId=0,this.registeredExtensions=new Map,this.status=new D,this.sidebarPanesInternal=[],this.traceProvidersInternal=[],this.traceSessions=new Map,this.extensionsEnabled=!0,this.registerHandler("addRequestHeaders",this.onAddRequestHeaders.bind(this)),this.registerHandler("addTraceProvider",this.onAddTraceProvider.bind(this)),this.registerHandler("applyStyleSheet",this.onApplyStyleSheet.bind(this)),this.registerHandler("completeTra.eSession",this.onCompleteTraceSession.bind(this)),this.registerHandler("createPanel",this.onCreatePanel.bind(this)),this.registerHandler("createSidebarPane",this.onCreateSidebarPane.bind(this)),this.registerHandler("createToolbarButton",this.onCreateToolbarButton.bind(this)),this.registerHandler("evaluateOnInspectedPage",this.onEvaluateOnInspectedPage.bind(this)),this.registerHandler("_forwardKeyboardEvent",this.onForwardKeyboardEvent.bind(this)),this.registerHandler("getHAR",this.onGetHAR.bind(this)),this.registerHandler("getPageResources",this.onGetPageResources.bind(this)),this.registerHandler("getRequestContent",this.onGetRequestContent.bind(this)),this.registerHandler("getResourceContent",this.onGetResourceContent.bind(this)),this.registerHandler("Reload",this.onReload.bind(this)),this.registerHandler("setOpenResourceHandler",this.onSetOpenResourceHandler.bind(this)),this.registerHandler("setThemeChangeHandler",this.onSetThemeChangeHandler.bind(this)),this.registerHandler("setResourceContent",this.onSetResourceContent.bind(this)),this.registerHandler("setSidebarHeight",this.onSetSidebarHeight.bind(this)),this.registerHandler("setSidebarContent",this.onSetSidebarContent.bind(this)),this.registerHandler("setSidebarPage",this.onSetSidebarPage.bind(this)),this.registerHandler("showPanel",this.onShowPanel.bind(this)),this.registerHandler("subscribe",this.onSubscribe.bind(this)),this.registerHandler("openResource",this.onOpenResource.bind(this)),this.registerHandler("unsubscribe",this.onUnsubscribe.bind(this)),this.registerHandler("updateButton",this.onUpdateButton.bind(this)),this.registerHandler("registerLanguageExtensionPlugin",this.registerLanguageExtensionEndpoint.bind(this)),this.registerHandler("getWasmLinearMemory",this.onGetWasmLinearMemory.bind(this)),this.registerHandler("getWasmGlobal",this.onGetWasmGlobal.bind(this)),this.registerHandler("getWasmLocal",this.onGetWasmLocal.bind(this)),this.registerHandler("getWasmOp",this.onGetWasmOp.bind(this)),this.registerHandler("registerRecorderExtensionPlugin",this.registerRecorderExtensionEndpoint.bind(this)),window.addEventListener("message",this.onWindowMessage,!1);const e=window.DevToolsAPI&&window.DevToolsAPI.getInspectedTabId&&window.DevToolsAPI.getInspectedTabId();e&&this.setInspectedTabId({data:e}),i.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(i.InspectorFrontendHostAPI.Events.SetInspectedTabId,this.setInspectedTabId,this),this.initExtensions(),d.ThemeSupport.instance().addEventListener(d.ThemeChangeEvent.eventName,this.#t)}dispose(){d.ThemeSupport.instance().removeEventListener(d.ThemeChangeEvent.eventName,this.#t),t.TargetManager.TargetManager.instance().removeEventListener(t.TargetManager.Events.InspectedURLChanged,this.inspectedURLChanged,this),i.InspectorFrontendHost.InspectorFrontendHostInstance.events.removeEventListener(i.InspectorFrontendHostAPI.Events.SetInspectedTabId,this.setInspectedTabId,this),window.removeEventListener("message",this.onWindowMessage,!1)}#t=()=>{const e=d.ThemeSupport.instance().themeName();for(const t of this.themeChangeHandlers.values())t.postMessage({command:"host-theme-change",themeName:e})};static instance(e={forceNew:null}){const{forceNew:t}=e;return k&&!t||(k?.dispose(),k=new M),k}initializeExtensions(){null!==this.inspectedTabId&&i.InspectorFrontendHost.InspectorFrontendHostInstance.setAddExtensionCallback(this.addExtension.bind(this))}hasExtensions(){return Boolean(this.registeredExtensions.size)}notifySearchAction(e,t,n){this.postNotification("panel-search-"+e,t,n)}notifyViewShown(e,t){this.postNotification("view-shown-"+e,t)}notifyViewHidden(e){this.postNotification("view-hidden,"+e)}notifyButtonClicked(e){this.postNotification("button-clicked-"+e)}registerLanguageExtensionEndpoint(e,t){if("registerLanguageExtensionPlugin"!==e.command)return this.status.E_BADARG("command","expected registerLanguageExtensionPlugin");const{pluginManager:n}=u.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance();if(!n)return this.status.E_FAILED("WebAssembly DWARF support needs to be enabled to use this extension");const{pluginName:s,port:i,supportedScriptTypes:{language:r,symbol_types:o}}=e,a=Array.isArray(o)&&o.every((e=>"string"==typeof e))?o:[],c=new S(s,{language:r,symbol_types:a},i);return n.addPlugin(c),this.status.OK()}async loadWasmValue(e,t){const{pluginManager:n}=u.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance();if(!n)return this.status.E_FAILED("WebAssembly DWARF support needs to be enabled to use this extension");const s=n.callFrameForStopId(t);if(!s)return this.status.E_BADARG("stopId","Unknown stop id");const i=await s.debuggerModel.agent.invoke_evaluateOnCallFrame({callFrameId:s.id,expression:e,silent:!0,returnByValue:!0,throwOnSideEffect:!0});return i.exceptionDetails||i.getError()?this.status.E_FAILED("Failed"):i.result.value}async onGetWasmLinearMemory(e){return"getWasmLinearMemory"!==e.command?this.status.E_BADARG("command","expected getWasmLinearMemory"):await this.loadWasmValue(`[].slice.call(new Uint8Array(memories[0].buffer, ${Number(e.offset)}, ${Number(e.length)}))`,e.stopId)}async onGetWasmGlobal(e){return"getWasmGlobal"!==e.command?this.status.E_BADARG("command","expected getWasmGlobal"):this.loadWasmValue(`globals[${Number(e.global)}]`,e.stopId)}async onGetWasmLocal(e){return"getWasmLocal"!==e.command?this.status.E_BADARG("command","expected getWasmLocal"):this.loadWasmValue(`locals[${Number(e.local)}]`,e.stopId)}async onGetWasmOp(e){return"getWasmOp"!==e.command?this.status.E_BADARG("command","expected getWasmOp"):this.loadWasmValue(`stack[${Number(e.op)}]`,e.stopId)}registerRecorderExtensionEndpoint(e,t){if("registerRecorderExtensionPlugin"!==e.command)return this.status.E_BADARG("command","expected registerRecorderExtensionPlugin");const{pluginName:n,mediaType:s,port:i}=e;return O.instance().addPlugin(new L(n,s,i)),this.status.OK()}inspectedURLChanged(e){if(!this.canInspectURL(e.data.inspectedURL()))return void this.disableExtensions();if(e.data!==t.TargetManager.TargetManager.instance().mainFrameTarget())return;this.requests=new Map;const n=e.data.inspectedURL();this.postNotification("inspected-url-changed",n)}startTraceRecording(e,t,n){this.traceSessions.set(t,n),this.postNotification("trace-recording-started-"+e,t)}stopTraceRecording(e){this.postNotification("trace-recording-stopped-"+e)}hasSubscribers(e){return this.subscribers.has(e)}postNotification(e,...t){if(!this.extensionsEnabled)return;const n=this.subscribers.get(e);if(!n)return;const s={command:"notify-"+e,arguments:Array.prototype.slice.call(arguments,1)};for(const e of n)e.postMessage(s)}onSubscribe(e,t){if("subscribe"!==e.command)return this.status.E_BADARG("command","expected subscribe");const n=this.subscribers.get(e.type);if(n)n.add(t);else{this.subscribers.set(e.type,new Set([t]));const n=this.subscriptionStartHandlers.get(e.type);n&&n()}}onUnsubscribe(e,t){if("unsubscribe"!==e.command)return this.status.E_BADARG("command","expected unsubscribe");const n=this.subscribers.get(e.type);if(n&&(n.delete(t),!n.size)){this.subscribers.delete(e.type);const t=this.subscriptionStopHandlers.get(e.type);t&&t()}}onAddRequestHeaders(e){if("addRequestHeaders"!==e.command)return this.status.E_BADARG("command","expected addRequestHeaders");const n=e.extensionId;if("string"!=typeof n)return this.status.E_BADARGTYPE("extensionId",typeof n,"string");let s=this.extraHeaders.get(n);s||(s=new Map,this.extraHeaders.set(n,s));for(const t in e.headers)s.set(t,e.headers[t]);const i={};for(const e of this.extraHeaders.values())for(const[t,n]of e)"__proto__"!==t&&"string"==typeof n&&(i[t]=n);t.NetworkManager.MultitargetNetworkManager.instance().setExtraHTTPHeaders(i)}onApplyStyleSheet(e){if("applyStyleSheet"!==e.command)return this.status.E_BADARG("command","expected applyStyleSheet");if(!o.Runtime.experiments.isEnabled("applyCustomStylesheet"))return;const t=document.createElement("style");t.textContent=e.styleSheet,document.head.appendChild(t),d.ThemeSupport.instance().addCustomStylesheet(e.styleSheet);for(let e=document.body;e;e=e.traverseNextNode(document.body))e instanceof ShadowRoot&&d.ThemeSupport.instance().injectCustomStyleSheets(e)}getExtensionOrigin(e){const t=H.get(e);if(!t)throw new Error("Received a message from an unregistered extension");return t}onCreatePanel(e,t){if("createPanel"!==e.command)return this.status.E_BADARG("command","expected createPanel");const s=e.id;if(this.clientObjects.has(s)||n.InspectorView.InspectorView.instance().hasPanel(s))return this.status.E_EXISTS(s);const i=M.expandResourcePath(this.getExtensionOrigin(t),e.page);if(void 0===i)return this.status.E_BADARG("page","Resources paths cannot point to non-extension resources");let o=this.getExtensionOrigin(t)+e.title;o=o.replace(/\s/g,"");const a=new j(o,r.i18n.lockedString(e.title),new b(this,o,s,i));return this.clientObjects.set(s,a),n.InspectorView.InspectorView.instance().addPanel(a),this.status.OK()}onShowPanel(e){if("showPanel"!==e.command)return this.status.E_BADARG("command","expected showPanel");let t=e.id;const s=this.clientObjects.get(e.id);s&&s instanceof j&&(t=s.viewId()),n.InspectorView.InspectorView.instance().showPanel(t)}onCreateToolbarButton(e,t){if("createToolbarButton"!==e.command)return this.status.E_BADARG("command","expected createToolbarButton");const n=this.clientObjects.get(e.panel);if(!(n&&n instanceof j))return this.status.E_NOTFOUND(e.panel);const s=M.expandResourcePath(this.getExtensionOrigin(t),e.icon);if(void 0===s)return this.status.E_BADARG("icon","Resources paths cannot point to non-extension resources");const i=new w(this,e.id,s,e.tooltip,e.disabled);return this.clientObjects.set(e.id,i),n.widget().then((function(e){e.addToolbarItem(i.toolbarButton())})),this.status.OK()}onUpdateButton(e,t){if("updateButton"!==e.command)return this.status.E_BADARG("command","expected updateButton");const n=this.clientObjects.get(e.id);if(!(n&&n instanceof w))return this.status.E_NOTFOUND(e.id);const s=e.icon&&M.expandResourcePath(this.getExtensionOrigin(t),e.icon);return e.icon&&void 0===s?this.status.E_BADARG("icon","Resources paths cannot point to non-extension resources"):(n.update(s,e.tooltip,e.disabled),this.status.OK())}onCompleteTraceSession(e){if("completeTra.eSession"!==e.command)return this.status.E_BADARG("command","expected completeTra.eSession");const t=this.traceSessions.get(e.id);if(!t)return this.status.E_NOTFOUND(e.id);this.traceSessions.delete(e.id),t.complete(e.url,e.timeOffset)}onCreateSidebarPane(e){if("createSidebarPane"!==e.command)return this.status.E_BADARG("command","expected createSidebarPane");const t=e.id,n=new R(this,e.panel,r.i18n.lockedString(e.title),t);return this.sidebarPanesInternal.push(n),this.clientObjects.set(t,n),this.dispatchEventToListeners(N.SidebarPaneAdded,n),this.status.OK()}sidebarPanes(){return this.sidebarPanesInternal}onSetSidebarHeight(e){if("setSidebarHeight"!==e.command)return this.status.E_BADARG("command","expected setSidebarHeight");const t=this.clientObjects.get(e.id);return t&&t instanceof R?(t.setHeight(e.height),this.status.OK()):this.status.E_NOTFOUND(e.id)}onSetSidebarContent(e,t){if("setSidebarContent"!==e.command)return this.status.E_BADARG("command","expected setSidebarContent");const{requestId:n,id:s,rootTitle:i,expression:r,evaluateOptions:o,evaluateOnPage:a}=e,c=this.clientObjects.get(s);if(!(c&&c instanceof R))return this.status.E_NOTFOUND(e.id);function d(e){const s=e?this.status.E_FAILED(e):this.status.OK();this.dispatchCallback(n,t,s)}a?c.setExpression(r,i,o,this.getExtensionOrigin(t),d.bind(this)):c.setObject(e.expression,e.rootTitle,d.bind(this))}onSetSidebarPage(e,t){if("setSidebarPage"!==e.command)return this.status.E_BADARG("command","expected setSidebarPage");const n=this.clientObjects.get(e.id);if(!(n&&n instanceof R))return this.status.E_NOTFOUND(e.id);const s=M.expandResourcePath(this.getExtensionOrigin(t),e.page);if(void 0===s)return this.status.E_BADARG("page","Resources paths cannot point to non-extension resources");n.setPage(s)}onOpenResource(e){if("openResource"!==e.command)return this.status.E_BADARG("command","expected openResource");const t=h.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(e.url);if(t)return s.Revealer.reveal(t.uiLocation(e.lineNumber,e.columnNumber)),this.status.OK();const n=u.ResourceUtils.resourceForURL(e.url);if(n)return s.Revealer.reveal(n),this.status.OK();const i=a.NetworkLog.NetworkLog.instance().requestForURL(e.url);return i?(s.Revealer.reveal(i),this.status.OK()):this.status.E_NOTFOUND(e.url)}onSetOpenResourceHandler(e,t){if("setOpenResourceHandler"!==e.command)return this.status.E_BADARG("command","expected setOpenResourceHandler");const n=this.registeredExtensions.get(this.getExtensionOrigin(t));if(!n)throw new Error("Received a message from an unregistered extension");const{name:s}=n;e.handlerPresent?c.Linkifier.Linkifier.registerLinkHandler(s,this.handleOpenURL.bind(this,t)):c.Linkifier.Linkifier.unregisterLinkHandler(s)}onSetThemeChangeHandler(e,t){if("setThemeChangeHandler"!==e.command)return this.status.E_BADARG("command","expected setThemeChangeHandler");const n=this.getExtensionOrigin(t);if(!this.registeredExtensions.get(n))throw new Error("Received a message from an unregistered extension");e.handlerPresent?this.themeChangeHandlers.set(n,t):this.themeChangeHandlers.delete(n)}handleOpenURL(e,t,n){e.postMessage({command:"open-resource",resource:this.makeResource(t),lineNumber:n+1})}onReload(e){if("Reload"!==e.command)return this.status.E_BADARG("command","expected Reload");const n=e.options||{};let s;return t.NetworkManager.MultitargetNetworkManager.instance().setUserAgentOverride("string"==typeof n.userAgent?n.userAgent:"",null),n.injectedScript&&(s="(function(){"+n.injectedScript+"})()"),t.ResourceTreeModel.ResourceTreeModel.reloadAllPages(Boolean(n.ignoreCache),s),this.status.OK()}onEvaluateOnInspectedPage(e,t){if("evaluateOnInspectedPage"!==e.command)return this.status.E_BADARG("command","expected evaluateOnInspectedPage");const{requestId:n,expression:s,evaluateOptions:i}=e;return this.evaluate(s,!0,!0,i,this.getExtensionOrigin(t),function(e,s,i){let r;r=e||!s?this.status.E_PROTOCOLERROR(e?.toString()):i?{isException:!0,value:s.description}:{value:s.value},this.dispatchCallback(n,t,r)}.bind(this))}async onGetHAR(e){if("getHAR"!==e.command)return this.status.E_BADARG("command","expected getHAR");const t=a.NetworkLog.NetworkLog.instance().requests(),n=await l.Log.Log.build(t);for(let e=0;e<n.entries.length;++e)n.entries[e]._requestId=this.requestId(t[e]);return n}makeResource(e){return{url:e.contentURL(),type:e.contentType().name()}}onGetPageResources(){const e=new Map;function n(t){return e.has(t.contentURL())||e.set(t.contentURL(),this.makeResource(t)),!1}let s=h.Workspace.WorkspaceImpl.instance().uiSourceCodesForProjectType(h.Workspace.projectTypes.Network);s=s.concat(h.Workspace.WorkspaceImpl.instance().uiSourceCodesForProjectType(h.Workspace.projectTypes.ContentScripts)),s.forEach(n.bind(this));for(const e of t.TargetManager.TargetManager.instance().models(t.ResourceTreeModel.ResourceTreeModel))e.forAllResources(n.bind(this));return[...e.values()]}async getResourceContent(e,t,n){const{content:s,isEncoded:i}=await e.requestContent();this.dispatchCallback(t.requestId,n,{encoding:i?"base64":"",content:s})}onGetRequestContent(e,t){if("getRequestContent"!==e.command)return this.status.E_BADARG("command","expected getRequestContent");const n=this.requestById(e.id);if(!n)return this.status.E_NOTFOUND(e.id);this.getResourceContent(n,e,t)}onGetResourceContent(e,t){if("getResourceContent"!==e.command)return this.status.E_BADARG("command","expected getResourceContent");const n=e.url,s=h.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(n)||u.ResourceUtils.resourceForURL(n);if(!s)return this.status.E_NOTFOUND(n);this.getResourceContent(s,e,t)}onSetResourceContent(e,n){if("setResourceContent"!==e.command)return this.status.E_BADARG("command","expected setResourceContent");const{url:s,requestId:i,content:r,commit:o}=e;const a=h.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(s);if(!a||!a.contentType().isDocumentOrScriptOrStyleSheet()){return t.ResourceTreeModel.ResourceTreeModel.resourceForURL(s)?this.status.E_NOTSUPPORTED("Resource is not editable"):this.status.E_NOTFOUND(s)}a.setWorkingCopy(r),o&&a.commitWorkingCopy(),function(e){const t=e?this.status.E_FAILED(e):this.status.OK();this.dispatchCallback(i,n,t)}.call(this,null)}requestId(e){const t=this.requestIds.get(e);if(void 0===t){const t=++this.lastRequestId;return this.requestIds.set(e,t),this.requests.set(t,e),t}return t}requestById(e){return this.requests.get(e)}onAddTraceProvider(e,t){if("addTraceProvider"!==e.command)return this.status.E_BADARG("command","expected addTraceProvider");const n=new y(this.getExtensionOrigin(t),e.id,e.categoryName,e.categoryTooltip);this.clientObjects.set(e.id,n),this.traceProvidersInternal.push(n),this.dispatchEventToListeners(N.TraceProviderAdded,n)}traceProviders(){return this.traceProvidersInternal}onForwardKeyboardEvent(t){if("_forwardKeyboardEvent"!==t.command)return this.status.E_BADARG("command","expected _forwardKeyboardEvent");t.entries.forEach((function(t){const n=new window.KeyboardEvent(t.eventType,{key:t.key,code:t.code,keyCode:t.keyCode,location:t.location,ctrlKey:t.ctrlKey,altKey:t.altKey,shiftKey:t.shiftKey,metaKey:t.metaKey});n.__keyCode=function(t){let n=t.keyCode;n||t.key===e.KeyboardUtilities.ESCAPE_KEY&&(n=27);return n||0}(t),document.dispatchEvent(n)}))}dispatchCallback(e,t,n){e&&t.postMessage({command:"callback",requestId:e,result:n})}initExtensions(){this.registerAutosubscriptionHandler("resource-added",h.Workspace.WorkspaceImpl.instance(),h.Workspace.Events.UISourceCodeAdded,this.notifyResourceAdded),this.registerAutosubscriptionTargetManagerHandler("network-request-finished",t.NetworkManager.NetworkManager,t.NetworkManager.Events.RequestFinished,this.notifyRequestFinished),this.registerSubscriptionHandler("panel-objectSelected-elements",function(){n.Context.Context.instance().addFlavorChangeListener(t.DOMModel.DOMNode,this.notifyElementsSelectionChanged,this)}.bind(this),function(){n.Context.Context.instance().removeFlavorChangeListener(t.DOMModel.DOMNode,this.notifyElementsSelectionChanged,this)}.bind(this)),this.registerResourceContentCommittedHandler(this.notifyUISourceCodeContentCommitted),t.TargetManager.TargetManager.instance().addEventListener(t.TargetManager.Events.InspectedURLChanged,this.inspectedURLChanged,this)}notifyResourceAdded(e){const t=e.data;this.postNotification("resource-added",this.makeResource(t))}notifyUISourceCodeContentCommitted(e){const{uiSourceCode:t,content:n}=e.data;this.postNotification("resource-content-committed",this.makeResource(t),n)}async notifyRequestFinished(e){const t=e.data,n=await l.Log.Entry.build(t);this.postNotification("network-request-finished",this.requestId(t),n)}notifyElementsSelectionChanged(){this.postNotification("panel-objectSelected-elements")}sourceSelectionChanged(e,t){this.postNotification("panel-objectSelected-sources",{startLine:t.startLine,startColumn:t.startColumn,endLine:t.endLine,endColumn:t.endColumn,url:e})}setInspectedTabId(e){const t=this.inspectedTabId;this.inspectedTabId=e.data,null===t&&this.initializeExtensions()}addExtensionForTest(e,t){const n=e.name||`Extension ${t}`;return this.registeredExtensions.set(t,{name:n}),!0}addExtension(e){const s=e.startPage,r=t.TargetManager.TargetManager.instance().mainFrameTarget()?.inspectedURL()??"";if(""===r||this.canInspectURL(r)||this.disableExtensions(),this.extensionsEnabled){try{const t=new URL(s).origin;if(!this.registeredExtensions.get(t)){const s=self.buildExtensionAPIInjectedScript(e,this.inspectedTabId,d.ThemeSupport.instance().themeName(),n.ShortcutRegistry.ShortcutRegistry.instance().globalShortcutKeys(),M.instance().extensionAPITestHook);i.InspectorFrontendHost.InspectorFrontendHostInstance.setInjectedScriptForOrigin(t,s);const r=e.name||`Extension ${t}`;this.registeredExtensions.set(t,{name:r})}const r=document.createElement("iframe");r.src=s,r.dataset.devtoolsExtension=e.name,r.style.display="none",document.body.appendChild(r)}catch(e){return console.error("Failed to initialize extension "+s+":"+e),!1}return!0}}registerExtension(e,t){this.registeredExtensions.has(e)?(H.set(t,e),t.addEventListener("message",this.onmessage.bind(this),!1),t.start()):e!==window.location.origin&&console.error("Ignoring unauthorized client request from "+e)}onWindowMessage=e=>{"registerExtension"===e.data&&this.registerExtension(e.origin,e.ports[0])};async onmessage(e){const t=e.data;let n;const s=this.handlers.get(t.command);n=s?this.extensionsEnabled?await s(t,e.target):this.status.E_FAILED("Permission denied"):this.status.E_NOTSUPPORTED(t.command),n&&t.requestId&&this.dispatchCallback(t.requestId,e.target,n)}registerHandler(e,t){console.assert(Boolean(e)),this.handlers.set(e,t)}registerSubscriptionHandler(e,t,n){this.subscriptionStartHandlers.set(e,t),this.subscriptionStopHandlers.set(e,n)}registerAutosubscriptionHandler(e,t,n,s){this.registerSubscriptionHandler(e,(()=>t.addEventListener(n,s,this)),(()=>t.removeEventListener(n,s,this)))}registerAutosubscriptionTargetManagerHandler(e,n,s,i){this.registerSubscriptionHandler(e,(()=>t.TargetManager.TargetManager.instance().addModelListener(n,s,i,this)),(()=>t.TargetManager.TargetManager.instance().removeModelListener(n,s,i,this)))}registerResourceContentCommittedHandler(e){this.registerSubscriptionHandler("resource-content-committed",function(){h.Workspace.WorkspaceImpl.instance().addEventListener(h.Workspace.Events.WorkingCopyCommittedByUser,e,this),h.Workspace.WorkspaceImpl.instance().setHasResourceContentTrackingExtensions(!0)}.bind(this),function(){h.Workspace.WorkspaceImpl.instance().setHasResourceContentTrackingExtensions(!1),h.Workspace.WorkspaceImpl.instance().removeEventListener(h.Workspace.Events.WorkingCopyCommittedByUser,e,this)}.bind(this))}static expandResourcePath(e,t){const n=new URL(e).origin,i=new URL(s.ParsedURL.normalizePath(t),n);if(i.origin===n)return i.href}evaluate(e,n,s,i,r,o){let a,c,d;if((i=i||{}).frameURL)c=function(e){let n=null;return t.ResourceTreeModel.ResourceTreeModel.frames().some((function(t){return n=t.url===e?t:null,n})),n}(i.frameURL);else{const e=t.TargetManager.TargetManager.instance().mainFrameTarget(),n=e&&e.model(t.ResourceTreeModel.ResourceTreeModel);c=n&&n.mainFrame}if(!c)return i.frameURL?console.warn("evaluate: there is no frame with URL "+i.frameURL):console.warn("evaluate: the main frame is not yet available"),this.status.E_NOTFOUND(i.frameURL||"<top>");if(!this.canInspectURL(c.url))return this.status.E_FAILED("Permission denied");i.useContentScriptContext?d=r:i.scriptExecutionContext&&(d=i.scriptExecutionContext);const u=c.resourceTreeModel().target().model(t.RuntimeModel.RuntimeModel),l=u?u.executionContexts():[];if(d){for(let e=0;e<l.length;++e){const t=l[e];t.frameId!==c.id||t.origin!==d||t.isDefault||(a=t)}if(!a)return console.warn("The JavaScript context "+d+" was not found in the frame "+c.url),this.status.E_NOTFOUND(d)}else{for(let e=0;e<l.length;++e){const t=l[e];t.frameId===c.id&&t.isDefault&&(a=t)}if(!a)return this.status.E_FAILED(c.url+" has no execution context")}if(!this.canInspectURL(a.origin))return this.status.E_FAILED("Permission denied");a.evaluate({expression:e,objectGroup:"extension",includeCommandLineAPI:n,silent:!0,returnByValue:s,generatePreview:!1},!1,!1).then((function(e){if("error"in e)return void o(e.error,null,!1);o(null,e.object||null,Boolean(e.exceptionDetails))}))}canInspectURL(e){let t;try{t=new URL(e)}catch(e){return!1}return!!q.includes(t.origin)||"chrome:"!==t.protocol&&"devtools:"!==t.protocol&&((!t.protocol.startsWith("http")||"chrome.google.com"!==t.hostname||!t.pathname.startsWith("/webstore"))&&!(window.DevToolsAPI&&window.DevToolsAPI.getOriginsForbiddenForExtensions&&window.DevToolsAPI.getOriginsForbiddenForExtensions()||[]).includes(t.origin))}disableExtensions(){this.extensionsEnabled=!1}}var N;!function(e){e.SidebarPaneAdded="SidebarPaneAdded",e.TraceProviderAdded="TraceProviderAdded"}(N||(N={}));class j extends n.View.SimpleView{name;panel;constructor(e,t,n){super(t),this.name=e,this.panel=n}viewId(){return this.name}widget(){return Promise.resolve(this.panel)}}class D{OK;E_EXISTS;E_BADARG;E_BADARGTYPE;E_NOTFOUND;E_NOTSUPPORTED;E_PROTOCOLERROR;E_FAILED;constructor(){function t(t,n,...s){const i={code:t,description:n,details:s};return"OK"!==t&&(i.isError=!0,console.error("Extension server error: "+e.StringUtilities.sprintf(n,...s))),i}this.OK=t.bind(null,"OK","OK"),this.E_EXISTS=t.bind(null,"E_EXISTS","Object already exists: %s"),this.E_BADARG=t.bind(null,"E_BADARG","Invalid argument %s: %s"),this.E_BADARGTYPE=t.bind(null,"E_BADARGTYPE","Invalid type for argument %s: got %s, expected %s"),this.E_NOTFOUND=t.bind(null,"E_NOTFOUND","Object not found: %s"),this.E_NOTSUPPORTED=t.bind(null,"E_NOTSUPPORTED","Object does not support requested operation: %s"),this.E_PROTOCOLERROR=t.bind(null,"E_PROTOCOLERROR","Inspector protocol error: %s"),this.E_FAILED=t.bind(null,"E_FAILED","Operation failed: %s")}}var W=Object.freeze({__proto__:null,ExtensionServer:M,get Events(){return N},ExtensionStatus:D});export{p as ExtensionAPI,E as ExtensionPanel,W as ExtensionServer,v as ExtensionTraceProvider,f as ExtensionView,C as RecorderExtensionEndpoint,A as RecorderPluginManager};
