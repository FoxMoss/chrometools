import*as e from"../../core/common/common.js";import*as t from"../../core/sdk/sdk.js";import*as i from"../../core/i18n/i18n.js";import*as o from"../../core/root/root.js";import*as n from"../../ui/legacy/components/color_picker/color_picker.js";import*as s from"../../ui/legacy/legacy.js";import*as r from"../../core/platform/platform.js";import*as a from"../../models/text_utils/text_utils.js";import*as l from"../../ui/legacy/components/data_grid/data_grid.js";import*as d from"../../ui/legacy/components/utils/utils.js";import*as c from"./components/components.js";import*as h from"../../core/host/host.js";class u extends e.ObjectWrapper.ObjectWrapper{currentUrl;constructor(){super(),this.currentUrl=t.TargetManager.TargetManager.instance().inspectedURL(),t.TargetManager.TargetManager.instance().addEventListener(t.TargetManager.Events.InspectedURLChanged,this.#e,this)}#e(){this.currentUrl!==t.TargetManager.TargetManager.instance().inspectedURL()&&(this.currentUrl=t.TargetManager.TargetManager.instance().inspectedURL(),this.dispatchEventToListeners("Reset"))}}var v=Object.freeze({__proto__:null,OverviewController:u});const p={topAppliedToAStatically:"`Top` applied to a statically positioned element",leftAppliedToAStatically:"`Left` applied to a statically positioned element",rightAppliedToAStatically:"`Right` applied to a statically positioned element",bottomAppliedToAStatically:"`Bottom` applied to a statically positioned element",widthAppliedToAnInlineElement:"`Width` applied to an inline element",heightAppliedToAnInlineElement:"`Height` applied to an inline element",verticalAlignmentAppliedTo:"Vertical alignment applied to element which is neither `inline` nor `table-cell`"},m=i.i18n.registerUIStrings("panels/css_overview/CSSOverviewUnusedDeclarations.ts",p),g=i.i18n.getLocalizedString.bind(void 0,m);class w{static add(e,t,i){const o=e.get(t)||[];o.push(i),e.set(t,o)}static checkForUnusedPositionValues(e,t,i,o,n,s,r,a){if("static"===i[o]){if("auto"!==i[n]){const o=g(p.topAppliedToAStatically);this.add(e,o,{declaration:`top: ${i[n]}`,nodeId:t})}if("auto"!==i[s]){const o=g(p.leftAppliedToAStatically);this.add(e,o,{declaration:`left: ${i[s]}`,nodeId:t})}if("auto"!==i[r]){const o=g(p.rightAppliedToAStatically);this.add(e,o,{declaration:`right: ${i[r]}`,nodeId:t})}if("auto"!==i[a]){const o=g(p.bottomAppliedToAStatically);this.add(e,o,{declaration:`bottom: ${i[a]}`,nodeId:t})}}}static checkForUnusedWidthAndHeightValues(e,t,i,o,n,s){if("inline"===i[o]){if("auto"!==i[n]){const o=g(p.widthAppliedToAnInlineElement);this.add(e,o,{declaration:`width: ${i[n]}`,nodeId:t})}if("auto"!==i[s]){const o=g(p.heightAppliedToAnInlineElement);this.add(e,o,{declaration:`height: ${i[s]}`,nodeId:t})}}}static checkForInvalidVerticalAlignment(e,t,i,o,n){if(i[o]&&!i[o].startsWith("inline")&&!i[o].startsWith("table")&&"baseline"!==i[n]){const o=g(p.verticalAlignmentAppliedTo);this.add(e,o,{declaration:`vertical-align: ${i[n]}`,nodeId:t})}}}var f=Object.freeze({__proto__:null,CSSOverviewUnusedDeclarations:w});class b extends t.SDKModel.SDKModel{#t;#i;#o;#n;constructor(e){super(e),this.#t=e.runtimeAgent(),this.#i=e.cssAgent(),this.#o=e.domsnapshotAgent(),this.#n=e.overlayAgent()}highlightNode(t){const i={contentColor:e.Color.PageHighlight.Content.toProtocolRGBA(),showInfo:!0,contrastAlgorithm:o.Runtime.experiments.isEnabled("APCA")?"apca":"aa"};this.#n.invoke_hideHighlight(),this.#n.invoke_highlightNode({backendNodeId:t,highlightConfig:i})}async getNodeStyleStats(){const t=new Map,i=new Map,s=new Map,r=new Map,a=new Map,l=new Map,d=new Map,c=t=>t instanceof e.Color.Legacy?t.hasAlpha()?t.asString("hexa"):t.asString("hex"):t.asString(),h=(t,i,o)=>{if(-1===t)return;const n=f[t];if(!n)return;const s=e.Color.parse(n);if(!s||0===s.asLegacyColor().rgba()[3])return;const r=c(s);if(!r)return;const a=o.get(r)||new Set;return a.add(i),o.set(r,a),s},u=e=>new Set(["altglyph","circle","ellipse","path","polygon","polyline","rect","svg","text","textpath","tref","tspan"]).has(e.toLowerCase()),v=e=>new Set(["iframe","video","embed","img"]).has(e.toLowerCase()),p=(e,t)=>new Set(["tr","td","thead","tbody"]).has(e.toLowerCase())&&t.startsWith("table");let m=0;const{documents:g,strings:f}=await this.#o.invoke_captureSnapshot({computedStyles:["background-color","color","fill","border-top-width","border-top-color","border-bottom-width","border-bottom-color","border-left-width","border-left-color","border-right-width","border-right-color","font-family","font-size","font-weight","line-height","position","top","right","bottom","left","display","width","height","vertical-align"],includeTextColorOpacities:!0,includeBlendedBackgroundColors:!0});for(const{nodes:b,layout:S}of g){m+=S.nodeIndex.length;for(let m=0;m<S.styles.length;m++){const g=S.styles[m],C=S.nodeIndex[m];if(!b.backendNodeId||!b.nodeName)continue;const y=b.backendNodeId[C],x=b.nodeName[C],[k,I,$,T,M,A,E,L,F,O,R,V,_,P,N,D,z,W,B,U,q,G,H,j]=g;h(k,y,t);const Q=h(I,y,i);if(u(f[x])&&h($,y,r),"0px"!==f[T]&&h(M,y,a),"0px"!==f[A]&&h(E,y,a),"0px"!==f[L]&&h(F,y,a),"0px"!==f[O]&&h(R,y,a),V&&-1!==V){const e=f[V],t=l.get(e)||new Map,i="font-size",o="font-weight",n="line-height",s=t.get(i)||new Map,r=t.get(o)||new Map,a=t.get(n)||new Map;if(-1!==_){const e=f[_],t=s.get(e)||[];t.push(y),s.set(e,t)}if(-1!==P){const e=f[P],t=r.get(e)||[];t.push(y),r.set(e,t)}if(-1!==N){const e=f[N],t=a.get(e)||[];t.push(y),a.set(e,t)}t.set(i,s),t.set(o,r),t.set(n,a),l.set(e,t)}const K=Q&&S.blendedBackgroundColors&&-1!==S.blendedBackgroundColors[m]?e.Color.parse(f[S.blendedBackgroundColors[m]]):null;if(Q&&K){const e=new n.ContrastInfo.ContrastInfo({backgroundColors:[K.asString("hexa")],computedFontSize:-1!==_?f[_]:"",computedFontWeight:-1!==P?f[P]:""}),t=Q.asLegacyColor().blendWithAlpha(S.textColorOpacities?S.textColorOpacities[m]:1);e.setColor(t);const i=`${c(t)}_${c(K.asLegacyColor())}`;if(o.Runtime.experiments.isEnabled("APCA")){const o=e.contrastRatioAPCA(),n=e.contrastRatioAPCAThreshold();if(!(!(!o||!n)&&Math.abs(o)>=n)&&o){const e={nodeId:y,contrastRatio:o,textColor:t,backgroundColor:K,thresholdsViolated:{aa:!1,aaa:!1,apca:!0}};s.has(i)?s.get(i).push(e):s.set(i,[e])}}else{const o=e.contrastRatioThreshold("aa")||0,n=e.contrastRatioThreshold("aaa")||0,r=e.contrastRatio()||0;if(o>r||n>r){const e={nodeId:y,contrastRatio:r,textColor:t,backgroundColor:K,thresholdsViolated:{aa:o>r,aaa:n>r,apca:!1}};s.has(i)?s.get(i).push(e):s.set(i,[e])}}}w.checkForUnusedPositionValues(d,y,f,D,z,U,W,B),u(f[x])||v(f[x])||w.checkForUnusedWidthAndHeightValues(d,y,f,q,G,H),-1===j||p(f[x],f[q])||w.checkForInvalidVerticalAlignment(d,y,f,q,j)}}return{backgroundColors:t,textColors:i,textColorContrastIssues:s,fillColors:r,borderColors:a,fontInfo:l,unusedDeclarations:d,elementCount:m}}getComputedStyleForNode(e){return this.#i.invoke_getComputedStyleForNode({nodeId:e})}async getMediaQueries(){const e=await this.#i.invoke_getMediaQueries(),t=new Map;if(!e)return t;for(const i of e.medias){if("linkedSheet"===i.source)continue;const e=t.get(i.text)||[];e.push(i),t.set(i.text,e)}return t}async getGlobalStylesheetStats(){const{result:e}=await this.#t.invoke_evaluate({expression:"(function() {\n      let styleRules = 0;\n      let inlineStyles = 0;\n      let externalSheets = 0;\n      const stats = {\n        // Simple.\n        type: new Set(),\n        class: new Set(),\n        id: new Set(),\n        universal: new Set(),\n        attribute: new Set(),\n\n        // Non-simple.\n        nonSimple: new Set()\n      };\n\n      for (const styleSheet of document.styleSheets) {\n        if (styleSheet.href) {\n          externalSheets++;\n        } else {\n          inlineStyles++;\n        }\n\n        // Attempting to grab rules can trigger a DOMException.\n        // Try it and if it fails skip to the next stylesheet.\n        let rules;\n        try {\n          rules = styleSheet.rules;\n        } catch (err) {\n          continue;\n        }\n\n        for (const rule of rules) {\n          if ('selectorText' in rule) {\n            styleRules++;\n\n            // Each group that was used.\n            for (const selectorGroup of rule.selectorText.split(',')) {\n              // Each selector in the group.\n              for (const selector of selectorGroup.split(/[\\t\\n\\f\\r ]+/g)) {\n                if (selector.startsWith('.')) {\n                  // Class.\n                  stats.class.add(selector);\n                } else if (selector.startsWith('#')) {\n                  // Id.\n                  stats.id.add(selector);\n                } else if (selector.startsWith('*')) {\n                  // Universal.\n                  stats.universal.add(selector);\n                } else if (selector.startsWith('[')) {\n                  // Attribute.\n                  stats.attribute.add(selector);\n                } else {\n                  // Type or non-simple selector.\n                  const specialChars = /[#.:\\[\\]|\\+>~]/;\n                  if (specialChars.test(selector)) {\n                    stats.nonSimple.add(selector);\n                  } else {\n                    stats.type.add(selector);\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n\n      return {\n        styleRules,\n        inlineStyles,\n        externalSheets,\n        stats: {\n          // Simple.\n          type: stats.type.size,\n          class: stats.class.size,\n          id: stats.id.size,\n          universal: stats.universal.size,\n          attribute: stats.attribute.size,\n\n          // Non-simple.\n          nonSimple: stats.nonSimple.size\n        }\n      }\n    })()",returnByValue:!0});if("object"===e.type)return e.value}}t.SDKModel.SDKModel.register(b,{capabilities:t.Target.Capability.DOM,autostart:!1});var S=Object.freeze({__proto__:null,CSSOverviewModel:b});const C=new CSSStyleSheet;C.replaceSync(".overview-processing-view{overflow:hidden;padding:16px;justify-content:center;align-items:center;height:100%}.overview-processing-view h1{font-size:16px;text-align:center;font-weight:normal;margin:0;padding:8px}.overview-processing-view h2{font-size:12px;text-align:center;font-weight:normal;margin:0;padding-top:32px}\n/*# sourceURL=cssOverviewProcessingView.css */\n");const y={cancel:"Cancel"},x=i.i18n.registerUIStrings("panels/css_overview/CSSOverviewProcessingView.ts",y),k=i.i18n.getLocalizedString.bind(void 0,x);class I extends s.Widget.Widget{#s;fragment;constructor(e){super(),this.#s=e,this.#r()}#r(){const e=s.UIUtils.createTextButton(k(y.cancel),(()=>this.#s.dispatchEventToListeners("RequestOverviewCancel")),"",!0);this.setDefaultFocusedElement(e),this.fragment=s.Fragment.Fragment.build`
      <div class="vbox overview-processing-view">
        <h1>Processing page</h1>
        <div>${e}</div>
      </div>
    `,this.contentElement.appendChild(this.fragment.element()),this.contentElement.style.overflow="auto"}wasShown(){super.wasShown(),this.registerCSSFiles([C])}}var $=Object.freeze({__proto__:null,CSSOverviewProcessingView:I});const T=new CSSStyleSheet;T.replaceSync('.overview-completed-view{overflow:auto;--overview-default-padding:28px;--overview-icon-padding:32px}.overview-completed-view .summary ul,\n.overview-completed-view .colors ul{display:flex;flex-wrap:wrap;list-style:none;margin:0;padding:0}.overview-completed-view .summary ul{display:grid;grid-template-columns:repeat(auto-fill,140px);grid-gap:16px}.overview-completed-view .colors ul li{display:inline-block;margin:0 0 16px;padding:0 8px 0 0}.overview-completed-view .summary ul li{display:flex;flex-direction:column;grid-column-start:auto}.overview-completed-view li .label{font-size:12px;padding-bottom:2px}.overview-completed-view li .value{font-size:17px}.overview-completed-view ul li span{font-weight:bold}.unused-rules-grid .header-container,\n.unused-rules-grid .data-container,\n.unused-rules-grid table.data{position:relative}.unused-rules-grid .data-container{top:0;max-height:350px}.unused-rules-grid{border-left:none;border-right:none}.unused-rules-grid .monospace{display:block;height:18px}.element-grid{flex:1;border-left:none;border-right:none;overflow:auto}.block{width:65px;height:25px;border-radius:3px;margin-right:16px}.block-title{padding-top:4px;font-size:12px;color:var(--color-text-primary);letter-spacing:0;text-transform:uppercase}.block-title.color-text{text-transform:none;max-width:65px;text-overflow:ellipsis;white-space:nowrap;cursor:text;user-select:text;overflow:hidden}.results-section{flex-shrink:0;border-bottom:1px solid var(--color-details-hairline);padding:var(--overview-default-padding) 0 var(--overview-default-padding) 0}.horizontally-padded{padding-left:var(--overview-default-padding);padding-right:var(--overview-default-padding)}.results-section h1{font-size:15px;font-weight:normal;padding:0;margin:0 0 20px;padding-left:calc(var(--overview-default-padding) + var(--overview-icon-padding));position:relative;height:26px;line-height:26px}.results-section h1::before{content:"";display:block;position:absolute;left:var(--overview-default-padding);top:0;width:26px;height:26px;background-image:var(--image-file-cssoverview_icons_2x);background-size:104px 26px}.results-section.horizontally-padded h1{padding-left:var(--overview-icon-padding)}.results-section.horizontally-padded h1::before{left:0}.results-section.summary h1{padding-left:0}.results-section.summary h1::before{display:none}.results-section.colors h1::before{background-position:0 0}.results-section.font-info h1::before{background-position:-26px 0}.results-section.unused-declarations h1::before{background-position:-52px 0}.results-section.media-queries h1::before{background-position:-78px 0}.results-section.colors h2{margin-top:20px;font-size:13px;font-weight:normal}.overview-completed-view .font-info ul,\n.overview-completed-view .media-queries ul,\n.overview-completed-view .unused-declarations ul{width:100%;list-style:none;margin:0;padding:0 var(--overview-default-padding)}.overview-completed-view .font-info ul li,\n.overview-completed-view .media-queries ul li,\n.overview-completed-view .unused-declarations ul li{display:grid;grid-template-columns:2fr 3fr;grid-gap:12px;margin-bottom:4px;align-items:center}.overview-completed-view .font-info button,\n.overview-completed-view .media-queries button,\n.overview-completed-view .unused-declarations button{border:none;padding:0;margin:0;display:flex;align-items:center;border-radius:2px;cursor:pointer;height:28px;background:none}.overview-completed-view .font-info button .details,\n.overview-completed-view .media-queries button .details,\n.overview-completed-view .unused-declarations button .details{min-width:100px;text-align:right;margin-right:8px;color:var(--color-primary);pointer-events:none}.overview-completed-view .font-info button .bar-container,\n.overview-completed-view .media-queries button .bar-container,\n.overview-completed-view .unused-declarations button .bar-container{flex:1;pointer-events:none}.overview-completed-view .font-info button .bar,\n.overview-completed-view .media-queries button .bar,\n.overview-completed-view .unused-declarations button .bar{height:8px;background:var(--color-primary);border-radius:2px;min-width:2px}.overview-completed-view .font-info button:hover .details,\n.overview-completed-view .font-info button:focus .details,\n.overview-completed-view .media-queries button:hover .details,\n.overview-completed-view .media-queries button:focus .details,\n.overview-completed-view .unused-declarations button:hover .details,\n.overview-completed-view .unused-declarations button:focus .details{color:var(--color-primary-variant)}.overview-completed-view .font-info button:hover .bar,\n.overview-completed-view .font-info button:focus .bar,\n.overview-completed-view .media-queries button:hover .bar,\n.overview-completed-view .media-queries button:focus .bar,\n.overview-completed-view .unused-declarations button:hover .bar,\n.overview-completed-view .unused-declarations button:focus .bar{background-color:var(--color-primary-variant);box-shadow:0 1px 2px var(--divider-line),0 0 0 2px var(--color-primary-variant);color:var(--color-background)}.overview-completed-view .font-info .font-metric{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));grid-gap:12px}.overview-completed-view .font-info ul{padding:0}.overview-completed-view .font-info ul li{grid-template-columns:1fr 4fr}.overview-completed-view .font-info h2{font-size:14px;font-weight:bold;margin:0 0 1em}.overview-completed-view .font-info h3{font-size:13px;font-weight:normal;font-style:italic;margin:0 0 0.5em}.overview-completed-view .font-info{padding-bottom:0}.overview-completed-view .font-family{padding:var(--overview-default-padding)}.overview-completed-view .font-family:nth-child(2n+1){background:var(--color-background)}.overview-completed-view .font-family:first-of-type{padding-top:0}.contrast-warning{display:flex;align-items:baseline}.contrast-warning .threshold-label{font-weight:normal;width:30px}.contrast-warning [is="ui-icon"]{margin-left:5px}.contrast-preview{padding:0 5px}.contrast-container-in-grid{display:flex;align-items:baseline}.contrast-container-in-grid > *{margin-right:5px;min-width:initial}[is="ui-icon"].smallicon-checkmark-square{background-color:var(--color-green)}[is="ui-icon"].smallicon-no{background-color:var(--color-red)}.data .nodeId-column{align-items:center;display:flex;height:20px}.nodeId-column .monospace{overflow:hidden}.show-element{margin:0 0 0 8px;padding:0;background:none;border:none;-webkit-mask-image:var(--image-file-ic_show_node_16x16);background-color:var(--color-text-secondary);width:16px;height:16px;display:none;cursor:pointer;flex:none}.show-element:focus,\n.show-element:hover{background-color:var(--color-primary)}.nodeId-column:focus-within .show-element,\n.nodeId-column:hover .show-element{display:inline-block}\n/*# sourceURL=cssOverviewCompletedView.css */\n');const M=new CSSStyleSheet;M.replaceSync(".overview-sidebar-panel{overflow:auto;display:flex;background:var(--color-background-elevation-1)}.overview-sidebar-panel-item{height:30px;padding-left:30px;display:flex;align-items:center;color:var(--color-text-primary);white-space:nowrap}.overview-sidebar-panel-container{min-width:fit-content}.overview-sidebar-panel-item:hover,\n.overview-sidebar-panel-item:focus{background:var(--color-background-highlight)}.overview-sidebar-panel-item.selected{background:var(--color-primary);color:var(--color-background)}.overview-toolbar{border-bottom:1px solid var(--color-details-hairline);flex:0 0 auto}\n/*# sourceURL=cssOverviewSidebarPanel.css */\n");const A={clearOverview:"Clear overview"},E=i.i18n.registerUIStrings("panels/css_overview/CSSOverviewSidebarPanel.ts",A),L=i.i18n.getLocalizedString.bind(void 0,E);class F extends(e.ObjectWrapper.eventMixin(s.Widget.VBox)){containerElement;static get ITEM_CLASS_NAME(){return"overview-sidebar-panel-item"}static get SELECTED(){return"selected"}constructor(){super(!0),this.contentElement.classList.add("overview-sidebar-panel"),this.contentElement.addEventListener("click",this.#a.bind(this)),this.containerElement=this.contentElement.createChild("div","overview-sidebar-panel-container");const e=new s.Toolbar.ToolbarButton(L(A.clearOverview),"largeicon-clear");e.addEventListener(s.Toolbar.ToolbarButton.Events.Click,this.#l,this);const t=this.containerElement.createChild("div","overview-toolbar");new s.Toolbar.Toolbar("",t).appendToolbarItem(e)}addItem(e,t){const i=this.containerElement.createChild("div",F.ITEM_CLASS_NAME);i.textContent=e,i.dataset.id=t}#l(){this.dispatchEventToListeners("Reset")}#d(){this.containerElement.querySelectorAll(`.${F.ITEM_CLASS_NAME}`).forEach((e=>{e.classList.remove(F.SELECTED)}))}#a(e){const t=e.composedPath()[0];if(!t.classList.contains(F.ITEM_CLASS_NAME))return;const{id:i}=t.dataset;i&&(this.select(i),this.dispatchEventToListeners("ItemSelected",i))}select(e){const t=this.containerElement.querySelector(`[data-id=${CSS.escape(e)}]`);t&&(t.classList.contains(F.SELECTED)||(this.#d(),t.classList.add(F.SELECTED)))}wasShown(){super.wasShown(),this.registerCSSFiles([M])}}var O=Object.freeze({__proto__:null,CSSOverviewSidebarPanel:F});const R={overviewSummary:"Overview summary",colors:"Colors",fontInfo:"Font info",unusedDeclarations:"Unused declarations",mediaQueries:"Media queries",elements:"Elements",externalStylesheets:"External stylesheets",inlineStyleElements:"Inline style elements",styleRules:"Style rules",typeSelectors:"Type selectors",idSelectors:"ID selectors",classSelectors:"Class selectors",universalSelectors:"Universal selectors",attributeSelectors:"Attribute selectors",nonsimpleSelectors:"Non-simple selectors",backgroundColorsS:"Background colors: {PH1}",textColorsS:"Text colors: {PH1}",fillColorsS:"Fill colors: {PH1}",borderColorsS:"Border colors: {PH1}",thereAreNoFonts:"There are no fonts.",thereAreNoUnusedDeclarations:"There are no unused declarations.",thereAreNoMediaQueries:"There are no media queries.",contrastIssues:"Contrast issues",nOccurrences:"{n, plural, =1 {# occurrence} other {# occurrences}}",contrastIssuesS:"Contrast issues: {PH1}",textColorSOverSBackgroundResults:"Text color {PH1} over {PH2} background results in low contrast for {PH3} elements",aa:"AA",aaa:"AAA",apca:"APCA",element:"Element",declaration:"Declaration",source:"Source",contrastRatio:"Contrast ratio",cssOverviewElements:"CSS Overview Elements",showElement:"Show element"},V=i.i18n.registerUIStrings("panels/css_overview/CSSOverviewCompletedView.ts",R),_=i.i18n.getLocalizedString.bind(void 0,V);function P(e){let{h:t,s:i,l:o}=e.as("hsl");return t=Math.round(360*t),i=Math.round(100*i),o=Math.round(100*o),o=Math.max(0,o-15),`1px solid hsl(${t}deg ${i}% ${o}%)`}class N extends s.Panel.PanelWithSidebar{#s;#c;#h;#u;#v;#p;#m;#g;#w;#f;#b;#S;constructor(e){super("css_overview_completed_view"),this.#s=e,this.#c=new Intl.NumberFormat("en-US"),this.#h=new s.SplitWidget.SplitWidget(!0,!0),this.#u=new s.Widget.VBox,this.#v=new D,this.#v.addEventListener("TabClosed",(e=>{0===e.data&&this.#h.setSidebarMinimized(!0)})),this.#h.setMainWidget(this.#u),this.#h.setSidebarWidget(this.#v),this.#h.setVertical(!1),this.#h.setSecondIsSidebar(!0),this.#h.setSidebarMinimized(!0),this.#p=new F,this.#p.setMinimumSize(100,25),this.splitWidget().setSidebarWidget(this.#p),this.splitWidget().setMainWidget(this.#h),this.#w=new d.Linkifier.Linkifier(20,!0),this.#f=new Map,this.#p.addItem(_(R.overviewSummary),"summary"),this.#p.addItem(_(R.colors),"colors"),this.#p.addItem(_(R.fontInfo),"font-info"),this.#p.addItem(_(R.unusedDeclarations),"unused-declarations"),this.#p.addItem(_(R.mediaQueries),"media-queries"),this.#p.select("summary"),this.#p.addEventListener("ItemSelected",this.#C,this),this.#p.addEventListener("Reset",this.#y,this),this.#s.addEventListener("Reset",this.#l,this),this.#s.addEventListener("PopulateNodes",this.#x,this),this.#u.element.addEventListener("click",this.#k.bind(this)),this.#b=null}wasShown(){super.wasShown(),this.#h.registerCSSFiles([T]),this.registerCSSFiles([T])}initializeModels(e){const i=e.model(t.CSSModel.CSSModel),o=e.model(t.DOMModel.DOMModel);if(!i||!o)throw new Error("Target must provide CSS and DOM models");this.#m=i,this.#g=o}#C(e){const{data:t}=e,i=this.#S.$(t);i&&i.scrollIntoView()}#y(){this.#s.dispatchEventToListeners("Reset")}#l(){this.#u.element.removeChildren(),this.#h.setSidebarMinimized(!0),this.#v.closeTabs(),this.#f=new Map,N.pushedNodes.clear(),this.#p.select("summary")}#k(e){if(!e.target)return;const t=e.target.dataset,i=t.type;if(!i||!this.#b)return;let o;switch(i){case"contrast":{const e=t.section,n=t.key;if(!n)return;o={type:i,key:n,nodes:this.#b.textColorContrastIssues.get(n)||[],section:e};break}case"color":{const e=t.color,n=t.section;if(!e)return;let s;switch(n){case"text":s=this.#b.textColors.get(e);break;case"background":s=this.#b.backgroundColors.get(e);break;case"fill":s=this.#b.fillColors.get(e);break;case"border":s=this.#b.borderColors.get(e)}if(!s)return;s=Array.from(s).map((e=>({nodeId:e}))),o={type:i,color:e,nodes:s,section:n};break}case"unused-declarations":{const e=t.declaration;if(!e)return;const n=this.#b.unusedDeclarations.get(e);if(!n)return;o={type:i,declaration:e,nodes:n};break}case"media-queries":{const e=t.text;if(!e)return;const n=this.#b.mediaQueries.get(e);if(!n)return;o={type:i,text:e,nodes:n};break}case"font-info":{const e=t.value;if(!t.path)return;const[n,s]=t.path.split("/");if(!e)return;const r=this.#b.fontInfo.get(n);if(!r)return;const a=r.get(s);if(!a)return;const l=a.get(e);if(!l)return;o={type:i,name:`${e} (${n}, ${s})`,nodes:l.map((e=>({nodeId:e})))};break}default:return}e.consume(),this.#s.dispatchEventToListeners("PopulateNodes",{payload:o}),this.#h.setSidebarMinimized(!1)}async#r(e){if(!e||!("backgroundColors"in e)||!("textColors"in e))return;this.#b=e;const{elementCount:t,backgroundColors:i,textColors:o,textColorContrastIssues:n,fillColors:r,borderColors:a,globalStyleStats:l,mediaQueries:d,unusedDeclarations:c,fontInfo:h}=this.#b,u=this.#I(i),v=this.#I(o),p=this.#I(r),m=this.#I(a);this.#S=s.Fragment.Fragment.build`
    <div class="vbox overview-completed-view">
      <div $="summary" class="results-section horizontally-padded summary">
        <h1>${_(R.overviewSummary)}</h1>

        <ul>
          <li>
            <div class="label">${_(R.elements)}</div>
            <div class="value">${this.#c.format(t)}</div>
          </li>
          <li>
            <div class="label">${_(R.externalStylesheets)}</div>
            <div class="value">${this.#c.format(l.externalSheets)}</div>
          </li>
          <li>
            <div class="label">${_(R.inlineStyleElements)}</div>
            <div class="value">${this.#c.format(l.inlineStyles)}</div>
          </li>
          <li>
            <div class="label">${_(R.styleRules)}</div>
            <div class="value">${this.#c.format(l.styleRules)}</div>
          </li>
          <li>
            <div class="label">${_(R.mediaQueries)}</div>
            <div class="value">${this.#c.format(d.size)}</div>
          </li>
          <li>
            <div class="label">${_(R.typeSelectors)}</div>
            <div class="value">${this.#c.format(l.stats.type)}</div>
          </li>
          <li>
            <div class="label">${_(R.idSelectors)}</div>
            <div class="value">${this.#c.format(l.stats.id)}</div>
          </li>
          <li>
            <div class="label">${_(R.classSelectors)}</div>
            <div class="value">${this.#c.format(l.stats.class)}</div>
          </li>
          <li>
            <div class="label">${_(R.universalSelectors)}</div>
            <div class="value">${this.#c.format(l.stats.universal)}</div>
          </li>
          <li>
            <div class="label">${_(R.attributeSelectors)}</div>
            <div class="value">${this.#c.format(l.stats.attribute)}</div>
          </li>
          <li>
            <div class="label">${_(R.nonsimpleSelectors)}</div>
            <div class="value">${this.#c.format(l.stats.nonSimple)}</div>
          </li>
        </ul>
      </div>

      <div $="colors" class="results-section horizontally-padded colors">
        <h1>${_(R.colors)}</h1>
        <h2>${_(R.backgroundColorsS,{PH1:u.length})}</h2>
        <ul>
          ${u.map(this.#$.bind(this,"background"))}
        </ul>

        <h2>${_(R.textColorsS,{PH1:v.length})}</h2>
        <ul>
          ${v.map(this.#$.bind(this,"text"))}
        </ul>

        ${n.size>0?this.#T(n):""}

        <h2>${_(R.fillColorsS,{PH1:p.length})}</h2>
        <ul>
          ${p.map(this.#$.bind(this,"fill"))}
        </ul>

        <h2>${_(R.borderColorsS,{PH1:m.length})}</h2>
        <ul>
          ${m.map(this.#$.bind(this,"border"))}
        </ul>
      </div>

      <div $="font-info" class="results-section font-info">
        <h1>${_(R.fontInfo)}</h1>
        ${h.size>0?this.#M(h):s.Fragment.Fragment.build`<div>${_(R.thereAreNoFonts)}</div>`}
      </div>

      <div $="unused-declarations" class="results-section unused-declarations">
        <h1>${_(R.unusedDeclarations)}</h1>
        ${c.size>0?this.#A(c,"unused-declarations","declaration"):s.Fragment.Fragment.build`<div class="horizontally-padded">${_(R.thereAreNoUnusedDeclarations)}</div>`}
      </div>

      <div $="media-queries" class="results-section media-queries">
        <h1>${_(R.mediaQueries)}</h1>
        ${d.size>0?this.#A(d,"media-queries","text"):s.Fragment.Fragment.build`<div class="horizontally-padded">${_(R.thereAreNoMediaQueries)}</div>`}
      </div>
    </div>`,this.#u.element.appendChild(this.#S.element())}#x(e){const{payload:t}=e.data;let i="",o="";switch(t.type){case"contrast":{const{section:e,key:n}=t;i=`${e}-${n}`,o=_(R.contrastIssues);break}case"color":{const{section:e,color:n}=t;i=`${e}-${n}`,o=`${n.toUpperCase()} (${e})`;break}case"unused-declarations":{const{declaration:e}=t;i=`${e}`,o=`${e}`;break}case"media-queries":{const{text:e}=t;i=`${e}`,o=`${e}`;break}case"font-info":{const{name:e}=t;i=`${e}`,o=`${e}`;break}}let n=this.#f.get(i);if(!n){if(!this.#g||!this.#m)throw new Error("Unable to initialize CSS Overview, missing models");n=new z(this.#s,this.#g,this.#m,this.#w),n.populateNodes(t.nodes),this.#f.set(i,n)}this.#v.appendTab(i,o,n,!0)}#M(e){const t=Array.from(e.entries());return s.Fragment.Fragment.build`
  ${t.map((([e,t])=>s.Fragment.Fragment.build`<section class="font-family"><h2>${e}</h2> ${this.#E(e,t)}</section>`))}
  `}#E(e,t){const i=Array.from(t.entries());return s.Fragment.Fragment.build`
  <div class="font-metric">
  ${i.map((([t,i])=>{const o=`${e}/${t}`;return s.Fragment.Fragment.build`
  <div>
  <h3>${t}</h3>
  ${this.#A(i,"font-info","value",o)}
  </div>`}))}
  </div>`}#A(e,t,i,o=""){const n=Array.from(e.entries()).sort(((e,t)=>{const i=e[1];return t[1].length-i.length})),r=n.reduce(((e,t)=>e+t[1].length),0);return s.Fragment.Fragment.build`<ul>
    ${n.map((([e,n])=>{const a=100*n.length/r,l=_(R.nOccurrences,{n:n.length});return s.Fragment.Fragment.build`<li>
        <div class="title">${e}</div>
        <button data-type="${t}" data-path="${o}" data-${i}="${e}">
          <div class="details">${l}</div>
          <div class="bar-container">
            <div class="bar" style="width: ${a}%;"></div>
          </div>
        </button>
      </li>`}))}
    </ul>`}#T(e){return s.Fragment.Fragment.build`
  <h2>${_(R.contrastIssuesS,{PH1:e.size})}</h2>
  <ul>
  ${[...e.entries()].map((([e,t])=>this.#L(e,t)))}
  </ul>
  `}#L(e,t){console.assert(t.length>0);let i=t[0];for(const e of t)Math.abs(e.contrastRatio)<Math.abs(i.contrastRatio)&&(i=e);const n=i.textColor.asString("hexa"),r=i.backgroundColor.asString("hexa"),a=o.Runtime.experiments.isEnabled("APCA"),l=s.Fragment.Fragment.build`<li>
      <button
        title="${_(R.textColorSOverSBackgroundResults,{PH1:n,PH2:r,PH3:t.length})}"
        data-type="contrast" data-key="${e}" data-section="contrast" class="block" $="color">
        Text
      </button>
      <div class="block-title">
        <div class="contrast-warning hidden" $="aa"><span class="threshold-label">${_(R.aa)}</span></div>
        <div class="contrast-warning hidden" $="aaa"><span class="threshold-label">${_(R.aaa)}</span></div>
        <div class="contrast-warning hidden" $="apca"><span class="threshold-label">${_(R.apca)}</span></div>
      </div>
    </li>`;if(a){const e=l.$("apca");i.thresholdsViolated.apca?e.appendChild(s.Icon.Icon.create("smallicon-no")):e.appendChild(s.Icon.Icon.create("smallicon-checkmark-square")),e.classList.remove("hidden")}else{const e=l.$("aa");i.thresholdsViolated.aa?e.appendChild(s.Icon.Icon.create("smallicon-no")):e.appendChild(s.Icon.Icon.create("smallicon-checkmark-square"));const t=l.$("aaa");i.thresholdsViolated.aaa?t.appendChild(s.Icon.Icon.create("smallicon-no")):t.appendChild(s.Icon.Icon.create("smallicon-checkmark-square")),e.classList.remove("hidden"),t.classList.remove("hidden")}const d=l.$("color");return d.style.backgroundColor=r,d.style.color=n,d.style.border=P(i.backgroundColor.asLegacyColor()),l}#$(t,i){const o=s.Fragment.Fragment.build`<li>
      <button data-type="color" data-color="${i}" data-section="${t}" class="block" $="color"></button>
      <div class="block-title color-text" title=${i}>${i}</div>
    </li>`,n=o.$("color");n.style.backgroundColor=i;const r=e.Color.parse(i)?.asLegacyColor();if(r)return n.style.border=P(r),o}#I(t){return Array.from(t.keys()).sort(((t,i)=>{const o=e.Color.parse(t)?.asLegacyColor(),n=e.Color.parse(i)?.asLegacyColor();return o&&n?e.ColorUtils.luminance(n.rgba())-e.ColorUtils.luminance(o.rgba()):0}))}setOverviewData(e){this.#r(e)}static pushedNodes=new Set}class D extends(e.ObjectWrapper.eventMixin(s.Widget.VBox)){#F;constructor(){super(),this.#F=new s.TabbedPane.TabbedPane,this.#F.show(this.element),this.#F.addEventListener(s.TabbedPane.Events.TabClosed,(()=>{this.dispatchEventToListeners("TabClosed",this.#F.tabIds().length)}))}appendTab(e,t,i,o){this.#F.hasTab(e)||this.#F.appendTab(e,t,i,void 0,void 0,o),this.#F.selectTab(e)}closeTabs(){this.#F.closeTabs(this.#F.tabIds())}}class z extends s.Widget.Widget{#s;#g;#m;#w;#O;#R;constructor(e,t,i,o){super(),this.#s=e,this.#g=t,this.#m=i,this.#w=o,this.#O=[{id:"nodeId",title:_(R.element),sortable:!0,weight:50,titleDOMFragment:void 0,sort:void 0,align:void 0,width:void 0,fixedWidth:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0},{id:"declaration",title:_(R.declaration),sortable:!0,weight:50,titleDOMFragment:void 0,sort:void 0,align:void 0,width:void 0,fixedWidth:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0},{id:"sourceURL",title:_(R.source),sortable:!1,weight:100,titleDOMFragment:void 0,sort:void 0,align:void 0,width:void 0,fixedWidth:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0},{id:"contrastRatio",title:_(R.contrastRatio),sortable:!0,weight:25,titleDOMFragment:void 0,sort:void 0,align:void 0,width:"150px",fixedWidth:!0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0}],this.#R=new l.SortableDataGrid.SortableDataGrid({displayName:_(R.cssOverviewElements),columns:this.#O,editCallback:void 0,deleteCallback:void 0,refreshCallback:void 0}),this.#R.element.classList.add("element-grid"),this.#R.element.addEventListener("mouseover",this.#V.bind(this)),this.#R.setStriped(!0),this.#R.addEventListener(l.DataGrid.Events.SortingChanged,this.#_.bind(this)),this.#R.asWidget().show(this.element)}#_(){const e=this.#R.sortColumnId();if(!e)return;const t=l.SortableDataGrid.SortableDataGrid.StringComparator.bind(null,e);this.#R.sortNodes(t,!this.#R.isSortOrderAscending())}#V(e){const t=e.composedPath().find((e=>e.dataset&&e.dataset.backendNodeId));if(!t)return;const i=Number(t.dataset.backendNodeId);this.#s.dispatchEventToListeners("RequestNodeHighlight",i)}async populateNodes(e){if(this.#R.rootNode().removeChildren(),!e.length)return;const[t]=e,i=new Set;let o;if("nodeId"in t&&t.nodeId&&i.add("nodeId"),"declaration"in t&&t.declaration&&i.add("declaration"),"sourceURL"in t&&t.sourceURL&&i.add("sourceURL"),"contrastRatio"in t&&t.contrastRatio&&i.add("contrastRatio"),"nodeId"in t&&i.has("nodeId")){const t=e.reduce(((e,t)=>{const i=t.nodeId;return N.pushedNodes.has(i)?e:(N.pushedNodes.add(i),e.add(i))}),new Set);o=await this.#g.pushNodesByBackendIdsToFrontend(t)}for(const t of e){let e;if("nodeId"in t&&i.has("nodeId")){if(!o)continue;if(e=o.get(t.nodeId),!e)continue}const n=new W(t,e,this.#w,this.#m);n.selectable=!1,this.#R.insertChild(n)}this.#R.setColumnsVisiblity(i),this.#R.renderInline(),this.#R.wasShown()}}class W extends l.SortableDataGrid.SortableDataGridNode{#w;#m;#P;constructor(e,t,i,o){super(e),this.#P=t,this.#w=i,this.#m=o}createCell(t){const i=this.#P;if("nodeId"===t){const o=this.createTD(t);if(o.textContent="...",!i)throw new Error("Node entry is missing a related frontend node.");return e.Linkifier.Linkifier.linkify(i).then((e=>{o.textContent="",e.dataset.backendNodeId=i.backendNodeId().toString(),o.appendChild(e);const t=document.createElement("button");t.classList.add("show-element"),s.Tooltip.Tooltip.install(t,_(R.showElement)),t.tabIndex=0,t.onclick=()=>i.scrollIntoView(),o.appendChild(t)})),o}if("sourceURL"===t){const e=this.createTD(t);if(this.data.range){const t=this.#N(this.#m,this.#w,this.data.styleSheetId,a.TextRange.TextRange.fromObject(this.data.range));t&&""!==t.textContent?e.appendChild(t):e.textContent="(unable to link)"}else e.textContent="(unable to link to inlined styles)";return e}if("contrastRatio"===t){const e=this.createTD(t),i=o.Runtime.experiments.isEnabled("APCA"),n=r.NumberUtilities.floor(this.data.contrastRatio,2),a=i?n+"%":n,l=P(this.data.backgroundColor),d=this.data.textColor.asString(),c=this.data.backgroundColor.asString(),h=s.Fragment.Fragment.build`
        <div class="contrast-container-in-grid" $="container">
          <span class="contrast-preview" style="border: ${l};
          color: ${d};
          background-color: ${c};">Aa</span>
          <span>${a}</span>
        </div>
      `,u=h.$("container");return i?(u.append(s.Fragment.Fragment.build`<span>${_(R.apca)}</span>`.element()),this.data.thresholdsViolated.apca?u.appendChild(s.Icon.Icon.create("smallicon-no")):u.appendChild(s.Icon.Icon.create("smallicon-checkmark-square"))):(u.append(s.Fragment.Fragment.build`<span>${_(R.aa)}</span>`.element()),this.data.thresholdsViolated.aa?u.appendChild(s.Icon.Icon.create("smallicon-no")):u.appendChild(s.Icon.Icon.create("smallicon-checkmark-square")),u.append(s.Fragment.Fragment.build`<span>${_(R.aaa)}</span>`.element()),this.data.thresholdsViolated.aaa?u.appendChild(s.Icon.Icon.create("smallicon-no")):u.appendChild(s.Icon.Icon.create("smallicon-checkmark-square"))),e.appendChild(h.element()),e}return super.createCell(t)}#N(e,i,o,n){const s=e.styleSheetHeaderForId(o);if(!s)return;const r=s.lineNumberInSource(n.startLine),a=s.columnNumberInSource(n.startLine,n.startColumn),l=new t.CSSModel.CSSLocation(s,r,a);return i.linkifyCSSLocation(l)}}var B=Object.freeze({__proto__:null,CSSOverviewCompletedView:N,DetailsView:D,ElementDetailsView:z,ElementNode:W});const U=new CSSStyleSheet;U.replaceSync(".css-overview-panel{overflow:hidden}devtools-css-overview-start-view{overflow:auto}\n/*# sourceURL=cssOverview.css */\n");class q extends s.Panel.Panel{#s;#D;#z;#W;#B;#U;#q;#G;#H;#j;#Q;#K;#J;#X;#Y;constructor(e){super("css_overview"),this.element.classList.add("css-overview-panel"),this.#s=e,this.#D=new c.CSSOverviewStartView.CSSOverviewStartView,this.#D.addEventListener("overviewstartrequested",(()=>this.#s.dispatchEventToListeners("RequestOverviewStart"))),this.#z=new I(this.#s),this.#W=new N(this.#s),t.TargetManager.TargetManager.instance().observeTargets(this),this.#s.addEventListener("RequestOverviewStart",(e=>{h.userMetrics.actionTaken(h.UserMetrics.Action.CaptureCssOverviewClicked),this.#Z()}),this),this.#s.addEventListener("OverviewCompleted",this.#ee,this),this.#s.addEventListener("Reset",this.#l,this),this.#s.addEventListener("RequestNodeHighlight",this.#te,this),this.#l()}targetAdded(e){if(e!==t.TargetManager.TargetManager.instance().mainFrameTarget())return;this.#W.initializeModels(e);const i=e.model(b);this.#B=i}targetRemoved(){}#ie(){if(!this.#B)throw new Error("Did not retrieve model information yet.");return this.#B}#l(){this.#U=new Map,this.#q=new Map,this.#G=new Map,this.#H=new Map,this.#j=new Map,this.#Q=new Map,this.#K=new Map,this.#J=0,this.#X={styleRules:0,inlineStyles:0,externalSheets:0,stats:{type:0,class:0,id:0,universal:0,attribute:0,nonSimple:0}},this.#Y=new Map,this.#oe()}#te(e){this.#ie().highlightNode(e.data)}#oe(){this.#z.hideWidget(),this.#W.hideWidget(),this.contentElement.append(this.#D),this.#D.show()}#ne(){this.#D.hide(),this.#W.hideWidget(),this.#z.show(this.contentElement)}#se(){this.#D.hide(),this.#z.hideWidget(),this.#W.show(this.contentElement),this.#W.setOverviewData({backgroundColors:this.#U,textColors:this.#q,textColorContrastIssues:this.#Y,fillColors:this.#G,borderColors:this.#H,globalStyleStats:this.#X,fontInfo:this.#j,elementCount:this.#J,mediaQueries:this.#Q,unusedDeclarations:this.#K})}async#Z(){this.#ne();const e=this.#ie(),[t,{elementCount:i,backgroundColors:o,textColors:n,textColorContrastIssues:s,fillColors:r,borderColors:a,fontInfo:l,unusedDeclarations:d},c]=await Promise.all([e.getGlobalStylesheetStats(),e.getNodeStyleStats(),e.getMediaQueries()]);i&&(this.#J=i),t&&(this.#X=t),c&&(this.#Q=c),o&&(this.#U=o),n&&(this.#q=n),s&&(this.#Y=s),r&&(this.#G=r),a&&(this.#H=a),l&&(this.#j=l),d&&(this.#K=d),this.#s.dispatchEventToListeners("OverviewCompleted")}#ee(){this.#se()}wasShown(){super.wasShown(),this.registerCSSFiles([U])}}var G=Object.freeze({__proto__:null,CSSOverviewPanel:q});export{B as CSSOverviewCompletedView,v as CSSOverviewController,S as CSSOverviewModel,G as CSSOverviewPanel,$ as CSSOverviewProcessingView,O as CSSOverviewSidebarPanel,f as CSSOverviewUnusedDeclarations};
