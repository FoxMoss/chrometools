import*as e from"../types/types.js";import*as n from"../../../core/platform/platform.js";import*as t from"../helpers/helpers.js";const r=[];var i=Object.freeze({__proto__:null,reset:function(){r.length=0},handleEvent:function(n){e.TraceEvents.isTraceEventAnimation(n)&&r.push(n)},data:function(){return{animations:r}}});const a=new Map;let s="",o="",c=e.TraceEvents.ProcessID(-1),l=e.TraceEvents.ThreadID(-1),d=e.TraceEvents.ProcessID(-1),u=e.TraceEvents.ThreadID(-1),m=null;const g=new Set,f={min:e.Timing.MicroSeconds(Number.POSITIVE_INFINITY),max:e.Timing.MicroSeconds(Number.NEGATIVE_INFINITY),range:e.Timing.MicroSeconds(Number.POSITIVE_INFINITY)},T=new Map,p=new Map,h=new Map;let v=e.Timing.MicroSeconds(-1);const w=new Set(["B","E","X","I"]);let M=1;function E(t,r){const i=n.MapUtilities.getWithDefault(a,r.frame,(()=>new Map)),s=n.MapUtilities.getWithDefault(i,r.processId,(()=>({frame:r,window:{min:e.Timing.MicroSeconds(0),max:e.Timing.MicroSeconds(0),range:e.Timing.MicroSeconds(0)}})));s.window.min===e.Timing.MicroSeconds(0)&&(s.window.min=t.ts)}function S(){if(3!==M)throw new Error("Meta Handler is not finalized");return{traceBounds:{...f},browserProcessId:c,browserThreadId:l,gpuProcessId:d,gpuThreadId:u===e.TraceEvents.ThreadID(-1)?void 0:u,viewportRect:m||void 0,mainFrameId:s,mainFrameURL:o,navigationsByFrameId:new Map(T),navigationsByNavigationId:new Map(p),threadsInProcess:new Map(h),rendererProcessesByFrame:new Map(a),topLevelRendererIds:new Set(g)}}var y=Object.freeze({__proto__:null,reset:function(){T.clear(),p.clear(),c=e.TraceEvents.ProcessID(-1),l=e.TraceEvents.ThreadID(-1),d=e.TraceEvents.ProcessID(-1),u=e.TraceEvents.ThreadID(-1),m=null,g.clear(),h.clear(),a.clear(),f.min=e.Timing.MicroSeconds(Number.POSITIVE_INFINITY),f.max=e.Timing.MicroSeconds(Number.NEGATIVE_INFINITY),f.range=e.Timing.MicroSeconds(Number.POSITIVE_INFINITY),v=e.Timing.MicroSeconds(-1),M=1},initialize:function(){if(1!==M)throw new Error("Meta Handler was not reset");M=2},handleEvent:function(t){if(2!==M)throw new Error("Meta Handler is not initialized");if(0!==t.ts&&!t.name.endsWith("::UMA")&&w.has(t.ph)){f.min=e.Timing.MicroSeconds(Math.min(t.ts,f.min));const n=t.dur||e.Timing.MicroSeconds(0);f.max=e.Timing.MicroSeconds(Math.max(t.ts+n,f.max))}if(!e.TraceEvents.isProcessName(t)||"Browser"!==t.args.name&&"HeadlessBrowser"!==t.args.name)if(!e.TraceEvents.isProcessName(t)||"Gpu"!==t.args.name&&"GPU Process"!==t.args.name)if(e.TraceEvents.isThreadName(t)&&"CrGpuMain"===t.args.name)u=t.tid;else{if(e.TraceEvents.isThreadName(t)&&"CrBrowserMain"===t.args.name&&(l=t.tid),e.TraceEvents.isTraceEventMainFrameViewport(t)&&null===m){const e=t.args.data.viewport_rect,n=e[0],r=e[1],i=e[2],a=e[5];m=new DOMRect(n,r,i,a)}if(e.TraceEvents.isTraceEventTracingStartedInBrowser(t)){if(v=t.ts,!t.args.data)throw new Error("No frames found in trace data");for(const e of t.args.data.frames)E(t,e),e.parent||(s=e.frame,o=e.url,g.add(e.processId))}else if(e.TraceEvents.isTraceEventFrameCommittedInBrowser(t)){const e=t.args.data;if(!e)return;if(E(t,e),e.parent)return;g.add(e.processId)}else if(e.TraceEvents.isTraceEventCommitLoad(t)){const e=t.args.data;if(!e)return;const{frame:n,name:r,url:i}=e;E(t,{processId:t.pid,frame:n,name:r,url:i})}else if(e.TraceEvents.isThreadName(t)){n.MapUtilities.getWithDefault(h,t.pid,(()=>new Map)).set(t.tid,t)}else if(e.TraceEvents.isTraceEventNavigationStartWithURL(t)&&t.args.data){const e=t.args.data.navigationId;if(p.has(e))throw new Error("Found multiple navigation start events with the same navigation ID.");p.set(e,t);const n=t.args.frame,r=T.get(n)||[];return r.push(t),void T.set(n,r)}}else d=t.pid;else c=t.pid},finalize:async function(){if(2!==M)throw new Error("Handler is not initialized");if(-1===v)throw new Error("Error parsing trace data: no TracingStartedInBrowser event found.");if(f.min=v,f.range=e.Timing.MicroSeconds(f.max-f.min),0===g.size)throw new Error("Unable to find renderer processes");if(c===e.TraceEvents.ProcessID(-1))throw new Error("Unable to find browser process");if(l===e.TraceEvents.ThreadID(-1))throw new Error("Unable to find browser thread");if(d===e.TraceEvents.ProcessID(-1))throw new Error("Unable to find GPU process");if(!s)throw new Error("Unable to find main frame ID");for(const[,n]of a){const t=[...n.values()];for(let n=0;n<t.length;n++){const r=t[n],i=t[n+1];i?(r.window.max=e.Timing.MicroSeconds(i.window.min-1),r.window.range=e.Timing.MicroSeconds(r.window.max-r.window.min)):(r.window.max=e.Timing.MicroSeconds(f.max),r.window.range=e.Timing.MicroSeconds(f.max-r.window.min))}}for(const[e,n]of T)if(!a.has(e)){T.delete(e);for(const e of n)e.args.data&&p.delete(e.args.data.navigationId)}M=3},data:S});let I=1;const b=new Map;let C=[];var R=Object.freeze({__proto__:null,reset:function(){b.clear(),C=[],I=1},initialize:function(){if(1!==I)throw new Error("GPU Handler was not reset before being initialized");I=2},handleEvent:function(n){if(2!==I)throw new Error("GPU Handler is not initialized");e.TraceEvents.isTraceEventGPUTask(n)&&t.Trace.addEventToProcessThread(n,b)},finalize:async function(){if(2!==I)throw new Error("GPU Handler is not initialized");const{gpuProcessId:e,gpuThreadId:n}=S(),t=b.get(e);t&&n&&(C=t.get(n)||[]),I=3},data:function(){if(3!==I)throw new Error("GPU Handler is not finalized");return{mainGPUThreadTasks:[...C]}},deps:function(){return["Meta"]}});const P=new Map;var D=Object.freeze({__proto__:null,reset:function(){P.clear()},handleEvent:function(n){e.TraceEvents.isTraceEventLargestImagePaintCandidate(n)&&n.args.data&&P.set(n.args.data.DOMNodeId,n)},data:function(){return new Map(P)}});const F=new Map;var k=Object.freeze({__proto__:null,reset:function(){F.clear()},handleEvent:function(n){e.TraceEvents.isTraceEventLargestTextPaintCandidate(n)&&n.args.data&&F.set(n.args.data.DOMNodeId,n)},data:function(){return new Map(F)}});const _=new Map;let L=[];function W(){return[...L]}var x=Object.freeze({__proto__:null,reset:function(){_.clear(),L.length=0},handleEvent:function(e){"O"===e.ph&&"Screenshot"===e.name&&t.Trace.addEventToProcessThread(e,_)},finalize:async function(){const{browserProcessId:e,browserThreadId:n}=S(),t=_.get(e);t&&(L=t.get(n)||[])},data:W,deps:function(){return["Meta"]}});const U=t.Timing.millisecondsToMicroseconds(e.Timing.MilliSeconds(5e3)),N=t.Timing.millisecondsToMicroseconds(e.Timing.MilliSeconds(1e3)),z=[],q=[],O=[],B=[];let H=0,A=-1;const J=[],G=[];let V=1;function j(n){return{min:n,max:n,range:e.Timing.MicroSeconds(0)}}function Y(n,t){n.max=t,n.range=e.Timing.MicroSeconds(n.max-n.min)}function $(e){const n=W(),t=X(n,e);if(t)return`data:img/png;base64,${n[t].args.snapshot}`}function X(e,t){return n.ArrayUtilities.nearestIndexFromBeginning(e,(e=>e.ts>t))}var K=Object.freeze({__proto__:null,MAX_CLUSTER_DURATION:U,MAX_SHIFT_TIME_DELTA:N,initialize:function(){if(1!==V)throw new Error("LayoutShifts Handler was not reset");V=2},reset:function(){V=1,z.length=0,q.length=0,B.length=0,J.length=0,H=0,G.length=0,A=-1},handleEvent:function(n){if(2!==V)throw new Error("Handler is not initialized");!e.TraceEvents.isTraceEventLayoutShift(n)||n.args.data?.had_recent_input?e.TraceEvents.isTraceEventLayoutInvalidation(n)?q.push(n):(e.TraceEvents.isTraceEventStyleRecalcInvalidation(n)&&O.push(n),e.TraceEvents.isTraceEventPrePaint(n)&&B.push(n)):z.push(n)},findNextScreenshotEventIndex:X,finalize:async function(){z.sort(((e,n)=>e.ts-n.ts)),B.sort(((e,n)=>e.ts-n.ts)),q.sort(((e,n)=>e.ts-n.ts)),await async function(){const{navigationsByFrameId:t,mainFrameId:r,traceBounds:i}=S(),a=t.get(r)||[];if(0===z.length)return;let s=z[0].ts,o=z[0].ts,c=null;for(const t of z){const r=t.ts-s>U,i=t.ts-o>N,l=n.ArrayUtilities.nearestIndexFromEnd(a,(e=>e.ts<t.ts)),d=c!==l&&null!==l;if(r||i||d||!J.length){const n=t.ts,c=r?s+U:1/0,u=i?o+N:1/0,m=d?a[l].ts:1/0,g=Math.min(c,u,m);if(J.length>0){Y(J[J.length-1].clusterWindow,e.Timing.MicroSeconds(g))}J.push({events:[],clusterWindow:j(n),clusterCumulativeScore:0,scoreWindows:{good:j(n),needsImprovement:null,bad:null}}),s=n}const u=J[J.length-1],m=null!==l?e.Timing.MicroSeconds(t.ts-a[l].ts):void 0;u.clusterCumulativeScore+=t.args.data?t.args.data.weighted_score_delta:0;const g={...t,screenshotSource:$(t.ts),timeFromNavigation:m,cumulativeWeightedScoreInWindow:u.clusterCumulativeScore,sessionWindowData:{cumulativeWindowScore:0,id:J.length}};u.events.push(g),Y(u.clusterWindow,t.ts),o=t.ts,c=l}for(const t of J){let r=0,s=-1;if(t===J[J.length-1]){const r=U+t.clusterWindow.min,s=t.clusterWindow.max+N,o=n.ArrayUtilities.nearestIndexFromBeginning(a,(e=>e.ts>t.clusterWindow.max)),c=o?a[o].ts:1/0,l=Math.min(r,s,i.max,c);Y(t.clusterWindow,e.Timing.MicroSeconds(l))}for(const n of t.events)r+=n.args.data?n.args.data.weighted_score_delta:0,s=n.sessionWindowData.id,n.sessionWindowData.cumulativeWindowScore=t.clusterCumulativeScore,r<.1?Y(t.scoreWindows.good,n.ts):r>=.1&&r<.25?(t.scoreWindows.needsImprovement||(Y(t.scoreWindows.good,e.Timing.MicroSeconds(n.ts-1)),t.scoreWindows.needsImprovement=j(n.ts)),Y(t.scoreWindows.needsImprovement,n.ts)):r>=.25&&(t.scoreWindows.bad||(t.scoreWindows.needsImprovement?Y(t.scoreWindows.needsImprovement,e.Timing.MicroSeconds(n.ts-1)):Y(t.scoreWindows.good,e.Timing.MicroSeconds(n.ts-1)),t.scoreWindows.bad=j(n.ts)),Y(t.scoreWindows.bad,n.ts)),t.scoreWindows.bad?Y(t.scoreWindows.bad,t.clusterWindow.max):t.scoreWindows.needsImprovement?Y(t.scoreWindows.needsImprovement,t.clusterWindow.max):Y(t.scoreWindows.good,t.clusterWindow.max);r>H&&(A=s,H=r)}}(),function(){const{traceBounds:e}=S();G.push({ts:e.min,score:0});for(const e of J){let n=0;e.events[0].args.data&&G.push({ts:e.clusterWindow.min,score:e.events[0].args.data.weighted_score_delta});for(let t=0;t<e.events.length;t++){const r=e.events[t];r.args.data&&(n+=r.args.data.weighted_score_delta,G.push({ts:r.ts,score:n}))}G.push({ts:e.clusterWindow.max,score:0})}}(),V=3},data:function(){if(3!==V)throw new Error("Layout Shifts Handler is not finalized");return{clusters:[...J],sessionMaxScore:H,clsWindowID:A,prePaintEvents:[...B],layoutInvalidationEvents:[...q],styleRecalcInvalidationEvents:[],scoreRecords:[...G]}},deps:function(){return["Screenshots","Meta"]},stateForLayoutShiftScore:function(e){let n="good";return e>=.1&&(n="ok"),e>=.25&&(n="bad"),n}});const Q=new Map,Z=new Map,ee=[];function ne(e,n,t){Q.has(e)||Q.set(e,{});const r=Q.get(e);if(!r)throw new Error(`Unable to locate trace events for request ID ${e}`);if(Array.isArray(r[n])){const e=t;r[n].push(...e)}else r[n]=t}function te(e){for(const n of e)if(n>0)return n;return 0}let re=1;var ie=Object.freeze({__proto__:null,reset:function(){Z.clear(),Q.clear(),ee.length=0,re=2},handleEvent:function(n){if(2!==re)throw new Error("Network Request handler is not initialized");e.TraceEvents.isTraceEventResourceWillSendRequest(n)?ne(n.args.data.requestId,"willSendRequests",[n]):e.TraceEvents.isTraceEventResourceSendRequest(n)?ne(n.args.data.requestId,"sendRequests",[n]):e.TraceEvents.isTraceEventResourceReceiveResponse(n)?ne(n.args.data.requestId,"receiveResponse",n):e.TraceEvents.isTraceEventResourceReceivedData(n)?ne(n.args.data.requestId,"receivedData",[n]):e.TraceEvents.isTraceEventResourceFinish(n)&&ne(n.args.data.requestId,"resourceFinish",n)},finalize:async function(){if(2!==re)throw new Error("Network Request handler is not initialized");const{rendererProcessesByFrame:t}=S();for(const[r,i]of Q.entries()){if(!i.sendRequests||!i.receiveResponse)continue;const a=[];for(let n=0;n<i.sendRequests.length-1;n++){const t=i.sendRequests[n],r=i.sendRequests[n+1];let s=t.ts,o=e.Timing.MicroSeconds(r.ts-t.ts);if(i.willSendRequests&&i.willSendRequests[n]&&i.willSendRequests[n+1]){const t=i.willSendRequests[n],r=i.willSendRequests[n+1];s=t.ts,o=e.Timing.MicroSeconds(r.ts-t.ts)}a.push({url:t.args.data.url,priority:t.args.data.priority,ts:s,dur:o})}const s=i.sendRequests[0],o=i.sendRequests[i.sendRequests.length-1],{timing:c}=i.receiveResponse.args.data;if(!c)continue;const l=i.willSendRequests&&i.willSendRequests.length?e.Timing.MicroSeconds(i.willSendRequests[0].ts):e.Timing.MicroSeconds(s.ts),d=i.willSendRequests&&i.willSendRequests.length?e.Timing.MicroSeconds(i.willSendRequests[i.willSendRequests.length-1].ts):e.Timing.MicroSeconds(o.ts),u=i.resourceFinish?i.resourceFinish.ts:d,m=i.resourceFinish?e.Timing.MicroSeconds(1e6*i.resourceFinish.args.data.finishTime):e.Timing.MicroSeconds(u),g=e.Timing.MicroSeconds((m||d)-d),f=e.Timing.MicroSeconds(u-(m||u)),T=e.Timing.MicroSeconds(d-l),p=e.Timing.MicroSeconds(n.NumberUtilities.clamp(1e6*c.requestTime-d,0,Number.MAX_VALUE)),h=e.Timing.MicroSeconds(te([1e3*c.dnsStart,1e3*c.connectStart,1e3*c.sendStart,i.receiveResponse.ts-d])),v=e.Timing.MicroSeconds(1e3*(c.receiveHeadersEnd-c.sendEnd)),w=e.Timing.MicroSeconds(1e6*c.requestTime+1e3*c.receiveHeadersEnd),M=e.Timing.MicroSeconds((m||w)-w),E=e.Timing.MicroSeconds(g+f),S=e.Timing.MicroSeconds(1e3*(c.dnsEnd-c.dnsStart)),y=e.Timing.MicroSeconds(1e3*(c.sslEnd-c.sslStart)),I=e.Timing.MicroSeconds(1e3*(c.proxyEnd-c.proxyStart)),b=e.Timing.MicroSeconds(1e3*(c.sendEnd-c.sendStart)),C=e.Timing.MicroSeconds(1e3*(c.connectEnd-c.connectStart)),{priority:R,frame:P,url:D,renderBlocking:F}=o.args.data,{mimeType:k,fromCache:_,fromServiceWorker:L}=i.receiveResponse.args.data,{encodedDataLength:W,decodedBodyLength:x}=i.resourceFinish?i.resourceFinish.args.data:{encodedDataLength:0,decodedBodyLength:0},{receiveHeadersEnd:U,requestTime:N,sendEnd:z,sendStart:q,sslStart:O}=c,{host:B,protocol:H,pathname:A,search:J}=new URL(D),G="https:"===H,V=t.get(P)?.get(o.pid),j=V?V.frame.url:"",Y={args:{data:{decodedBodyLength:x,dnsLookup:S,download:M,encodedDataLength:W,finishTime:m,frame:P,fromCache:_,fromServiceWorker:L,initialConnection:C,host:B,isHttps:G,mimeType:k,networkDuration:g,pathname:A,search:J,priority:R,processingDuration:f,protocol:H,proxyNegotiation:I,redirectionDuration:T,queueing:p,receiveHeadersEnd:e.Timing.MicroSeconds(U),redirects:a,requestId:r,renderBlocking:F||"non_blocking",requestSent:b,requestTime:N,requestingFrameUrl:j,sendEnd:e.Timing.MicroSeconds(1e3*z),sendStart:e.Timing.MicroSeconds(1e3*q),ssl:y,sslStart:e.Timing.MicroSeconds(1e3*O),stalled:h,statusCode:i.receiveResponse.args.data.statusCode,stackTrace:o.args.data.stackTrace,totalTime:E,url:D,waiting:v}},cat:"loading",name:"SyntheticNetworkRequest",ph:"X",dur:e.Timing.MicroSeconds(u-l),tdur:e.Timing.MicroSeconds(u-l),ts:e.Timing.MicroSeconds(l),tts:e.Timing.MicroSeconds(l),pid:o.pid,tid:o.tid};if(Y.args.data.fromCache){Y.args.data.queueing=e.Timing.MicroSeconds(0),Y.args.data.waiting=e.Timing.MicroSeconds(0),Y.args.data.dnsLookup=e.Timing.MicroSeconds(0),Y.args.data.initialConnection=e.Timing.MicroSeconds(0),Y.args.data.ssl=e.Timing.MicroSeconds(0),Y.args.data.requestSent=e.Timing.MicroSeconds(0),Y.args.data.proxyNegotiation=e.Timing.MicroSeconds(0),Y.args.data.networkDuration=e.Timing.MicroSeconds(0);const n=i.receiveResponse?i.receiveResponse.ts:l;Y.args.data.stalled=e.Timing.MicroSeconds(n-l),Y.args.data.download=e.Timing.MicroSeconds(u-n)}const $=n.MapUtilities.getWithDefault(Z,B,(()=>({renderBlocking:[],nonRenderBlocking:[],all:[]})));"non_blocking"===Y.args.data.renderBlocking?$.nonRenderBlocking.push(Y):$.renderBlocking.push(Y),$.all.push(Y),ee.push(Y)}re=3},data:function(){if(3!==re)throw new Error("Network Request handler is not finalized");return{byOrigin:new Map(Z),byTime:[...ee]}},deps:function(){return["Meta"]}});const ae=new Map([["Program",{category:"Other",label:"Other"}],["RunTask",{category:"Other",label:"Run Task"}],["AsyncTask",{category:"Other",label:"Async Task"}],["XHRLoad",{category:"Load",label:"Load"}],["XHRReadyStateChange",{category:"Load",label:"ReadyStateChange"}],["ParseHTML",{category:"Parse",label:"Parse HTML"}],["ParseAuthorStyleSheet",{category:"Parse",label:"Parse StyleSheet"}],["V8.CompileScript",{category:"V8",label:"Compile Script"}],["V8.CompileCode",{category:"V8",label:"Compile Code"}],["V8.CompileModule",{category:"V8",label:"Compile Module"}],["V8.OptimizeCode",{category:"V8",label:"Optimize"}],["v8.wasm.streamFromResponseCallback",{category:"Js",label:"Streaming Wasm Response"}],["v8.wasm.compiledModule",{category:"Js",label:"Compiled Wasm Module"}],["v8.wasm.cachedModule",{category:"Js",label:"Cached Wasm Module"}],["v8.wasm.moduleCacheHit",{category:"Js",label:"Wasm Module Cache Hit"}],["v8.wasm.moduleCacheInvalid",{category:"Js",label:"Wasm Module Cache Invalid"}],["RunMicrotasks",{category:"Js",label:"Run Microtasks"}],["EvaluateScript",{category:"Js",label:"Evaluate Script"}],["FunctionCall",{category:"Js",label:"Function Call"}],["EventDispatch",{category:"Js",label:"Event"}],["RequestMainThreadFrame",{category:"Js",label:"Request Main Thread Frame"}],["RequestAnimationFrame",{category:"Js",label:"Request Animation Frame"}],["CancelAnimationFrame",{category:"Js",label:"Cancel Animation Frame"}],["FireAnimationFrame",{category:"Js",label:"Animation Frame"}],["RequestIdleCallback",{category:"Js",label:"Request Idle Callback"}],["CancelIdleCallback",{category:"Js",label:"Cancel Idle Callback"}],["FireIdleCallback",{category:"Js",label:"Idle Callback"}],["TimerInstall",{category:"Js",label:"Timer Installed"}],["TimerRemove",{category:"Js",label:"Timer Removed"}],["TimerFire",{category:"Js",label:"Timer Fired"}],["WebSocketCreate",{category:"Js",label:"Create WebSocket"}],["WebSocketSendHandshakeRequest",{category:"Js",label:"Send WebSocket Handshake"}],["WebSocketReceiveHandshakeResponse",{category:"Js",label:"Receive WebSocket Handshake"}],["WebSocketDestroy",{category:"Js",label:"Destroy WebSocket"}],["DoEncrypt",{category:"Js",label:"Crypto Encrypt"}],["DoEncryptReply",{category:"Js",label:"Crypto Encrypt Reply"}],["DoDecrypt",{category:"Js",label:"Crypto Decrypt"}],["DoDecryptReply",{category:"Js",label:"Crypto Decrypt Reply"}],["DoDigest",{category:"Js",label:"Crypto Digest"}],["DoDigestReply",{category:"Js",label:"Crypto Digest Reply"}],["DoSign",{category:"Js",label:"Crypto Sign"}],["DoSignReply",{category:"Js",label:"Crypto Sign Reply"}],["DoVerify",{category:"Js",label:"Crypto Verify"}],["DoVerifyReply",{category:"Js",label:"Crypto Verify Reply"}],["GCEvent",{category:"Gc",label:"GC"}],["BlinkGC.AtomicPhase",{category:"Gc",label:"DOM GC"}],["V8.GCIncrementalMarking",{category:"Gc",label:"Incremental GC"}],["MajorGC",{category:"Gc",label:"Major GC"}],["MinorGC",{category:"Gc",label:"Minor GC"}],["ScheduleStyleRecalculation",{category:"Layout",label:"Schedule Recalculate Style"}],["RecalculateStyles",{category:"Layout",label:"Recalculate Style"}],["Layout",{category:"Layout",label:"Layout"}],["UpdateLayoutTree",{category:"Layout",label:"Recalculate Style"}],["InvalidateLayout",{category:"Layout",label:"Invalidate Layout"}],["LayoutInvalidationTracking",{category:"Layout",label:"Layout Invalidation"}],["ComputeIntersections",{category:"Paint",label:"Compute Intersections"}],["HitTest",{category:"Layout",label:"Hit Test"}],["PrePaint",{category:"Layout",label:"Pre-Paint"}],["ScrollLayer",{category:"Paint",label:"Scroll"}],["UpdateLayer",{category:"Paint",label:"Update Layer"}],["PaintSetup",{category:"Paint",label:"Paint Setup"}],["Paint",{category:"Paint",label:"Paint"}],["PaintImage",{category:"Paint",label:"Paint Image"}],["Commit",{category:"Paint",label:"Commit"}],["CompositeLayers",{category:"Paint",label:"Composite Layers"}],["RasterTask",{category:"Paint",label:"Raster"}],["ImageDecodeTask",{category:"Paint",label:"Decode Image Task"}],["ImageUploadTask",{category:"Paint",label:"Upload Image Task"}],["Decode Image",{category:"Paint",label:"Decode Image"}],["Resize Image",{category:"Paint",label:"Resize Image"}],["Draw LazyPixelRef",{category:"Paint",label:"Draw LazyPixelRef"}],["Decode LazyPixelRef",{category:"Paint",label:"Decode LazyPixelRef"}],["GPUTask",{category:"Paint",label:"GPU Task"}]]);var se=Object.freeze({__proto__:null,KNOWN_EVENTS:ae});function oe(e){e.sort(((e,n)=>{const t=e.ts,r=n.ts;return t<r?-1:t>r?1:0}))}const ce=new Set(["Other","V8","Js","Gc"]),le=new Set([void 0,"JS"]),de=[/^chrome-extension:\/\//,/^extensions::/],ue=e.Timing.MicroSeconds(200),me=new Map,ge=new Map,fe=new Map;let Te=1;const pe=()=>({threads:new Map}),he=e=>({callFrame:e,parentId:null,childrenIds:new Set}),ve=(e,n,t,r)=>({topmostStackFrame:{nodeId:e},tid:t,pid:n,ts:r}),we=(e,t)=>n.MapUtilities.getWithDefault(e,t,pe),Me=(e,t,r)=>n.MapUtilities.getWithDefault(e.threads,t,(()=>(e=>({profile:e}))(r)));function Ee(){if(3!==Te)throw new Error("Samples Handler is not finalized");return{profiles:new Map(ge),processes:new Map(fe)}}function Se(e,n){for(const[,t]of e){const{head:e,chunks:r}=t;if(!e||!r?.length)continue;const i=e.pid,a=e.tid;Me(we(n,i),a,t)}}function ye(e,n){for(const[r,i]of e)for(const[e,a]of i.threads){t.Trace.sortTraceEventsInPlace(a.profile.chunks);const i={filter:ce},s=a.boundaries=Ie(n,r,e,i),o=a.tree=be(a.profile.chunks),{startTime:c}=a.profile.head.args.data,l={filterCodeTypes:!0,filterUrls:!0},d=Re((a.samples=Ce(r,e,c,o,a.profile.chunks,l)).map((e=>_e(o,e))),s);a.calls=d.calls,a.dur=d.dur}}function Ie(n,t,r,i){const a=n.get(t);if(!a)return[];const s=a.get(r);if(!s)return[];const o=new Set;for(const n of s){const t=ae.get(n.name)?.category??"Other";i.filter.has(t)&&(o.add(n.ts),o.add(e.Timing.MicroSeconds(n.ts+n.dur)))}return[...o].sort(((e,n)=>e<n?-1:1))}function be(e,t){const r={nodes:new Map};for(const i of e){const e=i.args.data.cpuProfile;if(!e)continue;const a=e.nodes;if(a)for(const e of a){const i=e.id,a=e.parent,s=e.callFrame;if(!Pe(s,t))continue;const o=n.MapUtilities.getWithDefault(r.nodes,i,(()=>he(s)));void 0!==a&&(o.parentId=a,r.nodes.get(a)?.childrenIds.add(i))}}return r}function Ce(n,t,r,i,a,s){const o=[];for(const c of a){const{timeDeltas:a,cpuProfile:l}=c.args.data;if(a&&l)for(let c=0;c<a.length;c++){const d=a[c],u=l.samples[c];r=e.Timing.MicroSeconds(r+d);const m=De(u,i,s);null!==m&&o.push(ve(m,n,t,r))}}return oe(o),o}function Re(t,r){const i={calls:new Array,dur:e.Timing.MicroSeconds(0)};let a=0;for(const s of t){if(s.ts>=a){a=r[n.ArrayUtilities.nearestIndexFromBeginning(r,(e=>e>s.ts))??1/0],i.calls.push(s);continue}const t=i.calls[i.calls.length-1],o=s.stackFrame.nodeId===t.stackFrame.nodeId,c=s.ts-(t.ts+t.dur)<ue;o&&c?(t.dur=e.Timing.MicroSeconds(s.ts-t.ts),t.children.push(...s.children)):i.calls.push(s)}for(const n of i.calls){const t=Re(n.children,r);n.children=t.calls,n.selfDur=e.Timing.MicroSeconds(n.dur-t.dur),i.dur=e.Timing.MicroSeconds(i.dur+n.dur)}return i}function Pe(e,n){return!(n?.filterCodeTypes&&!le.has(e.codeType))&&(!n?.filterUrls||!de.some((n=>e.url?.match(n))))}function De(e,n,t){if(null===e)return null;const r=n.nodes.get(e),i=r?.callFrame;return r&&i?Pe(i,t)?e:De(r.parentId,n,t):null}function Fe(e,n){const t=[];let r,i=n;for(;null!==i&&(r=e.nodes.get(i));)t.push(i),i=r.parentId;return t.reverse()}function ke(e,n){return Fe(e,n).map((n=>{const t=e.nodes.get(n)?.callFrame;if(!t)throw new Error;return t}))}function _e(n,t){const r=Fe(n,t.topmostStackFrame.nodeId).map((n=>((n,t)=>({stackFrame:{nodeId:n},tid:t.tid,pid:t.pid,ts:t.ts,dur:e.Timing.MicroSeconds(0),selfDur:e.Timing.MicroSeconds(0),children:[]}))(n,t)));for(let e=1;e<r.length;e++){const n=r[e-1],t=r[e];n.children.push(t)}return r[0]}function Le(e,t,r,i=new Map){for(const a of e){if(a.ts<t||a.ts+a.dur>r)continue;const e=n.MapUtilities.getWithDefault(i,a.stackFrame.nodeId,(()=>({stackFrame:{nodeId:a.stackFrame.nodeId},calls:[],durPercent:0,selfDurPercent:0})));e.calls.push(a),e.durPercent+=a.dur/(r-t)*100,e.selfDurPercent+=a.selfDur/(r-t)*100,Le(a.children,t,r,i)}return i.values()}function We(e,n,t,r){return[...Le(e,n,t)].filter((e=>e.selfDurPercent>=r)).sort(((e,n)=>e.selfDurPercent>n.selfDurPercent?-1:1))}var xe=Object.freeze({__proto__:null,sortProfileSamples:oe,reset:function(){me.clear(),ge.clear(),fe.clear(),Te=1},initialize:function(){if(1!==Te)throw new Error("Samples Handler was not reset");Te=2},handleEvent:function(t){if(2!==Te)throw new Error("Samples Handler is not initialized");if(e.TraceEvents.isTraceEventProfile(t)){n.MapUtilities.getWithDefault(ge,t.id,(()=>({}))).head=t}else{if(e.TraceEvents.isTraceEventProfileChunk(t)){const e=n.MapUtilities.getWithDefault(ge,t.id,(()=>({})));return e.chunks=e.chunks??[],void e.chunks.push(t)}if(e.TraceEvents.isTraceEventComplete(t)){const e=n.MapUtilities.getWithDefault(me,t.pid,(()=>new Map));n.MapUtilities.getWithDefault(e,t.tid,(()=>[])).push(t)}else;}},finalize:async function(){if(2!==Te)throw new Error("Samples Handler is not initialized");Se(ge,fe),ye(fe,me),Te=3},data:Ee,buildProcessesAndThreads:Se,buildHierarchy:ye,collectBoundaries:Ie,collectStackTraces:be,collectSamples:Ce,mergeCalls:Re,isAllowedCallFrame:Pe,findTopmostAllowedCallFrame:De,buildStackTraceAsCallFrameIdsFromId:Fe,buildStackTraceAsCallFramesFromId:ke,buildProfileCallFromSample:_e,getAllFunctionsBetweenTimestamps:Le,getAllHotFunctionsBetweenTimestamps:We});const Ue=new Map,Ne=new Map,ze=[];let qe=1;const Oe=()=>({url:null,isOnMainFrame:!1,threads:new Map}),Be=()=>({name:null,events:[]}),He=e=>({eventIndex:e,parentId:null,childrenIds:new Set,depth:0}),Ae=(e,t)=>n.MapUtilities.getWithDefault(e,t,Oe),Je=(e,t)=>n.MapUtilities.getWithDefault(e.threads,t,Be);function Ge(){if(3!==qe)throw new Error("Renderer Handler is not finalized");return{processes:new Map(Ue),traceEventToNode:new Map(Ne),allRendererEvents:[...ze]}}function Ve(e,n,t,r){je(e,n,t),Ye(e,n,t),$e(e,t,r)}function je(e,n,t){for(const[r,i]of t)for(const[t,a]of i){const i=Ae(e,t);if(null===i.url||r===n)try{new URL(a.frame.url),i.url=a.frame.url}catch(e){i.url=null}}}function Ye(e,n,t){for(const[r,i]of t)for(const[t]of i){const i=Ae(e,t);r===n&&(i.isOnMainFrame=!0)}}function $e(e,n,t){for(const[,r]of n)for(const[n]of r){const r=Ae(e,n);for(const[e,i]of t.get(n)??[]){Je(r,e).name=i?.args.name??`${e}`}}}function Xe(e){for(const[n,t]of e){if(null===t.url){e.delete(n);continue}"about:"===new URL(t.url).protocol&&e.delete(n)}}function Ke(e){for(const[,n]of e)for(const[e,t]of n.threads)t.tree?.roots.size||n.threads.delete(e)}function Qe(e,n){for(const[,r]of e)for(const[,e]of r.threads)t.Trace.sortTraceEventsInPlace(e.events),e.tree=Ze(e.events,n)}function Ze(n,t){const r=[],i={nodes:new Map,roots:new Set,maxDepth:0},a=(()=>{let e=0;return()=>e++})();let s=null,o=null,c=null;for(let l=0;l<n.length;l++){const d=n[l];if(tn(d),"ScheduleStyleRecalculation"===d.name&&(s=d),"InvalidateLayout"===d.name&&(o=d),"RecalculateStyles"===d.name&&(c=d),!t.filter.has(d.name))continue;const u=e.TraceEvents.isTraceEventInstant(d)?0:d.dur;if(0===r.length){const n=He(l),t=a();i.nodes.set(t,n),i.roots.add(t),d.totalTime=e.Timing.MicroSeconds(u),d.selfTime=e.Timing.MicroSeconds(u),r.push(t),i.maxDepth=Math.max(i.maxDepth,r.length),Ne.set(d,n);continue}const m=r[r.length-1];if(void 0===m)throw new Error("Impossible: no parent node id found in the stack");const g=i.nodes.get(m);if(!g)throw new Error("Impossible: no parent node exists for the given id");const f=n[g.eventIndex];if(!f)throw new Error("Impossible: no parent event exists for the given node");const T=d.ts,p=f.ts,h=T+u,v=p+(e.TraceEvents.isTraceEventInstant(f)?0:f.dur);if(T<p)throw new Error("Impossible: current event starts before the parent event");if(T>=v){r.pop(),l--;continue}if(h>v)throw new Error("Impossible: current event starts during the parent event");const w=He(l),M=a();i.nodes.set(M,w),w.depth=r.length,w.parentId=m,g.childrenIds.add(M),d.selfTime=e.Timing.MicroSeconds(u),d.totalTime=e.Timing.MicroSeconds(u),void 0!==f.selfTime&&(f.selfTime=e.Timing.MicroSeconds(f.selfTime-d.totalTime)),r.push(M),i.maxDepth=Math.max(i.maxDepth,r.length),Ne.set(d,w),en(d,s,o,c)}return i}function en(e,n,t,r){if(rn.has(e.name)){t&&(e.initiator=t);const i=r&&r.ts+(r.dur||0);n&&t&&i&&i>t.ts&&(e.initiator=n)}an.has(e.name)&&(r=e,n&&(e.initiator=n))}function nn(n,r){if("RunTask"!==n.name)return!1;const i=Ue.get(n.pid);if(!Boolean(i&&i.isOnMainFrame)&&r)return!1;const a=t.Timing.millisecondsToMicroseconds(e.Timing.MilliSeconds(50));return(e.TraceEvents.isTraceEventInstant(n)?0:n.dur)>a}function tn(n){if(!nn(n,!0))return;const{processes:t}=Ee(),r=t.get(n.pid)?.threads.get(n.tid),i=r?.calls,a=n.ts,s=e.Timing.MicroSeconds(n.ts+(n.dur||0)),o=i&&We(i,a,s,0),c=r?.tree;if(!o||!c)return;n.hotFunctionsStackTraces=o.slice(0,10).map((e=>ke(c,e.stackFrame.nodeId).reverse()))}const rn=new Set(["Layout"]),an=new Set(["RecalculateStyles","UpdateLayoutTree"]);var sn=Object.freeze({__proto__:null,reset:function(){Ue.clear(),Ne.clear(),ze.length=0,qe=1},initialize:function(){if(1!==qe)throw new Error("Renderer Handler was not reset");qe=2},handleEvent:function(n){if(2!==qe)throw new Error("Renderer Handler is not initialized");if(e.TraceEvents.isTraceEventInstant(n)||e.TraceEvents.isTraceEventComplete(n)){const e=Ae(Ue,n.pid);Je(e,n.tid).events.push(n),ze.push(n)}},finalize:async function(){if(2!==qe)throw new Error("Renderer Handler is not initialized");const{mainFrameId:e,rendererProcessesByFrame:n,threadsInProcess:t}=S();Ve(Ue,e,n,t),Xe(Ue),Qe(Ue,{filter:ae}),Ke(Ue),qe=3},data:Ge,assignMeta:Ve,assignOrigin:je,assignIsMainFrame:Ye,assignThreadName:$e,sanitizeProcesses:Xe,sanitizeThreads:Ke,buildHierarchy:Qe,treify:Ze,buildHotFunctionsStackTracesForTask:tn,FORCED_LAYOUT_EVENT_NAMES:rn,FORCED_RECALC_STYLE_EVENTS:an,deps:function(){return["Meta","Samples"]}});const on=new Map;let cn=[];const ln=new Set;function dn(r,i){const a=r.args.data?.navigationId;if(!a)throw new Error("Navigation event unexpectedly had no navigation ID.");const s=mn(i),{rendererProcessesByFrame:o}=S(),c=o.get(s)?.get(i.pid);if(!c)throw new Error("No processes found for page load event.");if(i.ts>=c.window.min&&i.ts<=c.window.max)if(e.TraceEvents.isTraceEventFirstContentfulPaint(i)){const n=e.Timing.MicroSeconds(i.ts-r.ts);un(s,a,{event:i,score:t.Timing.formatMicrosecondsTime(n,{format:2,maximumFractionDigits:2}),metricName:"FCP",classification:fn(n),navigation:r})}else if(e.TraceEvents.isTraceEventMarkDOMContent(i)){const n=e.Timing.MicroSeconds(i.ts-r.ts);un(s,a,{event:i,score:t.Timing.formatMicrosecondsTime(n,{format:2,maximumFractionDigits:2}),metricName:"DCL",classification:"unclassified",navigation:r})}else if(e.TraceEvents.isTraceEventInteractiveTime(i)){const n=e.Timing.MicroSeconds(i.ts-r.ts);un(s,a,{event:i,score:t.Timing.formatMicrosecondsTime(n,{format:2,maximumFractionDigits:2}),metricName:"TTI",classification:Tn(n),navigation:r});const o=t.Timing.millisecondsToMicroseconds(e.Timing.MilliSeconds(i.args.args.total_blocking_time_ms));un(s,a,{event:i,score:t.Timing.formatMicrosecondsTime(o,{format:1,maximumFractionDigits:2}),metricName:"TBT",classification:vn(o),navigation:r})}else if(e.TraceEvents.isTraceEventLargestContentfulPaintCandidate(i)){const o=i.args.data?.candidateIndex;if(!o)throw new Error("Largest Contenful Paint unexpectedly had no candidateIndex.");const c=e.Timing.MicroSeconds(i.ts-r.ts),l={event:i,score:t.Timing.formatMicrosecondsTime(c,{format:2,maximumFractionDigits:2}),metricName:"LCP",classification:pn(c),navigation:r},d=n.MapUtilities.getWithDefault(on,s,(()=>new Map)),u=n.MapUtilities.getWithDefault(d,a,(()=>new Map)).get("LCP");if(void 0===u)return ln.add(l.event),void un(s,a,l);const m=u.event;if(!e.TraceEvents.isTraceEventLargestContentfulPaintCandidate(m))return;const g=m.args.data?.candidateIndex;if(!g)return;g<o&&(ln.delete(m),ln.add(l.event),un(s,a,l))}else if(!e.TraceEvents.isTraceEventLayoutShift(i))return n.assertNever(i,`Unexpected event type: ${i}`)}function un(e,t,r){const i=n.MapUtilities.getWithDefault(on,e,(()=>new Map)),a=n.MapUtilities.getWithDefault(i,t,(()=>new Map));a.delete(r.metricName),a.set(r.metricName,r)}function mn(t){if(e.TraceEvents.isTraceEventFirstContentfulPaint(t)||e.TraceEvents.isTraceEventInteractiveTime(t)||e.TraceEvents.isTraceEventLargestContentfulPaintCandidate(t)||e.TraceEvents.isTraceEventLayoutShift(t))return t.args.frame;if(e.TraceEvents.isTraceEventMarkDOMContent(t)){const e=t.args.data?.frame;if(!e)throw new Error("MarkDOMContent unexpectedly had no frame ID.");return e}n.assertNever(t,`Unexpected event type: ${t}`)}function gn(r){if(e.TraceEvents.isTraceEventFirstContentfulPaint(r)||e.TraceEvents.isTraceEventLargestContentfulPaintCandidate(r)){const e=r.args.data?.navigationId;if(!e)throw new Error("Trace event unexpectedly had no navigation ID.");const{navigationsByNavigationId:n}=S(),t=n.get(e);return t||null}if(e.TraceEvents.isTraceEventMarkDOMContent(r)||e.TraceEvents.isTraceEventInteractiveTime(r)||e.TraceEvents.isTraceEventLayoutShift(r)){const e=mn(r),{navigationsByFrameId:n}=S();return t.Trace.getNavigationForTraceEvent(r,e,n)}return n.assertNever(r,`Unexpected event type: ${r}`)}function fn(n){const r=t.Timing.secondsToMicroseconds(e.Timing.Seconds(1.8));let i="bad";return n<=t.Timing.secondsToMicroseconds(e.Timing.Seconds(3))&&(i="ok"),n<=r&&(i="good"),i}function Tn(n){const r=t.Timing.secondsToMicroseconds(e.Timing.Seconds(3.8));let i="bad";return n<=t.Timing.secondsToMicroseconds(e.Timing.Seconds(7.3))&&(i="ok"),n<=r&&(i="good"),i}function pn(n){const r=t.Timing.secondsToMicroseconds(e.Timing.Seconds(2.5));let i="bad";return n<=t.Timing.secondsToMicroseconds(e.Timing.Seconds(4))&&(i="ok"),n<=r&&(i="good"),i}function hn(e){return"unclassified"}function vn(n){const r=t.Timing.millisecondsToMicroseconds(e.Timing.MilliSeconds(200));let i="bad";return n<=t.Timing.millisecondsToMicroseconds(e.Timing.MilliSeconds(600))&&(i="ok"),n<=r&&(i="good"),i}var wn=Object.freeze({__proto__:null,reset:function(){on.clear(),cn=[],ln.clear()},handleEvent:function(n){(function(n){return e.TraceEvents.isTraceEventFirstContentfulPaint(n)||e.TraceEvents.isTraceEventMarkDOMContent(n)||e.TraceEvents.isTraceEventInteractiveTime(n)||e.TraceEvents.isTraceEventLargestContentfulPaintCandidate(n)})(n)&&cn.push(n)},getFirstFCPTimestampFromModelData:function(e){const n=e.Meta.mainFrameId,t=e.PageLoadMetrics.metricScoresByFrameId.get(n);if(!t)return null;let r=null;for(const e of t.values()){const n=e.get("FCP")?.event?.ts;n&&(r?n<r&&(r=n):r=n)}return r},scoreClassificationForFirstContentfulPaint:fn,scoreClassificationForTimeToInteractive:Tn,scoreClassificationForLargestContentfulPaint:pn,scoreClassificationForDOMContentLoaded:hn,scoreClassificationForTotalBlockingTime:vn,finalize:async function(){cn.sort(((e,n)=>e.ts-n.ts));for(const e of cn){const n=gn(e);n&&dn(n,e)}!function(){const{processes:n}=Ge(),r=t.Timing.millisecondsToMicroseconds(e.Timing.MilliSeconds(50));for(const[i,a]of on)for(const[s,o]of a){const a=o.get("TBT"),c=o.get("FCP");if(a||!c)continue;if(!c.event)continue;const l=n.get(c.event.pid);if(!l)continue;const d=[...l.threads.values()].find((e=>"CrRendererMain"===e.name)),u=d?.tree;if(!d||!u)throw new Error("Main thread not found.");const m=d.events,g=u.nodes,f=c.event.ts;let T=0;for(const n of u.roots){const t=g.get(n);if(void 0===t)throw new Error(`Node not found for id: ${n}`);if(void 0===m[t.eventIndex])throw new Error(`Event not found for index: ${t.eventIndex}`);const i=m[t.eventIndex];if("RunTask"!==i.name||e.TraceEvents.isTraceEventInstant(i))continue;if(i.ts+i.dur<f)continue;const a=i.ts<f?f-i.ts:0,s=i.dur-a;T+=s>r?s-r:0}const p=e.Timing.MicroSeconds(T);un(i,s,{score:t.Timing.formatMicrosecondsTime(p,{format:1,maximumFractionDigits:2}),estimated:!0,metricName:"TBT",classification:vn(p),navigation:c.navigation})}}()},data:function(){return{metricScoresByFrameId:new Map(on)}},deps:function(){return["Meta","Renderer"]}});const Mn=[],En=[];let Sn=1;var yn=Object.freeze({__proto__:null,reset:function(){Mn.length=0,En.length=0,Sn=2},handleEvent:function(n){if(2!==Sn)throw new Error("Handler is not initialized");if(!e.TraceEvents.isTraceEventEventTiming(n))return;if(Mn.push(n),!n.args.data)return;const{duration:r,interactionId:i}=n.args.data;if(r<1||void 0===i||0===i)return;const a={...n,interactionId:i,dur:t.Timing.millisecondsToMicroseconds(r)};En.push(a)},finalize:async function(){Sn=3},data:function(){return{allEvents:[...Mn],interactionEvents:[...En]}}});const In=[],bn=[];let Cn=1;var Rn=Object.freeze({__proto__:null,reset:function(){In.length=0,bn.length=0,Cn=2},handleEvent:function(n){if(2!==Cn)throw new Error("UserTimings handler is not initialized");e.TraceEvents.isTraceEventUserTimingsBeginOrEnd(n)&&bn.push(n)},finalize:async function(){if(2!==Cn)throw new Error("UserTimings handler is not initialized");const t=new Map;for(const e of bn){const r=n.MapUtilities.getWithDefault(t,e.id,(()=>({begin:null,end:null}))),i="b"===e.ph,a="e"===e.ph;i?r.begin=e:a&&(r.end=e)}for(const[n,r]of t.entries()){if(!r.begin||!r.end)continue;const t={cat:r.end.cat,ph:r.end.ph,pid:r.end.pid,tid:r.end.tid,id:n,name:r.begin.name,dur:e.Timing.MicroSeconds(r.end.ts-r.begin.ts),ts:r.begin.ts,args:{data:{beginEvent:r.begin,endEvent:r.end}}};In.push(t)}In.sort(((e,n)=>e.ts>n.ts?1:n.ts>e.ts?-1:0)),Cn=3},data:function(){if(3!==Cn)throw new Error("UserTimings handler is not finalized");return{timings:[...In]}}}),Pn=Object.freeze({__proto__:null,Animation:i,GPU:R,LargestImagePaint:D,LargestTextPaint:k,LayoutShifts:K,Meta:y,NetworkRequests:ie,PageLoadMetrics:wn,Renderer:sn,Samples:xe,Screenshots:x,UserInteractions:yn,UserTimings:Rn});export{Pn as ModelHandlers,se as Types};
